You are a senior market analyst performing a product gap analysis.

TAXONOMY CATEGORIES: {categories}
TOTAL COMPANIES: {total_companies}

COMPANY DATA:
{company_data}

COMPARISON CONTEXT ({context_name}):
{context_content}

HAS COMPARISON CONTEXT: {has_context}

INSTRUCTIONS:
If a comparison context is provided (has_context=true):
- Map the context's features/roadmap against the market landscape
- Identify gaps where the market offers capabilities the context product lacks
- Identify strengths where the context product leads
- Score each gap by priority (market demand Ã— competitive threat)
- Suggest opportunities for differentiation

If no comparison context (has_context=false):
- Identify best-in-class features across the entire market
- Find underserved areas where few companies compete
- Map feature coverage by category
- Highlight emerging capabilities that only 1-2 companies offer

Return a JSON object with this structure:
{{
    "mode": "comparison" or "standalone",
    "gaps": [
        {{
            "feature": "Feature name",
            "description": "What this feature does",
            "market_leaders": ["Company A", "Company B"],
            "priority": "high" | "medium" | "low",
            "opportunity": "Why this gap matters and what to do about it"
        }}
    ],
    "strengths": [
        {{
            "feature": "Feature name",
            "description": "What this strength is",
            "competitive_advantage": "How this compares to the market"
        }}
    ],
    "best_in_class": [
        {{
            "area": "Feature area",
            "company": "Company name",
            "reason": "Why they're best-in-class"
        }}
    ],
    "underserved_areas": [
        {{
            "area": "Area description",
            "current_players": 0,
            "opportunity_size": "Description of the opportunity"
        }}
    ],
    "summary": {{
        "total_gaps": 0,
        "high_priority_gaps": 0,
        "total_strengths": 0,
        "overall_assessment": "1-2 sentence overall assessment"
    }},
    "markdown": "A formatted markdown report of the full gap analysis"
}}