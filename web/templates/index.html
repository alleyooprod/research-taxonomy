<!DOCTYPE html>
{% macro model_select(id, default='haiku', include_gemini=true) -%}
<select id="{{ id }}" class="model-select-inline">
    <option value="claude-haiku-4-5-20251001" {{ 'selected' if default == 'haiku' }}>Haiku</option>
    <option value="claude-sonnet-4-5-20250929" {{ 'selected' if default == 'sonnet' }}>Sonnet</option>
    <option value="claude-opus-4-6" {{ 'selected' if default == 'opus' }}>Opus</option>
    {% if include_gemini -%}
    <option disabled>──────────</option>
    <option value="gemini-2.0-flash">Gemini Flash</option>
    <option value="gemini-2.5-pro">Gemini Pro</option>
    {%- endif %}
</select>
{%- endmacro %}
<html lang="en" data-theme="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>Research Taxonomy Library</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Newsreader:ital,opsz,wght@0,6..72,200..800;1,6..72,200..800&family=Noto+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
    <!-- Tabulator CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tabulator-tables@6.3.1/dist/css/tabulator_midnight.min.css">
    <!-- Tippy.js CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tippy.js@6.3.7/dist/tippy.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tippy.js@6.3.7/themes/light-border.css">
    <!-- Notyf CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/notyf@3.10.0/notyf.min.css">
    <!-- Driver.js CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/driver.js@1.3.1/dist/driver.css">
    <!-- Tagify CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@yaireo/tagify@4.31.3/dist/tagify.css">
    <!-- Highlight.js code syntax theme -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.10.0/styles/github.min.css">
    <!-- Flatpickr date picker CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.css">
    <!-- NProgress progress bar CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.css">
    <!-- Diff2html diff viewer CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/diff2html@3.4.56/bundles/css/diff2html.min.css">

    <!-- Existing libraries -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@15.0.4/marked.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js" defer></script>

    <!-- Data Visualization -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.1/dist/echarts.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js" defer></script>
    <!-- ECharts Word Cloud extension -->
    <script src="https://cdn.jsdelivr.net/npm/echarts-wordcloud@2.1.0/dist/echarts-wordcloud.min.js" defer></script>
    <!-- Network/Graph -->
    <script src="https://cdn.jsdelivr.net/npm/cytoscape@3.30.4/dist/cytoscape.min.js" defer></script>
    <!-- Canvas drawing engine -->
    <script src="https://cdn.jsdelivr.net/npm/fabric@6.5.1/dist/index.min.js" defer></script>
    <!-- Canvas layout engines & sketch style -->
    <script src="https://cdn.jsdelivr.net/npm/@dagrejs/dagre@1.1.4/dist/dagre.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/roughjs@4.6.6/bundled/rough.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/elkjs@0.9.3/lib/elk.bundled.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/leader-line-new@1.1.9/leader-line.min.js" defer></script>
    <!-- Geographic Maps -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js" defer></script>
    <!-- Data Table -->
    <script src="https://cdn.jsdelivr.net/npm/tabulator-tables@6.3.1/dist/js/tabulator.min.js" defer></script>
    <!-- Drag and Drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.6/Sortable.min.js" defer></script>
    <!-- Search -->
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0/dist/fuse.min.js" defer></script>
    <!-- PDF Generation -->
    <script src="https://cdn.jsdelivr.net/npm/pdfmake@0.2.18/build/pdfmake.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/pdfmake@0.2.18/build/vfs_fonts.js" defer></script>
    <!-- Excel Export -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" defer></script>
    <!-- File Download -->
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js" defer></script>
    <!-- Security -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.2.4/dist/purify.min.js" defer></script>
    <!-- Date Formatting -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.13/dayjs.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.13/plugin/relativeTime.js" defer></script>
    <!-- Tooltips -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/tippy.js@6.3.7/dist/tippy-bundle.umd.min.js" defer></script>
    <!-- Notifications -->
    <script src="https://cdn.jsdelivr.net/npm/notyf@3.10.0/notyf.min.js" defer></script>
    <!-- Product Tour -->
    <script src="https://cdn.jsdelivr.net/npm/driver.js@1.3.1/dist/driver.js.iife.js" defer></script>
    <!-- Tags -->
    <script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify@4.31.3/dist/tagify.min.js" defer></script>
    <!-- Animation -->
    <script src="https://cdn.jsdelivr.net/npm/motion@11.16.0/dist/motion.js" defer></script>
    <!-- Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js" defer></script>
    <!-- Keyboard Shortcuts -->
    <script src="https://cdn.jsdelivr.net/npm/hotkeys-js@3.13.9/dist/hotkeys.min.js" defer></script>
    <!-- Code Syntax Highlighting (browser build — no require()) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/highlight.min.js" defer></script>
    <!-- Geographic Heatmap -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet.heat@0.2.0/dist/leaflet-heat.js" defer></script>
    <!-- Auto-expanding Textareas -->
    <script src="https://cdn.jsdelivr.net/npm/autosize@6.0.1/dist/autosize.min.js" defer></script>
    <!-- Click-to-Zoom Images -->
    <script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" defer></script>
    <!-- Date Range Picker -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js" defer></script>
    <!-- NProgress slim progress bar -->
    <script src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.js" defer></script>
    <!-- Diff2html rich diff viewer -->
    <script src="https://cdn.jsdelivr.net/npm/diff2html@3.4.56/bundles/js/diff2html.min.js" defer></script>
    <!-- Split.js resizable panes -->
    <script src="https://cdn.jsdelivr.net/npm/split.js@1.6.5/dist/split.min.js" defer></script>
    <!-- Currency formatting -->
    <script src="https://cdn.jsdelivr.net/npm/currency.js@2.0.4/dist/currency.min.js" defer></script>
    <!-- Search result highlighting -->
    <script src="https://cdn.jsdelivr.net/npm/mark.js@8.11.1/dist/mark.min.js" defer></script>
    <!-- QR Code generation -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js" defer></script>
    <!-- Hand-drawn annotations -->
    <script src="https://cdn.jsdelivr.net/npm/rough-notation@0.5.1/lib/rough-notation.iife.js" defer></script>
    <!-- Pan & zoom for any element -->
    <script src="https://cdn.jsdelivr.net/npm/@panzoom/panzoom@4.5.1/dist/panzoom.min.js" defer></script>
</head>
<body>
    <a href="#mainApp" class="skip-link">Skip to main content</a>

    <!-- Connection loss banner -->
    <div id="connectionBanner" class="connection-banner hidden" role="alert">
        <span class="connection-banner-icon"><span class="material-symbols-outlined">warning</span></span>
        <span>Connection lost — retrying...</span>
        <button onclick="location.reload()" class="connection-banner-btn">Reload</button>
    </div>

    <!-- Offline banner -->
    <div id="offlineBanner" class="connection-banner hidden" role="alert" style="background:#4a3a20">
        <span class="connection-banner-icon"><span class="material-symbols-outlined">wifi_off</span></span>
        <span>You're offline — AI features are disabled. Data browsing still works.</span>
    </div>

    <!-- Update available banner -->
    <div id="updateBanner" class="update-banner hidden" role="status">
        <span class="material-symbols-outlined">system_update</span>
        <span>Update available: <strong id="updateVersion"></strong></span>
        <a id="updateLink" href="#" target="_blank" class="btn btn-sm" style="margin-left:8px">Download</a>
        <button class="update-dismiss" onclick="dismissUpdateBanner()">&times;</button>
    </div>

    <!-- Keyboard shortcuts overlay -->
    <div id="shortcutsOverlay" class="shortcuts-overlay hidden" onclick="if(event.target===this)toggleShortcutsOverlay()">
        <div class="shortcuts-panel">
            <div class="shortcuts-header">
                <h2>Keyboard Shortcuts</h2>
                <button onclick="toggleShortcutsOverlay()" aria-label="Close shortcuts">&times;</button>
            </div>
            <div class="shortcuts-grid">
                <div class="shortcut-section">
                    <h3>Navigation</h3>
                    <div class="shortcut-row"><kbd>1</kbd>–<kbd>6</kbd> <span>Switch tabs</span></div>
                    <div class="shortcut-row"><kbd>/</kbd> <span>Focus search</span></div>
                    <div class="shortcut-row"><kbd>j</kbd> / <kbd>k</kbd> <span>Navigate rows</span></div>
                    <div class="shortcut-row"><kbd>Enter</kbd> <span>Open selected</span></div>
                    <div class="shortcut-row"><kbd>Esc</kbd> <span>Close panel/modal</span></div>
                </div>
                <div class="shortcut-section">
                    <h3>Actions</h3>
                    <div class="shortcut-row"><kbd>&#8984;K</kbd> <span>Quick search</span></div>
                    <div class="shortcut-row"><kbd>&#8984;E</kbd> <span>Export Excel</span></div>
                    <div class="shortcut-row"><kbd>&#8984;&#8679;P</kbd> <span>Export PDF</span></div>
                    <div class="shortcut-row"><kbd>?</kbd> <span>This overlay</span></div>
                </div>
                <div class="shortcut-section">
                    <h3>Views</h3>
                    <div class="shortcut-row"><kbd>g</kbd> <span>Geographic map (in Map tab)</span></div>
                    <div class="shortcut-row"><kbd>t</kbd> <span>Graph view (in Taxonomy tab)</span></div>
                </div>
            </div>
        </div>
    </div>

    <div class="container" role="main">
        <!-- ========== Project Selection Screen ========== -->
        <div id="projectSelection">
            <header>
                <div class="flex-between">
                    <div>
                        <h1>Research Taxonomy Library</h1>
                        <p class="header-subtitle">Select a research project or create a new one.</p>
                    </div>
                    <div style="display:flex;gap:8px;align-items:center">
                        <button class="icon-btn" onclick="openAppSettings()" title="Settings" aria-label="App settings"><span class="material-symbols-outlined">settings</span></button>
                        <button class="theme-toggle" onclick="toggleTheme()" title="Toggle dark mode (D)" aria-label="Toggle dark mode"><span class="material-symbols-outlined">dark_mode</span></button>
                    </div>
                </div>
            </header>
            <div id="projectGrid" class="project-grid" role="list" aria-label="Research projects"></div>
        </div>

        <!-- ========== New Project Form ========== -->
        <div id="newProjectForm" class="hidden">
            <header>
                <div class="header-with-back">
                    <button class="back-btn" onclick="showProjectSelection()">&larr;</button>
                    <h1>New Research Project</h1>
                </div>
            </header>
            <form onsubmit="createProject(event)">
                <div class="new-project-form">
                    <div class="form-group full-width">
                        <label for="npName">Project Name *</label>
                        <input type="text" id="npName" required placeholder="e.g. Aesthetic Design Connections">
                    </div>
                    <div class="form-group full-width">
                        <label for="npPurpose">Purpose *</label>
                        <textarea id="npPurpose" rows="3" required placeholder="What is this research for? What question are you trying to answer?"></textarea>
                    </div>
                    <div class="form-group full-width">
                        <label for="npOutcome">Expected Outcome</label>
                        <textarea id="npOutcome" rows="2" placeholder="What deliverable will this produce? e.g. FigJam board, market map, report"></textarea>
                    </div>
                    <div class="form-group full-width">
                        <label for="npCategories">Starting Categories *</label>
                        <textarea id="npCategories" rows="3" required placeholder="Enter category names, one per line. These seed the initial taxonomy structure."></textarea>
                    </div>
                    <div class="form-group full-width">
                        <label for="npLinks">Example Links</label>
                        <textarea id="npLinks" rows="4" placeholder="Paste example URLs that represent the type of companies/products you're researching (one per line)"></textarea>
                    </div>
                    <div class="form-group full-width">
                        <label for="npKeywords">Market Keywords</label>
                        <input type="text" id="npKeywords" placeholder="Comma-separated keywords for triage relevance. e.g. design, aesthetic, visual, art, creative">
                    </div>
                    <div class="form-group full-width">
                        <label for="npDescription">Description</label>
                        <textarea id="npDescription" rows="3" placeholder="Any additional context or notes about this research project"></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="primary-btn">Create Project</button>
                        <button type="button" class="btn" onclick="showProjectSelection()">Cancel</button>
                    </div>
                </div>
            </form>
        </div>

        <!-- ========== Main App (shown after project selection) ========== -->
        <div id="mainApp" class="hidden">
            <header>
                <div class="flex-between">
                    <div class="header-with-back">
                        <button class="back-btn" onclick="switchProject()">&larr;</button>
                        <div>
                            <h1 id="projectTitle">Project</h1>
                            <div class="stats-bar">
                                <span id="statCompanies">0 companies</span>
                                <span id="statCategories">0 categories</span>
                                <span id="statUpdated">Never updated</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex-center-gap">
                        <button class="notification-bell" onclick="toggleNotificationPanel()" title="Notifications" aria-label="Toggle notifications" aria-expanded="false" aria-controls="notificationPanel">
                            <span class="bell-icon" aria-hidden="true"><span class="material-symbols-outlined">notifications</span></span>
                            <span class="bell-badge hidden" id="bellBadge" aria-live="polite">0</span>
                        </button>
                        <button class="theme-toggle" onclick="toggleTheme()" title="Toggle dark mode (D)" aria-label="Toggle dark mode"><span class="material-symbols-outlined">dark_mode</span></button>
                    </div>
                </div>
            </header>

            <!-- Notification Panel -->
            <div id="notificationPanel" class="notification-panel hidden">
                <div class="notif-panel-header">
                    <strong>Recent Activity</strong>
                    <button class="close-btn" onclick="toggleNotificationPanel()">&times;</button>
                </div>
                <div id="notifPanelContent" class="notif-panel-content">
                    <p class="hint-text">No recent activity.</p>
                </div>
            </div>

            <nav class="tabs" role="tablist" aria-label="Main navigation">
                <button class="tab active" role="tab" aria-selected="true" aria-controls="tab-companies" onclick="showTab('companies')">Companies</button>
                <button class="tab" role="tab" aria-selected="false" aria-controls="tab-taxonomy" onclick="showTab('taxonomy')">Taxonomy</button>
                <button class="tab" role="tab" aria-selected="false" aria-controls="tab-map" onclick="showTab('map')">Map</button>
                <button class="tab" role="tab" aria-selected="false" aria-controls="tab-reports" onclick="showTab('reports')">Research</button>
                <button class="tab" role="tab" aria-selected="false" aria-controls="tab-canvas" onclick="showTab('canvas')">Canvas</button>
                <button class="tab" role="tab" aria-selected="false" aria-controls="tab-discovery" onclick="showTab('discovery')" id="discoveryTabBtn" class="hidden">Discovery</button>
                <button class="tab" role="tab" aria-selected="false" aria-controls="tab-process" onclick="showTab('process')">Process</button>
                <button class="tab" role="tab" aria-selected="false" aria-controls="tab-export" onclick="showTab('export')">Export</button>
            </nav>

            <!-- Breadcrumb Navigation -->
            <div id="breadcrumbBar" class="breadcrumb-bar hidden"></div>

            <!-- Companies Tab -->
            <section id="tab-companies" class="tab-content active" role="tabpanel" aria-label="Companies">
                <div class="controls">
                    <input type="text" id="searchInput" placeholder="Search companies... (/ to focus)" oninput="debounceSearch()">
                    <select id="categoryFilter" onchange="addFilterFromSelect('category')">
                        <option value="">+ Category</option>
                    </select>
                    <select id="tagFilter" onchange="addFilterFromSelect('tag')">
                        <option value="">+ Tag</option>
                    </select>
                    <select id="geoFilter" onchange="addFilterFromSelect('geography')">
                        <option value="">+ Geography</option>
                    </select>
                    <select id="stageFilter" onchange="addFilterFromSelect('funding_stage')">
                        <option value="">+ Stage</option>
                    </select>
                    <select id="relationshipFilter" class="filter-select" onchange="loadCompanies()">
                        <option value="">Relationship</option>
                        <option value="any">Any flagged</option>
                        <option value="watching">Watching</option>
                        <option value="to_reach_out">To Reach Out</option>
                        <option value="in_conversation">In Conversation</option>
                        <option value="met">Met</option>
                        <option value="partner">Partner</option>
                        <option value="not_relevant">Not Relevant</option>
                    </select>
                    <input type="text" id="foundedYearFilter" placeholder="Founded year range..." style="width:150px;font-size:12px" readonly>
                    <label class="filter-checkbox"><input type="checkbox" id="starredFilter" onchange="loadCompanies()"> Starred</label>
                    <label class="filter-checkbox"><input type="checkbox" id="enrichmentFilter" onchange="loadCompanies()"> Needs enrichment</label>
                    <button class="filter-action-btn" onclick="openTagManager()" title="Manage tags">Tags</button>
                </div>

                <!-- Active filters as chips -->
                <div id="activeFilters" class="filter-chips-bar hidden"></div>

                <!-- Saved views bar -->
                <div class="saved-views-bar">
                    <select id="savedViewSelect" onchange="loadSavedView()">
                        <option value="">Saved views...</option>
                    </select>
                    <button class="filter-action-btn" onclick="saveCurrentView()" title="Save current filters">Save view</button>
                </div>

                <div class="company-view-toggle">
                    <button class="view-toggle-btn active" id="viewTableBtn" onclick="switchCompanyView('table')">
                        <span class="material-symbols-outlined" style="font-size:16px">table_rows</span> Table
                    </button>
                    <button class="view-toggle-btn" id="viewGalleryBtn" onclick="switchCompanyView('gallery')">
                        <span class="material-symbols-outlined" style="font-size:16px">grid_view</span> Gallery
                    </button>
                    <button class="view-toggle-btn" id="viewTimelineBtn" onclick="switchCompanyView('timeline')">
                        <span class="material-symbols-outlined" style="font-size:16px">timeline</span> Timeline
                    </button>
                    <button class="view-toggle-btn" id="viewMatrixBtn" onclick="switchCompanyView('matrix')">
                        <span class="material-symbols-outlined" style="font-size:16px">grid_on</span> Matrix
                    </button>
                </div>

                <div id="companyViewContainer" class="hidden"></div>

                <table id="companyTable">
                    <thead>
                        <tr>
                            <th class="bulk-header" style="width:2%"><input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this)" title="Select all"></th>
                            <th class="sort-header" data-sort="starred" style="width:3%"></th>
                            <th class="sort-header" data-sort="name">Name</th>
                            <th class="sort-header" data-sort="category">Category</th>
                            <th>What</th>
                            <th>Target</th>
                            <th class="sort-header" data-sort="geography">Geo</th>
                            <th>Sources</th>
                            <th>Tags</th>
                            <th class="sort-header" data-sort="confidence">Conf.</th>
                        </tr>
                    </thead>
                    <tbody id="companyBody"></tbody>
                </table>

                <!-- Bulk Action Bar -->
                <div id="bulkActionBar" class="bulk-action-bar hidden">
                    <span id="bulkCount">0 selected</span>
                    <button class="btn" onclick="bulkAction('assign_category')"><span class="material-symbols-outlined">category</span> Assign Category</button>
                    <button class="btn" onclick="bulkAction('add_tags')"><span class="material-symbols-outlined">label</span> Add Tags</button>
                    <button class="btn" onclick="bulkAction('set_relationship')"><span class="material-symbols-outlined">handshake</span> Set Relationship</button>
                    <button class="btn" onclick="startBatchEnrichment()"><span class="material-symbols-outlined">auto_fix_high</span> Enrich</button>
                    <button class="danger-btn" onclick="bulkAction('delete')"><span class="material-symbols-outlined">delete</span> Delete</button>
                    <button class="btn" onclick="clearBulkSelection()"><span class="material-symbols-outlined">close</span></button>
                </div>

                <!-- Detail Panel -->
                <div id="detailPanel" class="detail-panel hidden">
                    <div class="detail-header">
                        <h2 id="detailName"></h2>
                        <button class="close-btn" onclick="closeDetail()">&times;</button>
                    </div>
                    <div id="detailContent"></div>
                </div>
            </section>

            <!-- Taxonomy Tab -->
            <section id="tab-taxonomy" class="tab-content" role="tabpanel" aria-label="Taxonomy">
                <!-- Analytics Dashboard -->
                <div class="analytics-dashboard">
                    <h3 class="collapsible-header" onclick="toggleSection('analyticsSection')">
                        Analytics Dashboard <span id="analyticsSection-toggle" class="collapse-arrow"><span class="material-symbols-outlined">expand_more</span></span>
                    </h3>
                    <div id="analyticsSection" class="collapsible-body">
                        <!-- Category Matrix (full width) -->
                        <div class="chart-card chart-card-wide" style="margin-bottom:16px">
                            <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">
                                <h4 style="margin:0">Category Matrix</h4>
                                <div style="display:flex;gap:8px;align-items:center">
                                    <label style="font-size:12px;color:var(--text-muted)">Columns:</label>
                                    <select id="matrixDimension" onchange="renderCategoryMatrix()" style="padding:4px 8px;border:1px solid var(--border-default);border-radius:6px;font-size:12px;background:var(--bg-input);color:var(--text-primary)">
                                        <option value="funding_stage">Funding Stage</option>
                                        <option value="hq_country">Geography</option>
                                        <option value="business_model">Business Model</option>
                                        <option value="employee_range">Company Size</option>
                                    </select>
                                </div>
                            </div>
                            <div id="matrixContainer" class="matrix-container"></div>
                        </div>
                        <div class="chart-grid">
                            <div class="chart-card">
                                <h4>Funding Stage Distribution</h4>
                                <canvas id="chartFundingStage" height="250"></canvas>
                            </div>
                            <div class="chart-card">
                                <h4>Geographic Distribution</h4>
                                <div id="chartGeoDist" class="chart-container"></div>
                            </div>
                            <div class="chart-card">
                                <h4>Confidence Scores</h4>
                                <canvas id="chartConfidence" height="250"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Taxonomy View Toggle -->
                <div class="taxonomy-view-toggle">
                    <button class="view-toggle-btn active" onclick="switchTaxonomyView('tree')" id="treeViewBtn">Tree View</button>
                    <button class="view-toggle-btn" onclick="switchTaxonomyView('graph')" id="graphViewBtn">Graph View</button>
                    <button class="view-toggle-btn" onclick="switchTaxonomyView('knowledge')" id="kgViewBtn">Knowledge Graph</button>
                </div>
                <div id="taxonomyTree"></div>
                <div id="taxonomyGraph" class="hidden graph-container"></div>
                <div id="knowledgeGraph" class="hidden">
                    <div class="kg-filter-panel">
                        <label><input type="checkbox" checked onchange="toggleKgNodeType('category')"> Categories</label>
                        <label><input type="checkbox" checked onchange="toggleKgNodeType('company')"> Companies</label>
                        <label><input type="checkbox" checked onchange="toggleKgNodeType('tag')"> Tags</label>
                        <label><input type="checkbox" checked onchange="toggleKgNodeType('geography')"> Geographies</label>
                    </div>
                    <div id="kgCanvas" class="kg-container"></div>
                </div>

                <div class="review-section">
                    <h3>Taxonomy Review</h3>
                    <p class="hint-text">Run a comprehensive AI review of all categories and company placements. Add your own observations to guide the review.</p>
                    <textarea id="reviewObservations" rows="3" class="review-textarea" placeholder="Add your observations to guide the review, e.g. 'Extend taxonomy with EAP section', 'Too many companies in Diagnostics', 'Consider splitting Wellness into Physical and Mental'..."></textarea>
                    <div class="flex-gap-sm">
                        {{ model_select('reviewModelSelect') }}
                        <button class="btn" id="reviewBtn" onclick="startTaxonomyReview()">Review Taxonomy with AI</button>
                    </div>
                    <div id="reviewStatus" class="hidden"></div>
                    <div id="reviewResults" class="hidden"></div>
                </div>

                <h3 class="collapsible-header" onclick="toggleSection('qualitySection')">
                    Quality Dashboard <span id="qualitySection-toggle" class="collapse-arrow"><span class="material-symbols-outlined">expand_more</span></span>
                </h3>
                <div id="qualitySection" class="collapsible-body">
                    <div id="qualityDashboard" class="quality-dashboard">
                        <button class="btn" onclick="loadTaxonomyQuality()">Refresh Quality Metrics</button>
                        <div id="qualityContent" class="hidden"></div>
                    </div>
                </div>

                <h3 class="collapsible-header" onclick="toggleSection('historySection')">
                    Change History <span id="historySection-toggle" class="collapse-arrow"><span class="material-symbols-outlined">expand_more</span></span>
                </h3>
                <div id="historySection" class="collapsible-body">
                    <div id="taxonomyHistory"></div>
                </div>
            </section>

            <!-- Map Tab -->
            <section id="tab-map" class="tab-content" role="tabpanel" aria-label="Map">
                <div class="map-controls">
                    <div class="map-view-toggle">
                        <button class="view-toggle-btn active" onclick="switchMapView('market')" id="marketMapBtn">Market Map</button>
                        <button class="view-toggle-btn" onclick="switchMapView('auto')" id="autoMapBtn">Auto-Layout</button>
                        <button class="view-toggle-btn" onclick="switchMapView('geo')" id="geoMapBtn">Geographic Map</button>
                    </div>
                    <button class="primary-btn" onclick="loadMarketMap()">Refresh Map</button>
                    <button class="btn" onclick="exportMapPng()">Export as PNG</button>
                    <button class="btn" id="heatmapToggleBtn" onclick="toggleGeoHeatmap()" title="Toggle density heatmap on geographic map"><span class="material-symbols-outlined" style="font-size:16px;vertical-align:middle">thermostat</span> Heatmap</button>
                    <button class="btn" onclick="startPresentation('map')"><span class="material-symbols-outlined" style="font-size:16px;vertical-align:middle">slideshow</span> Present</button>
                    <span class="hint-text hint-inline">Drag companies between categories to reclassify.</span>
                </div>
                <div id="marketMap" class="market-map"></div>
                <div id="autoLayoutMap" class="hidden auto-layout-container"></div>
                <div id="geoMap" class="hidden geo-map-container"></div>

                <!-- Comparison Panel -->
                <div id="compareSection" class="hidden">
                    <div class="compare-header">
                        <h3>Compare Companies</h3>
                        <button class="close-btn" onclick="clearComparison()">&times;</button>
                    </div>
                    <div id="compareContent"></div>
                </div>

                <div class="compare-bar hidden" id="compareBar">
                    <span id="compareCount">0 selected</span>
                    <button class="primary-btn" onclick="runComparison()">Compare</button>
                    <button class="btn" onclick="clearCompareSelection()">Clear</button>
                </div>
            </section>

            <!-- Research Tab -->
            <section id="tab-reports" class="tab-content" role="tabpanel" aria-label="Research">
                <!-- Research mode toggle -->
                <div class="research-mode-toggle">
                    <button class="view-toggle-btn active" id="quickReportModeBtn" onclick="switchResearchMode('report')">Quick Report</button>
                    <button class="view-toggle-btn" id="deepDiveModeBtn" onclick="switchResearchMode('deepdive')">Deep Dive</button>
                </div>

                <!-- Quick Report mode (existing) -->
                <div id="researchModeReport">
                    <div class="market-report-section">
                        <h3>Generate Category Report</h3>
                        <p class="hint-text">Generate AI-powered market analysis for a category. Reports are saved automatically.</p>
                        <div class="report-controls">
                            <select id="reportCategorySelect">
                                <option value="">Select a category...</option>
                            </select>
                            {{ model_select('reportModelSelect', default='sonnet') }}
                            <button class="primary-btn" id="reportBtn" onclick="generateMarketReport()">Generate Report</button>
                        </div>
                        <div id="reportStatus" class="hidden">
                            <div class="progress-bar"><div id="reportProgress" class="progress-fill" style="width:50%;animation:pulse 2s infinite"></div></div>
                            <p>Generating report... AI is researching the web and analyzing your data. This typically takes 2-4 minutes.</p>
                        </div>
                    </div>

                    <div id="reportContent" class="hidden report-viewer"></div>

                    <h3 class="section-heading">Saved Reports</h3>
                    <p class="hint-text">Previously generated reports are stored here.</p>
                    <div id="savedReportsList"></div>
                </div>

                <!-- Deep Dive mode (new) -->
                <div id="researchModeDeepDive" class="hidden">
                    <div class="research-input-section">
                        <h3>Deep Dive Research</h3>
                        <p class="hint-text">Ask any research question. AI will use your project data and web search to produce a comprehensive report.</p>

                        <div class="research-scope-row">
                            <label>Scope:</label>
                            <select id="researchScopeType" onchange="onResearchScopeChange()">
                                <option value="project">Entire Project</option>
                                <option value="category">Category</option>
                                <option value="company">Company</option>
                                <option value="custom">Custom (no context)</option>
                            </select>
                            <select id="researchScopeId" class="hidden">
                                <option value="">Select...</option>
                            </select>
                            <input type="text" id="researchCompanySearch" class="hidden" placeholder="Search company..." oninput="searchResearchCompany()">
                            <div id="researchCompanyResults" class="research-company-dropdown hidden"></div>
                        </div>

                        <div class="research-templates">
                            <span class="hint-text">Templates:</span>
                            <span id="researchTemplateButtons"><!-- loaded dynamically --></span>
                        </div>

                        <div class="research-prompt-row">
                            <textarea id="researchPrompt" rows="4" placeholder="What do you want to research? Be specific for better results..."></textarea>
                        </div>

                        <div class="research-action-row">
                            <input type="text" id="researchTitle" placeholder="Research title (auto-generated if blank)">
                            {{ model_select('researchModelSelect', default='sonnet') }}
                            <button class="primary-btn" id="researchBtn" onclick="startDeepDive()">
                                <span class="material-symbols-outlined">science</span> Start Research
                            </button>
                        </div>

                        <div id="researchStatus" class="hidden">
                            <div class="progress-bar"><div id="researchProgress" class="progress-fill" style="width:50%;animation:pulse 2s infinite"></div></div>
                            <p id="researchStatusText">Researching... AI is searching the web and analyzing data. This may take 2-10 minutes.</p>
                            <button class="btn btn-sm" onclick="cancelResearchPoll()" style="margin-top:8px">Cancel</button>
                        </div>
                    </div>

                    <div id="researchResult" class="hidden report-viewer"></div>

                    <h3 class="section-heading">Saved Research</h3>
                    <p class="hint-text">Previously completed deep dives are stored here.</p>
                    <div id="savedResearchList"></div>
                </div>
            </section>

            <!-- Canvas Tab -->
            <section id="tab-canvas" class="tab-content" role="tabpanel" aria-label="Canvas">
                <div class="canvas-toolbar">
                    <div class="canvas-toolbar-left">
                        <select id="canvasSelect" onchange="loadCanvasFromSelect()">
                            <option value="">Select canvas...</option>
                        </select>
                        <button class="primary-btn" onclick="createNewCanvas()"><span class="material-symbols-outlined">add</span> New Canvas</button>
                        <button class="btn" id="renameCanvasBtn" onclick="renameCurrentCanvas()" disabled>Rename</button>
                        <button class="btn" style="color:var(--accent-danger)" id="deleteCanvasBtn" onclick="deleteCurrentCanvas()" disabled>Delete</button>
                    </div>
                    <div class="canvas-toolbar-right">
                        <button class="btn" id="canvasGenDiagramBtn" onclick="openDiagramPanel()" disabled title="AI-generated diagram">
                            <span class="material-symbols-outlined">auto_awesome</span> AI Diagram
                        </button>
                        <button class="btn" id="canvasExportPngBtn" onclick="exportCanvasPng()" disabled title="Export as PNG">
                            <span class="material-symbols-outlined">image</span> PNG
                        </button>
                        <button class="btn" id="canvasExportSvgBtn" onclick="exportCanvasSvg()" disabled title="Export as SVG">
                            <span class="material-symbols-outlined">picture_as_pdf</span> SVG
                        </button>
                        <button class="btn" id="canvasExportPdfBtn" onclick="exportCanvasPdf()" disabled title="Export as PDF (vector)">
                            <span class="material-symbols-outlined">description</span> PDF
                        </button>
                    </div>
                </div>

                <!-- Drawing toolbar (shown when a canvas is loaded) -->
                <div id="canvasDrawToolbar" class="canvas-draw-toolbar hidden">
                    <div class="draw-tool-group">
                        <button class="draw-tool active" id="toolSelect" onclick="setCanvasTool('select')" title="Select (V)">
                            <span class="material-symbols-outlined">arrow_selector_tool</span>
                        </button>
                        <button class="draw-tool" id="toolPan" onclick="setCanvasTool('pan')" title="Pan (H)">
                            <span class="material-symbols-outlined">pan_tool</span>
                        </button>
                    </div>
                    <div class="draw-tool-sep"></div>
                    <div class="draw-tool-group">
                        <button class="draw-tool" id="toolPen" onclick="setCanvasTool('pen')" title="Freehand Draw (P)">
                            <span class="material-symbols-outlined">draw</span>
                        </button>
                        <button class="draw-tool" id="toolLine" onclick="setCanvasTool('line')" title="Line / Arrow (L)">
                            <span class="material-symbols-outlined">arrow_right_alt</span>
                        </button>
                        <button class="draw-tool" id="toolRect" onclick="setCanvasTool('rect')" title="Rectangle (R)">
                            <span class="material-symbols-outlined">rectangle</span>
                        </button>
                        <button class="draw-tool" id="toolCircle" onclick="setCanvasTool('circle')" title="Circle (O)">
                            <span class="material-symbols-outlined">circle</span>
                        </button>
                        <button class="draw-tool" id="toolDiamond" onclick="setCanvasTool('diamond')" title="Diamond (D)">
                            <span class="material-symbols-outlined">diamond</span>
                        </button>
                        <button class="draw-tool" id="toolText" onclick="setCanvasTool('text')" title="Text (T)">
                            <span class="material-symbols-outlined">text_fields</span>
                        </button>
                        <button class="draw-tool" id="toolNote" onclick="setCanvasTool('note')" title="Sticky Note (N)">
                            <span class="material-symbols-outlined">sticky_note_2</span>
                        </button>
                    </div>
                    <div class="draw-tool-sep"></div>
                    <div class="draw-tool-group">
                        <label class="draw-tool-label" title="Fill color">
                            <input type="color" id="canvasFillColor" value="#bc6c5a" class="canvas-color-input" onchange="applyFillToSelected(this.value)">
                        </label>
                        <label class="draw-tool-label" title="Stroke color">
                            <input type="color" id="canvasStrokeColor" value="#3D4035" class="canvas-color-input" onchange="applyStrokeToSelected(this.value)">
                        </label>
                        <select id="canvasStrokeWidth" class="draw-tool-select" title="Stroke width" onchange="applyStrokeWidthToSelected(+this.value)">
                            <option value="1">1px</option>
                            <option value="2" selected>2px</option>
                            <option value="3">3px</option>
                            <option value="5">5px</option>
                            <option value="8">8px</option>
                        </select>
                        <select id="canvasFontSize" class="draw-tool-select" title="Font size" onchange="applyFontSizeToSelected(+this.value)">
                            <option value="12">12</option>
                            <option value="14" selected>14</option>
                            <option value="18">18</option>
                            <option value="24">24</option>
                            <option value="32">32</option>
                            <option value="48">48</option>
                        </select>
                    </div>
                    <div class="draw-tool-sep"></div>
                    <div class="draw-tool-group">
                        <button class="draw-tool" onclick="deleteSelectedCanvasElements()" title="Delete (Del)">
                            <span class="material-symbols-outlined">delete</span>
                        </button>
                        <button class="draw-tool" onclick="canvasUndo()" title="Undo (Cmd+Z)">
                            <span class="material-symbols-outlined">undo</span>
                        </button>
                        <button class="draw-tool" onclick="canvasRedo()" title="Redo (Cmd+Shift+Z)">
                            <span class="material-symbols-outlined">redo</span>
                        </button>
                    </div>
                    <div class="draw-tool-sep"></div>
                    <div class="draw-tool-group">
                        <button class="draw-tool" onclick="canvasZoom(1.2)" title="Zoom in">
                            <span class="material-symbols-outlined">zoom_in</span>
                        </button>
                        <button class="draw-tool" onclick="canvasZoom(0.8)" title="Zoom out">
                            <span class="material-symbols-outlined">zoom_out</span>
                        </button>
                        <button class="draw-tool" onclick="canvasFitView()" title="Fit to view">
                            <span class="material-symbols-outlined">fit_screen</span>
                        </button>
                        <button class="draw-tool" id="toolGrid" onclick="toggleCanvasGrid()" title="Toggle grid (G)">
                            <span class="material-symbols-outlined">grid_on</span>
                        </button>
                    </div>
                </div>

                <div class="canvas-workspace">
                    <div class="canvas-sidebar" id="canvasSidebar">
                        <div class="canvas-sidebar-header">
                            <h4>Companies</h4>
                            <input type="text" id="canvasCompanySearch" placeholder="Search..." oninput="filterCanvasCompanies()">
                        </div>
                        <div id="canvasCompanyList" class="canvas-company-list"></div>
                    </div>
                    <!-- AI Diagram generation panel (replaces sidebar when open) -->
                    <div class="canvas-sidebar canvas-diagram-panel hidden" id="diagramPanel">
                        <div class="canvas-sidebar-header">
                            <div style="display:flex;justify-content:space-between;align-items:center">
                                <h4><span class="material-symbols-outlined" style="font-size:16px;vertical-align:-3px">auto_awesome</span> AI Diagram</h4>
                                <button class="btn btn-sm" onclick="closeDiagramPanel()" title="Close" style="padding:2px 6px">&times;</button>
                            </div>
                        </div>
                        <div class="diagram-panel-body">
                            <label class="diagram-label">Describe your diagram:</label>
                            <textarea id="diagramPrompt" rows="3" placeholder="e.g., Show all companies in a stacked enterprise architecture diagram grouped by subcategory..."></textarea>

                            <label class="diagram-label">Categories to include:</label>
                            <div class="diagram-cat-actions">
                                <button class="btn btn-xs" onclick="toggleAllDiagramCategories(true)">All</button>
                                <button class="btn btn-xs" onclick="toggleAllDiagramCategories(false)">None</button>
                            </div>
                            <div id="diagramCategoryList" class="diagram-checkbox-list"></div>

                            <label class="diagram-label">Data fields per company:</label>
                            <div id="diagramFieldList" class="diagram-checkbox-list">
                                <label><input type="checkbox" value="name" checked disabled> Name</label>
                                <label><input type="checkbox" value="url"> URL</label>
                                <label><input type="checkbox" value="what"> What they do</label>
                                <label><input type="checkbox" value="target"> Target market</label>
                                <label><input type="checkbox" value="funding_stage"> Funding stage</label>
                                <label><input type="checkbox" value="total_funding_usd"> Total funding</label>
                                <label><input type="checkbox" value="employee_range"> Employees</label>
                                <label><input type="checkbox" value="hq_country"> HQ Country</label>
                                <label><input type="checkbox" value="business_model"> Business model</label>
                                <label><input type="checkbox" value="founded_year"> Founded</label>
                            </div>

                            <label class="diagram-label">Layout style:</label>
                            <select id="diagramLayoutStyle" class="draw-tool-select" style="width:100%;min-width:0">
                                <option value="stacked_vertical">Stacked Vertical</option>
                                <option value="stacked_horizontal">Stacked Horizontal</option>
                                <option value="grid" selected>Grid</option>
                                <option value="flow">Flow (dagre)</option>
                                <option value="enterprise_stack">Enterprise Stack (ELK)</option>
                            </select>

                            <label class="diagram-label">Visual style:</label>
                            <div class="diagram-style-toggle">
                                <label><input type="radio" name="diagramVisualStyle" value="clean" checked> Clean</label>
                                <label><input type="radio" name="diagramVisualStyle" value="sketch"> Sketch</label>
                            </div>

                            <label class="diagram-label" style="display:flex;align-items:center;gap:6px">
                                <input type="checkbox" id="diagramClearCanvas" checked> Clear canvas first
                            </label>

                            <div class="diagram-action-row">
                                {{ model_select('diagramModelSelect', default='sonnet') }}
                                <button class="primary-btn" id="diagramGenBtn" onclick="startDiagramGeneration()">
                                    <span class="material-symbols-outlined" style="font-size:16px;vertical-align:-3px">auto_awesome</span> Generate
                                </button>
                            </div>

                            <div id="diagramStatus" class="hidden" style="margin-top:6px">
                                <div class="progress-bar"><div class="progress-fill" id="diagramProgressFill" style="width:30%;animation:pulse 2s infinite"></div></div>
                                <p class="hint-text" id="diagramStatusText">Generating diagram layout...</p>
                                <button class="btn btn-xs" onclick="cancelDiagramGeneration()" style="margin-top:4px">Cancel</button>
                            </div>

                            <div id="diagramError" class="hidden" style="color:var(--accent-danger);font-size:12px;margin-top:6px"></div>

                            <div id="diagramPostActions" class="hidden" style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap">
                                <button class="btn btn-sm" onclick="autoArrangeDiagram()"><span class="material-symbols-outlined" style="font-size:14px;vertical-align:-2px">auto_fix_high</span> Auto-arrange</button>
                                <button class="btn btn-sm" onclick="startDiagramGeneration()"><span class="material-symbols-outlined" style="font-size:14px;vertical-align:-2px">refresh</span> Regenerate</button>
                                <button class="btn btn-sm" onclick="closeDiagramPanel()">Done</button>
                            </div>
                        </div>
                    </div>
                    <div class="canvas-main">
                        <div class="canvas-empty-state" id="canvasEmptyState">
                            <span class="material-symbols-outlined" style="font-size:48px;color:var(--text-muted)">dashboard</span>
                            <p>Select or create a canvas to start arranging companies visually.</p>
                            <p class="hint-text">Drag companies from the sidebar. Use the toolbar to draw shapes, lines, and text.</p>
                        </div>
                        <div id="canvasWrapper" class="canvas-container hidden">
                            <canvas id="fabricCanvas"></canvas>
                        </div>
                    </div>
                </div>
                <!-- Canvas context menu -->
                <div id="canvasCtxMenu" class="canvas-context-menu hidden"></div>
            </section>

            <!-- Process Tab -->
            <section id="tab-process" class="tab-content" role="tabpanel" aria-label="Process">
                <!-- AI Setup Panel -->
                <div class="ai-setup-panel" id="aiSetupPanel">
                    <div class="ai-setup-header" onclick="toggleAiSetup()">
                        <h3><span class="material-symbols-outlined" style="font-size:18px;vertical-align:middle;margin-right:4px">settings</span> AI Setup</h3>
                        <span class="ai-setup-summary" id="aiSetupSummary"></span>
                        <span class="material-symbols-outlined ai-setup-arrow" id="aiSetupArrow">expand_more</span>
                    </div>
                    <div class="ai-setup-body hidden" id="aiSetupBody">
                        <div class="ai-setup-grid">
                            <!-- Claude API Key -->
                            <div class="ai-setup-card">
                                <div class="ai-setup-card-header">
                                    <span class="ai-setup-status" id="sdkStatus"></span>
                                    <strong>Claude API (SDK)</strong>
                                </div>
                                <p class="hint-text">Fastest setup. Get a key from <a href="https://console.anthropic.com/settings/keys" target="_blank" rel="noopener">console.anthropic.com</a></p>
                                <div class="ai-setup-key-row">
                                    <input type="password" id="aiSetupApiKey" placeholder="sk-ant-..." autocomplete="off" spellcheck="false">
                                    <button class="btn btn-sm" onclick="saveAiApiKey()">Save Key</button>
                                </div>
                                <div class="ai-setup-key-status" id="apiKeyStatus"></div>
                                <button class="btn btn-sm" onclick="testAiBackend('claude_sdk')" id="testSdkBtn">Test Connection</button>
                            </div>
                            <!-- Claude CLI -->
                            <div class="ai-setup-card">
                                <div class="ai-setup-card-header">
                                    <span class="ai-setup-status" id="cliStatus"></span>
                                    <strong>Claude CLI</strong>
                                </div>
                                <p class="hint-text">Uses your Claude subscription. Supports web search.</p>
                                <div class="ai-setup-key-status" id="cliPathStatus"></div>
                                <button class="btn btn-sm" onclick="testAiBackend('claude_cli')" id="testCliBtn">Test Connection</button>
                            </div>
                            <!-- Gemini CLI -->
                            <div class="ai-setup-card">
                                <div class="ai-setup-card-header">
                                    <span class="ai-setup-status" id="geminiStatus"></span>
                                    <strong>Gemini CLI</strong>
                                </div>
                                <p class="hint-text">Google AI. Requires Node.js. Run <code>npx @google/gemini-cli</code> in terminal to authenticate.</p>
                                <div class="ai-setup-key-status" id="geminiPathStatus"></div>
                                <button class="btn btn-sm" onclick="testAiBackend('gemini')" id="testGeminiBtn">Test Connection</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Discovery -->
                <div class="ai-discovery-section">
                    <h3>AI Company Discovery</h3>
                    <p class="hint-text">Describe a market segment and AI will search for relevant companies.</p>
                    <div class="discovery-input">
                        <input type="text" id="discoveryQuery" placeholder="e.g. gut microbiome testing companies, digital therapeutics for mental health...">
                        {{ model_select('discoveryModelSelect') }}
                        <button class="primary-btn" id="discoveryBtn" onclick="startDiscovery()">Discover</button>
                    </div>
                    <div id="discoveryResults" class="hidden">
                        <div id="discoveryStatus" class="hidden">
                            <div class="progress-bar"><div id="discoveryProgress" class="progress-fill" style="width:50%;animation:pulse 2s infinite"></div></div>
                            <p>Searching for companies...</p>
                        </div>
                        <div id="discoveryList"></div>
                    </div>
                </div>

                <div class="process-input">
                    <h3>Submit URLs for Processing</h3>
                    <textarea id="urlInput" rows="8" placeholder="Paste URLs here (one per line, or mixed with other text)..."></textarea>
                    <div class="process-options">
                        <label>Model: {{ model_select('modelSelect', include_gemini=false) }}</label>
                        <label title="Number of URLs to research simultaneously. Higher = faster but uses more API calls in parallel.">Parallel:
                            <select id="workerCount">
                                <option value="3">3 (conservative)</option>
                                <option value="5" selected>5 (balanced)</option>
                                <option value="8">8 (fast)</option>
                                <option value="10">10 (max speed)</option>
                            </select>
                        </label>
                        <button class="primary-btn" onclick="submitUrls()">Start Processing</button>
                    </div>
                </div>

                <!-- Triage Results -->
                <div id="triageSection" class="hidden">
                    <h3>Pre-Validation Triage <span id="triageStatus" class="triage-status-badge"></span></h3>
                    <p class="triage-info">Links are being checked for accessibility and relevance. Review flagged items below before processing.</p>

                    <div class="progress-bar">
                        <div id="triageProgress" class="progress-fill"></div>
                    </div>
                    <p id="triageProgressText"></p>

                    <div id="triageResults"></div>

                    <div id="triageActions" class="hidden">
                        <div class="triage-action-bar">
                            <span id="triageSummaryText"></span>
                            <button class="primary-btn" onclick="confirmAndProcess()">Confirm &amp; Process</button>
                            <button class="btn" onclick="resetTriage()">Cancel</button>
                        </div>
                    </div>
                </div>

                <!-- Processing Status -->
                <div id="processingStatus" class="hidden">
                    <div class="flex-between" style="align-items:center">
                        <h3>Processing Batch: <span id="batchId"></span></h3>
                        <button class="btn btn-sm" onclick="cancelBatchPolling()" title="Stop watching (batch continues on server)">Cancel Watch</button>
                    </div>
                    <div class="progress-bar">
                        <div id="processProgress" class="progress-fill"></div>
                    </div>
                    <p id="processStatus"></p>
                </div>

                <h3>Recent Batches</h3>
                <p class="hint-text">Click a batch to see full details.</p>
                <div id="batchList"></div>
                <div id="batchDetailView" class="hidden"></div>
            </section>

            <!-- Discovery Tab -->
            <section id="tab-discovery" class="tab-content" role="tabpanel" aria-label="Discovery">
                <div class="discovery-header">
                    <h2>Product Discovery</h2>
                    <p class="discovery-subtitle">Feature landscape analysis, gap identification, and competitive intelligence</p>
                </div>

                <!-- Context Files -->
                <div class="discovery-section">
                    <div class="discovery-section-header" onclick="toggleSection('discoveryContexts')">
                        <h3>Context Files</h3>
                        <span id="discoveryContexts-toggle" class="section-arrow">&#9660;</span>
                    </div>
                    <div id="discoveryContexts">
                        <div class="context-upload-area" id="contextDropZone">
                            <p>Drag & drop a markdown/text file here, or</p>
                            <input type="file" id="contextFileInput" accept=".md,.txt,.markdown" style="display:none">
                            <button class="btn" onclick="document.getElementById('contextFileInput').click()">Choose File</button>
                        </div>
                        <div id="contextsList" class="contexts-list"></div>
                    </div>
                </div>

                <!-- Dimensions -->
                <div class="discovery-section">
                    <div class="discovery-section-header" onclick="toggleSection('discoveryDimensions')">
                        <h3>Research Dimensions</h3>
                        <span id="discoveryDimensions-toggle" class="section-arrow">&#9660;</span>
                    </div>
                    <div id="discoveryDimensions">
                        <div class="dimensions-toolbar">
                            <button class="btn btn-primary" onclick="exploreDimensions()">Explore New Dimensions</button>
                            <button class="btn" onclick="showAddDimensionModal()">Add Manual</button>
                        </div>
                        <div id="dimensionsList" class="dimensions-list"></div>
                        <div id="dimensionExploreResults" class="hidden"></div>
                    </div>
                </div>

                <!-- Feature Landscape -->
                <div class="discovery-section">
                    <div class="discovery-section-header" onclick="toggleSection('discoveryLandscape')">
                        <h3>Feature Landscape</h3>
                        <span id="discoveryLandscape-toggle" class="section-arrow">&#9660;</span>
                    </div>
                    <div id="discoveryLandscape">
                        <div class="landscape-toolbar">
                            <select id="landscapeCategoryFilter" class="model-select-inline">
                                <option value="">All Categories</option>
                            </select>
                            <span class="toolbar-spacer"></span>
                            <span>Model:</span>
                            <select id="landscapeModel" class="model-select-inline">
                                <option value="claude-haiku-4-5-20251001">Haiku</option>
                                <option value="claude-sonnet-4-5-20250929" selected>Sonnet</option>
                                <option value="claude-opus-4-6">Opus</option>
                            </select>
                            <button class="btn btn-primary" onclick="generateFeatureLandscape()">Generate</button>
                        </div>
                        <div id="landscapeResults"></div>
                    </div>
                </div>

                <!-- Gap Analysis -->
                <div class="discovery-section">
                    <div class="discovery-section-header" onclick="toggleSection('discoveryGap')">
                        <h3>Gap Analysis</h3>
                        <span id="discoveryGap-toggle" class="section-arrow">&#9660;</span>
                    </div>
                    <div id="discoveryGap">
                        <div class="gap-toolbar">
                            <select id="gapContextSelect" class="model-select-inline">
                                <option value="">No context (best-in-class only)</option>
                            </select>
                            <span class="toolbar-spacer"></span>
                            <span>Model:</span>
                            <select id="gapModel" class="model-select-inline">
                                <option value="claude-haiku-4-5-20251001">Haiku</option>
                                <option value="claude-sonnet-4-5-20250929" selected>Sonnet</option>
                                <option value="claude-opus-4-6">Opus</option>
                            </select>
                            <button class="btn btn-primary" onclick="generateGapAnalysis()">Run Analysis</button>
                        </div>
                        <div id="gapResults"></div>
                    </div>
                </div>

                <!-- Past Analyses -->
                <div class="discovery-section">
                    <div class="discovery-section-header" onclick="toggleSection('discoveryHistory')">
                        <h3>Analysis History</h3>
                        <span id="discoveryHistory-toggle" class="section-arrow">&#9660;</span>
                    </div>
                    <div id="discoveryHistory">
                        <div id="analysisHistoryList"></div>
                    </div>
                </div>
            </section>

            <!-- Export Tab -->
            <section id="tab-export" class="tab-content" role="tabpanel" aria-label="Export">
                <div class="export-options">
                    <div class="export-card">
                        <h3>JSON</h3>
                        <p>Full structured data for programmatic use</p>
                        <a id="exportJson" href="/api/export/json" class="btn">Download JSON</a>
                    </div>
                    <div class="export-card">
                        <h3>Markdown</h3>
                        <p>LLM-optimized taxonomy for Claude / FigJam</p>
                        <a id="exportMd" href="/api/export/md" class="btn">Download Markdown</a>
                    </div>
                    <div class="export-card">
                        <h3>CSV</h3>
                        <p>Spreadsheet-compatible format</p>
                        <a id="exportCsv" href="/api/export/csv" class="btn">Download CSV</a>
                    </div>
                    <div class="export-card">
                        <h3>Excel (.xlsx)</h3>
                        <p>Formatted workbook with sheets per category</p>
                        <button class="btn" onclick="exportXlsx()">Download Excel</button>
                    </div>
                    <div class="export-card">
                        <h3>PDF Report</h3>
                        <p>Professional PDF with charts and data tables</p>
                        <button class="btn" onclick="exportFullPdf()">Download PDF</button>
                    </div>
                </div>

                <h3 class="section-heading">Share Project</h3>
                <div class="share-section">
                    <p class="hint-text">Generate a read-only share link for external stakeholders.</p>
                    <div class="share-controls">
                        <input type="text" id="shareLinkLabel" placeholder="Link label (e.g. 'For investors')">
                        <button class="primary-btn" onclick="createShareLink()">Generate Link</button>
                    </div>
                    <div id="shareTokensList"></div>
                </div>

                <h3 class="section-heading">Notification Settings</h3>
                <div class="notification-settings">
                    <p class="hint-text">Configure alerts for project events.</p>
                    <div class="notif-field">
                        <label for="slackWebhook">Slack Webhook URL</label>
                        <div class="flex-gap-xs">
                            <input type="url" id="slackWebhook" placeholder="https://hooks.slack.com/services/...">
                            <button class="btn" onclick="testSlack()">Test</button>
                        </div>
                    </div>
                    <div class="notif-checkboxes">
                        <label><input type="checkbox" id="notifBatchComplete" checked> Notify on batch complete</label>
                        <label><input type="checkbox" id="notifTaxonomyChange" checked> Notify on taxonomy changes</label>
                        <label><input type="checkbox" id="notifNewCompany"> Notify on new companies</label>
                    </div>
                    <button class="primary-btn" onclick="saveNotifPrefs()">Save Preferences</button>
                    <div id="notifSaveResult" class="hidden"></div>
                </div>

                <h3 class="section-heading">Import CSV</h3>
                <div class="import-section">
                    <p class="hint-text">Upload a CSV file with columns: name, url, what, target, products, funding, geography, tam, tags, etc.</p>
                    <form id="csvImportForm" onsubmit="importCsv(event)">
                        <input type="file" id="csvFile" accept=".csv" required>
                        <button type="submit" class="primary-btn">Import</button>
                    </form>
                    <div id="importResult" class="hidden"></div>
                </div>

                <h3 class="section-heading">Trash</h3>
                <p class="hint-text">Deleted companies can be restored or permanently removed.</p>
                <button class="btn" onclick="loadTrash()">View Trash</button>
                <div id="trashList" class="hidden"></div>

                <h3 class="section-heading">Duplicates</h3>
                <p class="hint-text">Find potential duplicate companies by URL.</p>
                <button class="btn" onclick="findDuplicates()">Scan for Duplicates</button>
                <div id="duplicatesList" class="hidden"></div>

                <h3 class="section-heading">Activity Log</h3>
                <p class="hint-text">Recent project activity and changes.</p>
                <button class="btn" onclick="loadActivity()">Load Activity</button>
                <div id="activityFeed" class="hidden"></div>
            </section>
        </div>
    </div>

    <!-- AI Chat Widget -->
    <div id="chatWidget" class="chat-widget hidden" role="complementary" aria-label="AI Chat">
        <div class="chat-header" onclick="toggleChat()">
            <span>Ask about your data</span>
            <button class="chat-close" onclick="event.stopPropagation();closeChat()" aria-label="Close chat">&times;</button>
        </div>
        <div class="chat-body" id="chatBody">
            <div class="chat-welcome">Ask questions about your taxonomy data. e.g. "Which companies focus on employer wellness?"</div>
        </div>
        <div class="chat-input-row">
            <input type="text" id="chatInput" placeholder="Ask a question..." onkeydown="if(event.key==='Enter')sendChatMessage()">
            <button class="primary-btn" onclick="sendChatMessage()">Send</button>
        </div>
    </div>
    <button id="chatToggle" class="chat-fab hidden" onclick="toggleChat()" title="AI Chat"><span class="material-symbols-outlined">chat</span></button>
    <button id="tourBtn" class="tour-fab hidden" onclick="startProductTour()" title="Product Tour">?</button>

    <!-- Edit Modal -->
    <div id="editModal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="editModalTitle">
        <div class="modal">
            <div class="modal-header">
                <h2 id="editModalTitle">Edit Company</h2>
                <button class="close-btn" onclick="closeEditModal()" aria-label="Close edit modal">&times;</button>
            </div>
            <form id="editForm" onsubmit="saveEdit(event)">
                <input type="hidden" id="editId">
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="editName">Name</label>
                        <input type="text" id="editName" required>
                    </div>
                    <div class="form-group full-width">
                        <label for="editUrl">URL</label>
                        <input type="url" id="editUrl" required>
                    </div>
                    <div class="form-group full-width">
                        <label for="editWhat">What they do</label>
                        <textarea id="editWhat" rows="2"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="editTarget">Target</label>
                        <input type="text" id="editTarget">
                    </div>
                    <div class="form-group">
                        <label for="editGeography">Geography</label>
                        <input type="text" id="editGeography">
                    </div>
                    <div class="form-group full-width">
                        <label for="editProducts">Products</label>
                        <textarea id="editProducts" rows="2"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="editFunding">Funding</label>
                        <input type="text" id="editFunding">
                    </div>
                    <div class="form-group">
                        <label for="editTam">TAM</label>
                        <input type="text" id="editTam">
                    </div>
                    <div class="form-group">
                        <label for="editEmployeeRange">Employee Range</label>
                        <select id="editEmployeeRange">
                            <option value="">-- Select --</option>
                            <option value="1-10">1-10</option>
                            <option value="11-50">11-50</option>
                            <option value="51-200">51-200</option>
                            <option value="201-500">201-500</option>
                            <option value="501-1000">501-1000</option>
                            <option value="1000+">1000+</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editFoundedYear">Founded Year</label>
                        <input type="number" id="editFoundedYear" min="1900" max="2030">
                    </div>
                    <div class="form-group">
                        <label for="editFundingStage">Funding Stage</label>
                        <select id="editFundingStage">
                            <option value="">-- Select --</option>
                            <option value="Pre-Seed">Pre-Seed</option>
                            <option value="Seed">Seed</option>
                            <option value="Series A">Series A</option>
                            <option value="Series B">Series B</option>
                            <option value="Series C+">Series C+</option>
                            <option value="Public">Public</option>
                            <option value="Bootstrapped">Bootstrapped</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editTotalFunding">Total Funding (USD)</label>
                        <input type="number" id="editTotalFunding" min="0" step="1">
                    </div>
                    <div class="form-group">
                        <label for="editHqCity">HQ City</label>
                        <input type="text" id="editHqCity">
                    </div>
                    <div class="form-group">
                        <label for="editHqCountry">HQ Country</label>
                        <input type="text" id="editHqCountry">
                    </div>
                    <div class="form-group full-width">
                        <label for="editLinkedin">LinkedIn URL</label>
                        <input type="url" id="editLinkedin" placeholder="https://linkedin.com/company/...">
                    </div>
                    <div class="form-group">
                        <label for="editCategory">Category</label>
                        <select id="editCategory" onchange="loadSubcategories()">
                            <option value="">-- Select --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editSubcategory">Subcategory</label>
                        <select id="editSubcategory">
                            <option value="">-- Select --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editBusinessModel">Business Model</label>
                        <select id="editBusinessModel">
                            <option value="">-- Select --</option>
                            <option value="B2B">B2B</option>
                            <option value="B2C">B2C</option>
                            <option value="B2B2C">B2B2C</option>
                            <option value="D2C">D2C</option>
                            <option value="Marketplace">Marketplace</option>
                            <option value="Platform">Platform</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editCompanyStage">Company Stage</label>
                        <select id="editCompanyStage">
                            <option value="">-- Select --</option>
                            <option value="Pre-launch">Pre-launch</option>
                            <option value="Early">Early</option>
                            <option value="Growth">Growth</option>
                            <option value="Mature">Mature</option>
                            <option value="Public">Public</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label for="editPrimaryFocus">Primary Focus</label>
                        <input type="text" id="editPrimaryFocus" placeholder="e.g. mental health, diagnostics, telehealth">
                    </div>
                    <div class="form-group full-width">
                        <label for="editTags">Tags (comma-separated)</label>
                        <input type="text" id="editTags" placeholder="e.g. competitor, B2B, wearable">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" onclick="closeEditModal()">Cancel</button>
                    <button type="submit" class="primary-btn">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Tag Management Modal -->
    <div id="tagModal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="tagModalTitle">
        <div class="modal modal-narrow">
            <div class="modal-header">
                <h2 id="tagModalTitle">Manage Tags</h2>
                <button class="close-btn" onclick="closeTagManager()" aria-label="Close tag manager">&times;</button>
            </div>
            <div id="tagManagerContent">
                <div class="tag-manager-actions">
                    <button class="btn" onclick="showTagRenameForm()">Rename Tag</button>
                    <button class="btn" onclick="showTagMergeForm()">Merge Tags</button>
                </div>
                <div id="tagRenameForm" class="tag-action-form hidden">
                    <input type="text" id="tagRenameOld" placeholder="Current tag name">
                    <input type="text" id="tagRenameNew" placeholder="New tag name">
                    <button class="primary-btn" onclick="executeTagRename()">Rename</button>
                    <button class="btn" onclick="hideTagForms()">Cancel</button>
                </div>
                <div id="tagMergeForm" class="tag-action-form hidden">
                    <input type="text" id="tagMergeSource" placeholder="Tag to merge (will be removed)">
                    <input type="text" id="tagMergeTarget" placeholder="Merge into this tag">
                    <button class="primary-btn" onclick="executeTagMerge()">Merge</button>
                    <button class="btn" onclick="hideTagForms()">Cancel</button>
                </div>
                <div id="tagList" class="tag-list"></div>
            </div>
        </div>
    </div>

    <!-- Template Manager Modal -->
    <div id="templateManagerModal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="templateManagerTitle">
        <div class="modal">
            <div class="modal-header">
                <h2 id="templateManagerTitle">Research Templates</h2>
                <button class="close-btn" onclick="closeTemplateManager()" aria-label="Close">&times;</button>
            </div>
            <div id="templateManagerList"></div>
            <div id="templateFormSection" class="hidden" style="margin-top:12px;padding:12px;background:var(--bg-container);border-radius:12px">
                <h4 id="templateFormTitle">New Template</h4>
                <input type="hidden" id="templateFormId">
                <input type="text" id="templateFormName" placeholder="Template name" style="width:100%;margin-bottom:8px">
                <textarea id="templateFormPrompt" rows="3" placeholder="Prompt template... Use {scope}, {company_name}, {category_name} as variables" style="width:100%;margin-bottom:8px"></textarea>
                <div style="display:flex;gap:8px">
                    <button class="primary-btn" onclick="saveTemplate()">Save</button>
                    <button class="btn" onclick="document.getElementById('templateFormSection').classList.add('hidden')">Cancel</button>
                </div>
            </div>
            <div style="margin-top:12px">
                <button class="btn" onclick="showAddTemplateForm()">+ Add Template</button>
            </div>
        </div>
    </div>

    <!-- First-Run Onboarding Overlay -->
    <div id="onboardingOverlay" class="onboarding-overlay hidden">
        <div class="onboarding-card">
            <h1>Welcome to Research Taxonomy Library</h1>
            <p>Build market taxonomies — discover, research, classify, and organize companies.</p>
            <div id="onboardingPrereqs" class="onboarding-prereqs"></div>
            <div class="onboarding-actions">
                <button class="primary-btn" onclick="onboardingCreateProject()">Create Your First Project</button>
                <button class="btn" onclick="dismissOnboarding()">Skip</button>
            </div>
        </div>
    </div>

    <!-- App Settings Modal -->
    <div id="appSettingsModal" class="modal-overlay hidden" role="dialog" aria-modal="true">
        <div class="modal modal-wide">
            <div class="modal-header">
                <h2>App Settings</h2>
                <button class="close-btn" onclick="closeAppSettings()">&times;</button>
            </div>
            <div class="settings-grid">
                <div class="settings-section">
                    <h3>LLM Configuration</h3>
                    <div class="settings-field">
                        <label for="settingLlmBackend">Backend</label>
                        <select id="settingLlmBackend" class="filter-select">
                            <option value="cli">Claude CLI (subscription)</option>
                            <option value="sdk">Anthropic SDK (API key)</option>
                        </select>
                    </div>
                    <div class="settings-field">
                        <label>API Key</label>
                        <div class="settings-api-key">
                            <span id="settingApiKeyDisplay" class="api-key-display">Not set</span>
                            <input type="password" id="settingApiKeyInput" placeholder="Enter new API key..." class="api-key-input">
                        </div>
                    </div>
                    <div class="settings-field">
                        <label for="settingDefaultModel">Default Model (Processing)</label>
                        <select id="settingDefaultModel" class="filter-select">
                            <option value="claude-haiku-4-5-20251001">Haiku (fast)</option>
                            <option value="claude-sonnet-4-5-20250929">Sonnet (balanced)</option>
                            <option value="claude-opus-4-6">Opus (powerful)</option>
                        </select>
                    </div>
                    <div class="settings-field">
                        <label for="settingResearchModel">Research Model</label>
                        <select id="settingResearchModel" class="filter-select">
                            <option value="claude-sonnet-4-5-20250929">Sonnet (balanced)</option>
                            <option value="claude-opus-4-6">Opus (powerful)</option>
                        </select>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>General</h3>
                    <label class="settings-toggle"><input type="checkbox" id="settingGitSync"> Auto-sync to Git on close</label>
                    <label class="settings-toggle"><input type="checkbox" id="settingAutoBackup"> Daily auto-backup</label>
                    <label class="settings-toggle"><input type="checkbox" id="settingUpdateCheck"> Check for updates on launch</label>
                </div>

                <div class="settings-section">
                    <h3>System Status</h3>
                    <div id="prereqStatus"></div>
                    <div class="settings-info">
                        <span>Version: <strong id="settingVersion"></strong></span>
                        <span>Data: <code id="settingDataDir" class="settings-path"></code></span>
                    </div>
                    <button class="btn btn-sm" onclick="checkForUpdates(false)" style="margin-top:8px">Check for Updates</button>
                </div>

                <div class="settings-section">
                    <h3>Backup & Restore</h3>
                    <button class="primary-btn btn-sm" onclick="createBackup()" style="margin-bottom:8px">Create Backup Now</button>
                    <div id="backupList"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeAppSettings()">Cancel</button>
                <button class="primary-btn" onclick="saveAppSettings()">Save Settings</button>
            </div>
        </div>
    </div>

    <!-- Log Viewer Modal -->
    <div id="logViewerModal" class="modal-overlay hidden" role="dialog" aria-modal="true">
        <div class="modal modal-wide">
            <div class="modal-header">
                <h2>Application Logs</h2>
                <button class="close-btn" onclick="closeLogViewer()">&times;</button>
            </div>
            <div id="logFileList" class="log-file-list"></div>
            <pre id="logContent" class="log-content"></pre>
        </div>
    </div>

    <!-- About Dialog -->
    <div id="aboutModal" class="modal-overlay hidden" role="dialog" aria-modal="true" onclick="if(event.target===this)closeAboutDialog()">
        <div class="modal modal-narrow" style="text-align:center;padding:32px">
            <h2 style="font-family:'Newsreader',serif;font-size:28px;margin-bottom:8px">Research Taxonomy Library</h2>
            <p id="aboutVersion" style="color:var(--text-muted);margin-bottom:16px">v1.0.0</p>
            <p style="font-size:13px;color:var(--text-muted)">Market research taxonomy builder with AI-powered company discovery, classification, and analysis.</p>
            <p style="font-size:12px;color:var(--text-muted);margin-top:16px">Built with Flask, SQLite, Claude &amp; Gemini</p>
            <button class="btn" onclick="closeAboutDialog()" style="margin-top:16px">Close</button>
        </div>
    </div>

    <!-- App JS modules (load order matters: core first, integrations/init last) -->
    <script src="{{ url_for('static', filename='js/core.js') }}"></script>
    <script src="{{ url_for('static', filename='js/projects.js') }}"></script>
    <script src="{{ url_for('static', filename='js/companies.js') }}"></script>
    <script src="{{ url_for('static', filename='js/taxonomy.js') }}"></script>
    <script src="{{ url_for('static', filename='js/maps.js') }}"></script>
    <script src="{{ url_for('static', filename='js/processing.js') }}"></script>
    <script src="{{ url_for('static', filename='js/filters.js') }}"></script>
    <script src="{{ url_for('static', filename='js/tags.js') }}"></script>
    <script src="{{ url_for('static', filename='js/reports.js') }}"></script>
    <script src="{{ url_for('static', filename='js/research.js') }}"></script>
    <script src="{{ url_for('static', filename='js/presentation.js') }}"></script>
    <script src="{{ url_for('static', filename='js/canvas.js') }}"></script>
    <script src="{{ url_for('static', filename='js/diagram.js') }}"></script>
    <script src="{{ url_for('static', filename='js/ai.js') }}"></script>
    <script src="{{ url_for('static', filename='js/export.js') }}"></script>
    <script src="{{ url_for('static', filename='js/settings.js') }}"></script>
    <script src="{{ url_for('static', filename='js/keyboard.js') }}"></script>
    <script src="{{ url_for('static', filename='js/sse.js') }}"></script>
    <script src="{{ url_for('static', filename='js/charts.js') }}"></script>
    <script src="{{ url_for('static', filename='js/app-settings.js') }}"></script>
    <script src="{{ url_for('static', filename='js/integrations.js') }}"></script>
    <script src="{{ url_for('static', filename='js/dimensions.js') }}"></script>
    <script src="{{ url_for('static', filename='js/discovery.js') }}"></script>
    <script src="{{ url_for('static', filename='js/init.js') }}"></script>
</body>
</html>
