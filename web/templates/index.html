<!DOCTYPE html>
{% from 'macros.html' import model_select %}
<html lang="en" data-theme="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <meta name="color-scheme" content="light dark">
    <title>Research Taxonomy Library</title>

    <!-- Fonts: Plus Jakarta Sans (UI) + JetBrains Mono (code) + Material Symbols -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet">

    <!-- App stylesheet (bundled) -->
    <link rel="stylesheet" href="{{ url_for('static', filename='dist/app.bundle.css') }}">

    <!-- ═══════════════════════════════════════════════════════════ -->
    <!-- CDN Stylesheets                                            -->
    <!-- ═══════════════════════════════════════════════════════════ -->

    <!-- Maps: Leaflet + MarkerCluster -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.css" integrity="sha384-b8ANgTJvdlAnWM5YGMpKn7Kodm+1k7NYNG9zdjTCcZcKatzYHwZ0RLdWarbJJVzU" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" integrity="sha384-pmjIAcz2bAn0xukfxADbZIb3t8oRT9Sv0rvO+BR5Csr6Dhqq+nZs59P0pPKQJkEV" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" integrity="sha384-wgw+aLYNQ7dlhK47ZPK7FRACiq7ROZwgFNg0m04avm4CaXS+Z9Y7nMu8yNjBKYC+" crossorigin="anonymous">

    <!-- Data Grid: Tabulator -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tabulator-tables@6.3.1/dist/css/tabulator_simple.min.css" integrity="sha384-V4N7xA98XpwXEziukVT23ibnUCmr8LbIxUQpT4PSUD3yp1TgQyMvrAAelVOuO0C0" crossorigin="anonymous">

    <!-- Tooltips: Tippy.js -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tippy.js@6.3.7/dist/tippy.css" integrity="sha384-IBgYl+I5X6ZDZXI5zv1vsSE3VopDomz4BxSu/GlxaPHfFtcrJ3uj70z1w6srO9zU" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tippy.js@6.3.7/themes/light-border.css" integrity="sha384-oAnSdqFEFRIeYi0SBLHb5HS5ALP/C8FjjBKFAHpjn/9cXWK3iKVrWaxJRz3t9a91" crossorigin="anonymous">

    <!-- Notifications: Notyf -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/notyf@3.10.0/notyf.min.css" integrity="sha384-snpJ3knpH6avB6cP1vPkNdmRzCYaCpom/3TNOyvo189BiogXYXQfXkyYpZ2/xADs" crossorigin="anonymous">

    <!-- UX: Driver.js (product tour) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/driver.js@1.3.1/dist/driver.css" integrity="sha384-eyrYgcjChmzD338JTHFZssgJHOqqOZbajet8yZpCw8ESroLDi28BarMEKCImNGHC" crossorigin="anonymous">

    <!-- UX: Choices.js (enhanced selects) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js@11.0.2/public/assets/styles/choices.min.css" integrity="sha384-n0GACcBzAGKp29zpmkTj4eje26AGm3wqHG9TROENrVHXySIkFf8nwmY5IgVr5qen" crossorigin="anonymous">

    <!-- Tags: Tagify -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@yaireo/tagify@4.31.3/dist/tagify.css" integrity="sha384-Usq5M9GHZHywFmpFNI+e0XtFxuS+JCFQPHBu+EyyIC5vY+WQFbJCYPCaFKSzp+gv" crossorigin="anonymous">

    <!-- Code: Highlight.js theme -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.10.0/styles/github.min.css" integrity="sha384-eFTL69TLRZTkNfYZOLM+G04821K1qZao/4QLJbet1pP4tcF+fdXq/9CdqAbWRl/L" crossorigin="anonymous">

    <!-- Date picker: Flatpickr -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.css" integrity="sha384-RkASv+6KfBMW9eknReJIJ6b3UnjKOKC5bOUaNgIY778NFbQ8MtWq9Lr/khUgqtTt" crossorigin="anonymous">

    <!-- Progress: NProgress -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.css" integrity="sha384-pwTVmaXgbbFRCYPBh1yaHpccJ0KzibGT/RTD3LUT0gjddQ1UkDxcimqlUvZaziZP" crossorigin="anonymous">

    <!-- Diff viewer: diff2html -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/diff2html@3.4.56/bundles/css/diff2html.min.css" integrity="sha384-PdRCG/+r1waybtXfuDB9Kmv2h7AGoN6WaTZ5OF+ctPeR9BGne0FaKRQnUeGV4nDL" crossorigin="anonymous">

    <!-- Component CSS included in app.bundle.css above -->

    <!-- Print styles (separate — media="print") -->
    <link rel="stylesheet" href="/static/css/print.css" media="print">

    <!-- ═══════════════════════════════════════════════════════════ -->
    <!-- CDN Scripts                                                 -->
    <!-- ═══════════════════════════════════════════════════════════ -->

    <!-- Charts & Viz -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.1/dist/echarts.min.js" defer integrity="sha384-Mx5lkUEQPM1pOJCwFtUICyX45KNojXbkWdYhkKUKsbv391mavbfoAmONbzkgYPzR" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js" defer integrity="sha384-vsrfeLOOY6KuIYKDlmVH5UiBmgIdB1oEf7p01YgWHuqmOHfZr374+odEv96n9tNC" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts-wordcloud@2.1.0/dist/echarts-wordcloud.min.js" defer integrity="sha384-U1KEY0DDCF4Dq6Yx1J+EZ5Hnj8X5bMn52OAcJB8C4OiAWeU4iJhJ/Tv5KhTqu8zZ" crossorigin="anonymous"></script>

    <!-- Graphs: Cytoscape + dagre layout extension -->
    <script src="https://cdn.jsdelivr.net/npm/cytoscape@3.30.4/dist/cytoscape.min.js" defer integrity="sha384-H3uzGzTfGHUAumB8+s4GEdfFwzAceN9wCCndN8AXubWKFIPuBSWKKtWDx7RhSf/z" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/cytoscape-dagre@2.5.0/cytoscape-dagre.js" defer integrity="sha384-u69h9ebXeSjlg6q/rb1zKTRAGu/h8deCl0409xpS/QJctMKnc4M9Fzkm01VOQdeF" crossorigin="anonymous"></script>
    <!-- fcose removed: requires cose-base dependency not available via CDN; code falls back to built-in cose layout -->

    <!-- Canvas: Excalidraw (loaded lazily via dynamic import in canvas.js) -->
    <!-- Non-blocking: loads async, swaps to "all" when ready -->
    <link rel="stylesheet" href="https://esm.sh/@excalidraw/excalidraw@0.18.0/dist/dev/index.css" media="print" onload="this.media='all'" />
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@19.0.0",
            "react/jsx-runtime": "https://esm.sh/react@19.0.0/jsx-runtime",
            "react-dom": "https://esm.sh/react-dom@19.0.0",
            "react-dom/client": "https://esm.sh/react-dom@19.0.0/client"
        }
    }
    </script>

    <!-- Maps: Leaflet + plugins (markercluster, heat, turf) -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.js" defer integrity="sha384-u5N8qJeJOO2iqNjIKTdl6KeKsEikMAmCUBPc6sC6uGpgL34aPJ4VgNhuhumedpEk" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js" defer integrity="sha384-eXVCORTRlv4FUUgS/xmOyr66XBVraen8ATNLMESp92FKXLAMiKkerixTiBvXriZr" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet.heat@0.2.0/dist/leaflet-heat.js" defer integrity="sha384-mFKkGiGvT5vo1fEyGCD3hshDdKmW3wzXW/x+fWriYJArD0R3gawT6lMvLboM22c0" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@7.1.0/turf.min.js" defer integrity="sha384-V2sTNoSKrI8N2u8kNbpZ2kJh54vI+OABRWz1t5/4m+fJuVeIoIkmILoRhQ/XRqrS" crossorigin="anonymous"></script>

    <!-- Data Grid & Search: Tabulator + Fuse.js + MiniSearch -->
    <script src="https://cdn.jsdelivr.net/npm/tabulator-tables@6.3.1/dist/js/tabulator.min.js" defer integrity="sha384-SKSq3cuuVWdfrjtLz9wNlqE0bMc903yMS5zGnFtwvfddplgxa1hywtiLyw1CbSHO" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0/dist/fuse.min.js" defer integrity="sha384-PCSoOZTpbkikBEtd/+uV3WNdc676i9KUf01KOA8CnJotvlx8rRrETbDuwdjqTYvt" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/minisearch@7.1.1/dist/umd/index.min.js" defer integrity="sha384-NaG2onw11DFACpXdRQsBdEloX/dyoVXm8MLdKo0dHSA3SGZU8R7B5IJHI4D0ofwR" crossorigin="anonymous"></script>

    <!-- Export: pdfmake -->
    <script src="https://cdn.jsdelivr.net/npm/pdfmake@0.2.18/build/pdfmake.min.js" defer integrity="sha384-PLaX7k4F4YVdUVAJKxtWURYhFKyvexLM/uv+VrBJPNluuvTrh2meFg4HNi8TDlmN" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/pdfmake@0.2.18/build/vfs_fonts.js" defer integrity="sha384-XVR3gHYz6FEUgHjf/cwpc7D8vspX/UeLi4U9tEAXKA+4cI9XqCxai33WL9TctdbG" crossorigin="anonymous"></script>
    <!-- Export: Excel (xlsx + ExcelJS) -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" defer integrity="sha384-vtjasyidUo0kW94K5MXDXntzOJpQgBKXmE7e2Ga4LG0skTTLeBi97eFAXsqewJjw" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js" defer integrity="sha384-Pqp51FUN2/qzfxZxBCtF0stpc9ONI6MYZpVqmo8m20SoaQCzf+arZvACkLkirlPz" crossorigin="anonymous"></script>
    <!-- Export: JSZip -->
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js" defer integrity="sha384-+mbV2IY1Zk/X1p/nWllGySJSUN8uMs+gUAN10Or95UBH0fpj6GfKgPmgC5EXieXG" crossorigin="anonymous"></script>
    <!-- Export: docx (Word documents) — IIFE bundle (.js extension for correct MIME) -->
    <script src="https://cdn.jsdelivr.net/npm/docx@9.1.1/dist/index.iife.js" defer crossorigin="anonymous"></script>
    <!-- Export: marked (Markdown to HTML) -->
    <script src="https://cdn.jsdelivr.net/npm/marked@15.0.4/marked.min.js" defer integrity="sha384-2NndlFAl0twi2nmu3w9mixodZFiN2fbxlakcYJF86bn1JeS1VB87/XqA7cqymzS+" crossorigin="anonymous"></script>
    <!-- Export: FileSaver.js -->
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js" defer integrity="sha384-PlRSzpewlarQuj5alIadXwjNUX+2eNMKwr0f07ShWYLy8B6TjEbm7ZlcN/ScSbwy" crossorigin="anonymous"></script>
    <!-- Export: html2canvas -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer integrity="sha384-ZZ1pncU3bQe8y31yfZdMFdSpttDoPmOZg2wguVK9almUodir1PghgT0eY7Mrty8H" crossorigin="anonymous"></script>

    <!-- Diagrams: Mermaid -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@11.12.3/dist/mermaid.min.js" defer integrity="sha384-jFhLSLFn4m565eRAS0CDMWubMqOtfZWWbE8kqgGdU+VHbJ3B2G/4X8u+0BM8MtdU" crossorigin="anonymous"></script>

    <!-- Security: DOMPurify -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.2.4/dist/purify.min.js" defer integrity="sha384-eEu5CTj3qGvu9PdJuS+YlkNi7d2XxQROAFYOr59zgObtlcux1ae1Il3u7jvdCSWu" crossorigin="anonymous"></script>

    <!-- Search & Validation: validator.js -->
    <script src="https://cdn.jsdelivr.net/npm/validator@13.12.0/validator.min.js" defer integrity="sha384-G3jMvOhKz+m+LU2WLdby9iZiZ7q9SEy45ltC1BVQg7WdaEwFeaqguod21KLhhUVM" crossorigin="anonymous"></script>

    <!-- Date Formatting: Day.js -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.13/dayjs.min.js" defer integrity="sha384-DpVxUeeBWjUvUV1czyIHJAjh+jYUZFu2lLakbdua5vbwOrBGi1UgaKCHjTC+x3Ky" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.13/plugin/relativeTime.js" defer integrity="sha384-ssUzPQXjLHLO39a9AiuwxnnyDxIvOMUxEQpqfreUaW7jLEdDAXiF6UooZRO53F6Z" crossorigin="anonymous"></script>

    <!-- Tooltips: Popper + Tippy -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" defer integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/tippy.js@6.3.7/dist/tippy-bundle.umd.min.js" defer integrity="sha384-AiTRpehQ7zqeua0Ypfa6Q4ki/ddhczZxrKtiQbTQUlJIhBkTeyoZP9/W/5ulFt29" crossorigin="anonymous"></script>

    <!-- Notifications: Notyf -->
    <script src="https://cdn.jsdelivr.net/npm/notyf@3.10.0/notyf.min.js" defer integrity="sha384-uuNfwJfjOG2ukYi4eAB11/t3lP4Zjf75a3UhgkLzEpiX8JpJfacpG7Ye+0tiVMxT" crossorigin="anonymous"></script>

    <!-- UX: Driver.js (product tour) -->
    <script src="https://cdn.jsdelivr.net/npm/driver.js@1.3.1/dist/driver.js.iife.js" defer integrity="sha384-BhR06AMz62Xn0o53z8itVS1vw4JslNckRFgOTa6/Dob0Agdmbbh8Dr9sDO2h18TO" crossorigin="anonymous"></script>

    <!-- UX: Choices.js (enhanced selects) -->
    <script src="https://cdn.jsdelivr.net/npm/choices.js@11.0.2/public/assets/scripts/choices.min.js" defer integrity="sha384-RW4gs5EBMnvixdJOoWLeT/qJSVHjMQOOwwxMSGVlEzuuuPWm9WVTDYPspqVrYBds" crossorigin="anonymous"></script>

    <!-- UX: Lucide icons -->
    <script src="https://cdn.jsdelivr.net/npm/lucide@0.469.0/dist/umd/lucide.min.js" defer integrity="sha384-hJnF5AwidE18GSWTAGHv3ByzzvfNZ1Tcx5y1UUV3WkauuMCEzBJBMSwSt/PUPXnM" crossorigin="anonymous"></script>

    <!-- UX: ninja-keys (command palette web component — ESM-only) -->
    <!-- Dynamic import so it does NOT block DOMContentLoaded or window.onload -->
    <script>
        import('https://esm.sh/ninja-keys@1.2.2?bundle').catch(function() {
            console.warn('ninja-keys: CDN unavailable');
        });
    </script>

    <!-- UX: SortableJS (drag and drop) -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.6/Sortable.min.js" defer integrity="sha384-HZZ/fukV+9G8gwTNjN7zQDG0Sp7MsZy5DDN6VfY3Be7V9dvQpEpR2jF2HlyFUUjU" crossorigin="anonymous"></script>

    <!-- UX: Floating UI (positioning engine) -->
    <script src="https://cdn.jsdelivr.net/npm/@floating-ui/core@1.6.3/dist/floating-ui.core.umd.min.js" defer integrity="sha384-SJoIIKe0fXtNSiN8+suBrlO3s7ddOATC1q0v9dbaGZN8/tYjo5XmqEYxHpI+jIqY" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@floating-ui/dom@1.6.3/dist/floating-ui.dom.umd.min.js" defer integrity="sha384-rTc0ZbbIMupXXE93GPQiOve/8y8pMmPvlOUT0SloHezzPddhsU3tjC0SX2D9sslf" crossorigin="anonymous"></script>

    <!-- Tags: Tagify -->
    <script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify@4.31.3/dist/tagify.min.js" defer integrity="sha384-324Co8zgQ3kU3YG6V9d0O50pPQ/JcLdIPKDwy+mE1x8RfJx9ZcFtV6HzXSCbMctR" crossorigin="anonymous"></script>

    <!-- Animation: Motion -->
    <script src="https://cdn.jsdelivr.net/npm/motion@11.16.0/dist/motion.js" defer integrity="sha384-YG7y+J5y8spBFifQi8cS5n5YYDVgEhFJv5CYNiA3f2NXeHGfDtJxl3Yp/MBU9Cp8" crossorigin="anonymous"></script>

    <!-- Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js" defer integrity="sha384-Rv68Y7adOjMMJc1/xFMcdNvXre/HF51to4GZjBALmXr7ABnVl5V4UajJwBu7zbhN" crossorigin="anonymous"></script>

    <!-- Keyboard Shortcuts: hotkeys-js -->
    <script src="https://cdn.jsdelivr.net/npm/hotkeys-js@3.13.9/dist/hotkeys.min.js" defer integrity="sha384-53hNeodlih94YLqSA2jxctko3qeoj8OKosYoL8p9uS39KKKz7JneDiLCIK1E8bUY" crossorigin="anonymous"></script>

    <!-- Code Syntax Highlighting (browser build) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/highlight.min.js" defer integrity="sha384-GdEWAbCjn+ghjX0gLx7/N1hyTVmPAjdC2OvoAA0RyNcAOhqwtT8qnbCxWle2+uJX" crossorigin="anonymous"></script>

    <!-- Auto-expanding Textareas -->
    <script src="https://cdn.jsdelivr.net/npm/autosize@6.0.1/dist/autosize.min.js" defer integrity="sha384-Q9KD03bmEL9H3t9KOxcdN2YplobIplv9iv7srJG5fI9U22Pw0uvKgHwtI32TTG3U" crossorigin="anonymous"></script>

    <!-- Click-to-Zoom Images -->
    <script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" defer integrity="sha384-o0gqi06am9fKVfa/jWO8/UE7OxHG6t+fgq/XaASsuwT8OBsFcxN7YhjtqyTfIxtS" crossorigin="anonymous"></script>

    <!-- Date Range Picker: Flatpickr -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js" defer integrity="sha384-5JqMv4L/Xa0hfvtF06qboNdhvuYXUku9ZrhZh3bSk8VXF0A/RuSLHpLsSV9Zqhl6" crossorigin="anonymous"></script>

    <!-- Progress: NProgress -->
    <script src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.js" defer integrity="sha384-Khp+WGU135XsFuEWvnA1WVJNvQ7T6CI9uxs+8RZes7B2JOmM5kjifb3AJ6V3JxY8" crossorigin="anonymous"></script>

    <!-- Diff viewer: diff2html -->
    <script src="https://cdn.jsdelivr.net/npm/diff2html@3.4.56/bundles/js/diff2html.min.js" defer integrity="sha384-X6/ZXflvpFfCMcPkCC2/ydjb6KJqTsoQq2eGjzB5LfWgXs3VsjbfaEKKVWsfQIAy" crossorigin="anonymous"></script>

    <!-- Resizable Panes: Split.js -->
    <script src="https://cdn.jsdelivr.net/npm/split.js@1.6.5/dist/split.min.js" defer integrity="sha384-q2ksSc8z6Q4ZUnxlfZj9AXZLpSdWmD3q/YrId1twTeNHh56fNh98YbJSpppzGUvL" crossorigin="anonymous"></script>

    <!-- Currency formatting -->
    <script src="https://cdn.jsdelivr.net/npm/currency.js@2.0.4/dist/currency.min.js" defer integrity="sha384-rvtOlmtdaQlETnn9WzuLmsk2dRrRmmavPGSnHVDWwXkUkN9ZB+APb+LX/7AVJCIV" crossorigin="anonymous"></script>

    <!-- Search result highlighting: mark.js -->
    <script src="https://cdn.jsdelivr.net/npm/mark.js@8.11.1/dist/mark.min.js" defer integrity="sha384-t9DGTa+HJ3fETmsPZ37+56VRxK0NsOgFTQ1B4fxaxA+BM48rM5oXrg0/ncF/B3VX" crossorigin="anonymous"></script>

    <!-- QR Code generation -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js" defer integrity="sha384-lQXOAyZwHXE55JFyrOMB7nY2Wv+m5ZWNtJcHrd1rceRQXAYNLak8ukN5TjBTcIwz" crossorigin="anonymous"></script>

    <!-- Hand-drawn annotations: Rough Notation -->
    <script src="https://cdn.jsdelivr.net/npm/rough-notation@0.5.1/lib/rough-notation.iife.js" defer integrity="sha384-IW2mAEaBUcGJfuKi7uhlzpZGhnDDnjI9NLtADxl9xKV6VJPzuuIqhIKyLwiAuRmu" crossorigin="anonymous"></script>

    <!-- Pan & zoom for any element -->
    <script src="https://cdn.jsdelivr.net/npm/@panzoom/panzoom@4.5.1/dist/panzoom.min.js" defer integrity="sha384-ZOYffjPUyf23W5DufkQVkrN7uZvIMRRCPo64S2N2S0mFM9+bFZpn2/MQTy2O35gF" crossorigin="anonymous"></script>
</head>
<body>
    <a href="#mainApp" class="skip-link">Skip to main content</a>

    <!-- Connection loss banner -->
    <div id="connectionBanner" class="connection-banner hidden" role="alert">
        <span class="connection-banner-icon"><span class="material-symbols-outlined">warning</span></span>
        <span>Connection lost — retrying...</span>
        <button onclick="location.reload()" class="connection-banner-btn">Reload</button>
    </div>

    <!-- Offline banner -->
    <div id="offlineBanner" class="connection-banner hidden" role="alert">
        <span class="connection-banner-icon"><span class="material-symbols-outlined">wifi_off</span></span>
        <span>You're offline — AI features are disabled. Data browsing still works.</span>
    </div>

    <!-- Update available banner -->
    <div id="updateBanner" class="update-banner hidden" role="status">
        <span class="material-symbols-outlined">system_update</span>
        <span>Update available: <strong id="updateVersion"></strong></span>
        <a id="updateLink" href="#" target="_blank" class="btn btn-sm update-link">Download</a>
        <button class="update-dismiss" onclick="dismissUpdateBanner()" aria-label="Dismiss update banner">&times;</button>
    </div>

    <!-- Keyboard shortcuts overlay -->
    <div id="shortcutsOverlay" class="shortcuts-overlay hidden" onclick="if(event.target===this)toggleShortcutsOverlay()">
        <div class="shortcuts-panel">
            <div class="shortcuts-header">
                <h2>Keyboard Shortcuts</h2>
                <button onclick="toggleShortcutsOverlay()" aria-label="Close shortcuts">&times;</button>
            </div>
            <div class="shortcuts-grid">
                <div class="shortcut-section">
                    <h3>Navigation</h3>
                    <div class="shortcut-row"><kbd>1</kbd>–<kbd>6</kbd> <span>Switch tabs</span></div>
                    <div class="shortcut-row"><kbd>/</kbd> <span>Focus search</span></div>
                    <div class="shortcut-row"><kbd>j</kbd> / <kbd>k</kbd> <span>Navigate rows</span></div>
                    <div class="shortcut-row"><kbd>Enter</kbd> <span>Open selected</span></div>
                    <div class="shortcut-row"><kbd>Esc</kbd> <span>Close panel/modal</span></div>
                </div>
                <div class="shortcut-section">
                    <h3>Actions</h3>
                    <div class="shortcut-row"><kbd>&#8984;K</kbd> <span>Quick search</span></div>
                    <div class="shortcut-row"><kbd>&#8984;E</kbd> <span>Export Excel</span></div>
                    <div class="shortcut-row"><kbd>&#8984;&#8679;P</kbd> <span>Export PDF</span></div>
                    <div class="shortcut-row"><kbd>?</kbd> <span>This overlay</span></div>
                </div>
                <div class="shortcut-section">
                    <h3>Views</h3>
                    <div class="shortcut-row"><kbd>g</kbd> <span>Geographic map (in Map tab)</span></div>
                    <div class="shortcut-row"><kbd>t</kbd> <span>Graph view (in Taxonomy tab)</span></div>
                </div>
            </div>
        </div>
    </div>

    <div class="container" role="main">
        <!-- ========== Project Selection Screen ========== -->
        <div id="projectSelection">
            <div class="titlebar-region">
                <header>
                    <div class="flex-between">
                        <div>
                            <h1>Research Taxonomy Library</h1>
                            <p class="header-subtitle">Select a research project or create a new one.</p>
                        </div>
                        <div class="flex-gap-sm">
                            <button class="icon-btn" onclick="openAppSettings()" title="Settings" aria-label="App settings"><span class="material-symbols-outlined">settings</span></button>
                            <button class="theme-toggle" onclick="toggleTheme()" title="Toggle dark mode (D)" aria-label="Toggle dark mode"><span class="material-symbols-outlined">dark_mode</span></button>
                        </div>
                    </div>
                </header>
            </div>
            <div id="projectGrid" class="project-grid" role="list" aria-label="Research projects"></div>
        </div>

        <!-- ========== New Project Form ========== -->
        <div id="newProjectForm" class="hidden">
            <header>
                <div class="header-with-back">
                    <button class="back-btn" onclick="showProjectSelection()" aria-label="Back to projects">&larr;</button>
                    <h1>New Research Project</h1>
                </div>
            </header>
            <form onsubmit="createProject(event)">
                <div class="new-project-form">
                    <div class="form-group full-width">
                        <label for="npName">Project Name *</label>
                        <input type="text" id="npName" required placeholder="e.g. Aesthetic Design Connections">
                    </div>
                    <div class="form-group full-width">
                        <label for="npPurpose">Purpose *</label>
                        <textarea id="npPurpose" rows="3" required placeholder="What is this research for? What question are you trying to answer?"></textarea>
                    </div>
                    <div class="form-group full-width">
                        <label for="npOutcome">Expected Outcome</label>
                        <textarea id="npOutcome" rows="2" placeholder="What deliverable will this produce? e.g. FigJam board, market map, report"></textarea>
                    </div>

                    <!-- Schema Template Picker -->
                    <div class="form-group full-width">
                        <label>Research Template</label>
                        <div id="templatePicker" class="template-picker">
                            <!-- Populated by JS -->
                        </div>
                        <input type="hidden" id="npTemplate" value="blank">
                    </div>

                    <!-- Schema Preview -->
                    <div id="schemaPreview" class="schema-preview hidden">
                        <h3 class="section-label">SCHEMA PREVIEW</h3>
                        <div id="schemaPreviewContent"></div>
                    </div>

                    <!-- AI Schema Suggestion -->
                    <div class="form-group full-width">
                        <label>AI Schema Suggestion</label>
                        <p class="form-hint">Describe your research and AI will propose entity types and attributes.</p>
                        <div class="ai-suggest-row">
                            <textarea id="npAiDescription" rows="2" placeholder="e.g. I want to compare pet insurance products across UK providers, focusing on coverage tiers, pricing, and exclusions"></textarea>
                            <button type="button" class="btn" id="aiSuggestBtn" onclick="suggestSchema()">Suggest Schema</button>
                        </div>
                        <div id="aiSuggestStatus" class="hidden"></div>
                    </div>

                    <div class="form-group full-width">
                        <label for="npCategories">Starting Categories *</label>
                        <textarea id="npCategories" rows="3" required placeholder="Enter category names, one per line. These seed the initial taxonomy structure."></textarea>
                    </div>
                    <div class="form-group full-width">
                        <label for="npLinks">Example Links</label>
                        <textarea id="npLinks" rows="4" placeholder="Paste example URLs that represent the type of companies/products you're researching (one per line)"></textarea>
                    </div>
                    <div class="form-group full-width">
                        <label for="npKeywords">Market Keywords</label>
                        <input type="text" id="npKeywords" placeholder="Comma-separated keywords for triage relevance. e.g. design, aesthetic, visual, art, creative">
                    </div>
                    <div class="form-group full-width">
                        <label for="npDescription">Description</label>
                        <textarea id="npDescription" rows="3" placeholder="Any additional context or notes about this research project"></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="primary-btn">Create Project</button>
                        <button type="button" class="btn" onclick="showProjectSelection()">Cancel</button>
                    </div>
                </div>
            </form>
        </div>

        <!-- ========== Main App (shown after project selection) ========== -->
        <div id="mainApp" class="hidden">
            <div class="titlebar-region">
                <header>
                    <div class="flex-between">
                        <div class="header-with-back">
                            <button class="back-btn" onclick="switchProject()" aria-label="Switch project">&larr;</button>
                            <div>
                                <h1 id="projectTitle">Project</h1>
                                <div class="stats-bar">
                                    <span id="statCompanies">0 companies</span>
                                    <span id="statCategories">0 categories</span>
                                    <span id="statUpdated">Never updated</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex-center-gap">
                            <button class="notification-bell" onclick="toggleNotificationPanel()" title="Notifications" aria-label="Toggle notifications" aria-expanded="false" aria-controls="notificationPanel">
                                <span class="bell-icon" aria-hidden="true"><span class="material-symbols-outlined">notifications</span></span>
                                <span class="bell-badge hidden" id="bellBadge" aria-live="polite">0</span>
                            </button>
                            <button class="theme-toggle" onclick="toggleTheme()" title="Toggle dark mode (D)" aria-label="Toggle dark mode"><span class="material-symbols-outlined">dark_mode</span></button>
                        </div>
                    </div>
                </header>

                <nav class="tabs" role="tablist" aria-label="Main navigation">
                    <!-- Primary workbench tabs (guided workflow order) -->
                    <button class="tab active" role="tab" aria-selected="true" aria-controls="tab-reports" data-tab="reports" onclick="showTab('reports')">Research</button>
                    <button class="tab" role="tab" aria-selected="false" aria-controls="tab-process" data-tab="process" onclick="showTab('process')">Process</button>
                    <button class="tab" role="tab" aria-selected="false" aria-controls="tab-review" data-tab="review" onclick="showTab('review')">Review</button>
                    <button class="tab" role="tab" aria-selected="false" aria-controls="tab-analysis" data-tab="analysis" onclick="showTab('analysis')">Analysis</button>
                    <button class="tab" role="tab" aria-selected="false" aria-controls="tab-intelligence" data-tab="intelligence" onclick="showTab('intelligence')">Intelligence</button>
                    <button class="tab" role="tab" aria-selected="false" aria-controls="tab-export" data-tab="export" onclick="showTab('export')">Export</button>
                    <!-- Hidden tabs -->
                    <button class="tab hidden" role="tab" aria-selected="false" aria-controls="tab-discovery" data-tab="discovery" onclick="showTab('discovery')" id="discoveryTabBtn">Discovery</button>
                    <!-- Spacer pushes Tools + Settings to right -->
                    <div class="tab-spacer" aria-hidden="true"></div>
                    <!-- Tools dropdown for legacy tabs -->
                    <div class="tools-dropdown" role="none">
                        <button class="tab tools-trigger" id="toolsTrigger" aria-haspopup="true" aria-expanded="false" onclick="toggleToolsDropdown(event)">Tools <span class="tools-caret" aria-hidden="true">&#9662;</span></button>
                        <div class="tools-menu hidden" id="toolsMenu" role="menu" aria-label="Legacy tools">
                            <button class="tools-menu-item" role="menuitem" data-tab="companies" onclick="showTab('companies'); closeToolsDropdown()">Companies</button>
                            <button class="tools-menu-item" role="menuitem" data-tab="taxonomy" onclick="showTab('taxonomy'); closeToolsDropdown()">Taxonomy</button>
                            <button class="tools-menu-item" role="menuitem" data-tab="map" onclick="showTab('map'); closeToolsDropdown()">Map</button>
                            <button class="tools-menu-item" role="menuitem" data-tab="canvas" onclick="showTab('canvas'); closeToolsDropdown()">Canvas</button>
                        </div>
                    </div>
                    <!-- Settings gear icon -->
                    <button class="tab tab-icon" role="tab" aria-selected="false" aria-controls="tab-settings" data-tab="settings" onclick="showTab('settings')" title="Settings" aria-label="Settings"><span class="material-symbols-outlined">settings</span></button>
                </nav>
            </div>

            <!-- Notification Panel -->
            <div id="notificationPanel" class="notification-panel hidden">
                <div class="notif-panel-header">
                    <strong>Recent Activity</strong>
                    <button class="close-btn" onclick="toggleNotificationPanel()" aria-label="Close notifications">&times;</button>
                </div>
                <div id="notifPanelContent" class="notif-panel-content">
                    <p class="hint-text">No recent activity.</p>
                </div>
            </div>

            <!-- Breadcrumb Navigation -->
            <div id="breadcrumbBar" class="breadcrumb-bar hidden"></div>

            <!-- Companies Tab (lazy-loaded) -->
            <section id="tab-companies" class="tab-content" role="tabpanel" aria-label="Companies"></section>

            <!-- Taxonomy Tab (lazy-loaded) -->
            <section id="tab-taxonomy" class="tab-content" role="tabpanel" aria-label="Taxonomy"></section>

            <!-- Map Tab (lazy-loaded) -->
            <section id="tab-map" class="tab-content" role="tabpanel" aria-label="Map"></section>

            <!-- Research Tab (pre-loaded — default tab) -->
            <section id="tab-reports" class="tab-content active" role="tabpanel" aria-label="Research">
                {% include 'partials/tab-reports.html' %}
            </section>

            <!-- Canvas Tab (lazy-loaded) -->
            <section id="tab-canvas" class="tab-content" role="tabpanel" aria-label="Canvas"></section>

            <!-- Process Tab (lazy-loaded) -->
            <section id="tab-process" class="tab-content" role="tabpanel" aria-label="Process"></section>

            <!-- Review Tab (lazy-loaded) -->
            <section id="tab-review" class="tab-content" role="tabpanel" aria-label="Review"></section>

            <!-- Discovery Tab (lazy-loaded) -->
            <section id="tab-discovery" class="tab-content" role="tabpanel" aria-label="Discovery"></section>

            <!-- Analysis Tab (lazy-loaded) -->
            <section id="tab-analysis" class="tab-content" role="tabpanel" aria-label="Analysis"></section>

            <!-- Intelligence Tab (lazy-loaded) -->
            <section id="tab-intelligence" class="tab-content" role="tabpanel" aria-label="Intelligence"></section>

            <!-- Export Tab (lazy-loaded) -->
            <section id="tab-export" class="tab-content" role="tabpanel" aria-label="Export"></section>

            <!-- Settings Tab (lazy-loaded) -->
            <section id="tab-settings" class="tab-content" role="tabpanel" aria-label="Settings"></section>
        </div>
    </div>
    <!-- AI Chat Widget -->
    <div id="chatWidget" class="chat-widget hidden" role="complementary" aria-label="AI Chat">
        <div class="chat-header" onclick="toggleChat()">
            <span>Ask about your data</span>
            <button class="chat-close" onclick="event.stopPropagation();closeChat()" aria-label="Close chat">&times;</button>
        </div>
        <div class="chat-body" id="chatBody">
            <div class="chat-welcome">Ask questions about your taxonomy data. e.g. "Which companies focus on employer wellness?"</div>
        </div>
        <div class="chat-input-row">
            <input type="text" id="chatInput" placeholder="Ask a question..." onkeydown="if(event.key==='Enter')sendChatMessage()" aria-label="Chat message">
            <button class="primary-btn" onclick="sendChatMessage()">Send</button>
        </div>
    </div>
    <button id="chatToggle" class="chat-fab hidden" onclick="toggleChat()" title="AI Chat" aria-label="AI Chat"><span class="material-symbols-outlined">chat</span></button>
    <button id="tourBtn" class="tour-fab hidden" onclick="startProductTour()" title="Product Tour" aria-label="Product Tour">?</button>

    <!-- Edit Modal -->
    <div id="editModal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="editModalTitle">
        <div class="modal">
            <div class="modal-header">
                <h2 id="editModalTitle">Edit Company</h2>
                <button class="close-btn" onclick="closeEditModal()" aria-label="Close edit modal">&times;</button>
            </div>
            <form id="editForm" onsubmit="saveEdit(event)">
                <input type="hidden" id="editId">
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="editName">Name</label>
                        <input type="text" id="editName" required>
                    </div>
                    <div class="form-group full-width">
                        <label for="editUrl">URL</label>
                        <input type="url" id="editUrl" required>
                    </div>
                    <div class="form-group full-width">
                        <label for="editWhat">What they do</label>
                        <textarea id="editWhat" rows="2"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="editTarget">Target</label>
                        <input type="text" id="editTarget">
                    </div>
                    <div class="form-group">
                        <label for="editGeography">Geography</label>
                        <input type="text" id="editGeography">
                    </div>
                    <div class="form-group full-width">
                        <label for="editProducts">Products</label>
                        <textarea id="editProducts" rows="2"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="editFunding">Funding</label>
                        <input type="text" id="editFunding">
                    </div>
                    <div class="form-group">
                        <label for="editTam">TAM</label>
                        <input type="text" id="editTam">
                    </div>
                    <div class="form-group">
                        <label for="editEmployeeRange">Employee Range</label>
                        <select id="editEmployeeRange">
                            <option value="">-- Select --</option>
                            <option value="1-10">1-10</option>
                            <option value="11-50">11-50</option>
                            <option value="51-200">51-200</option>
                            <option value="201-500">201-500</option>
                            <option value="501-1000">501-1000</option>
                            <option value="1000+">1000+</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editFoundedYear">Founded Year</label>
                        <input type="number" id="editFoundedYear" min="1900" max="2030">
                    </div>
                    <div class="form-group">
                        <label for="editFundingStage">Funding Stage</label>
                        <select id="editFundingStage">
                            <option value="">-- Select --</option>
                            <option value="Pre-Seed">Pre-Seed</option>
                            <option value="Seed">Seed</option>
                            <option value="Series A">Series A</option>
                            <option value="Series B">Series B</option>
                            <option value="Series C+">Series C+</option>
                            <option value="Public">Public</option>
                            <option value="Bootstrapped">Bootstrapped</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editTotalFunding">Total Funding (USD)</label>
                        <input type="number" id="editTotalFunding" min="0" step="1">
                    </div>
                    <div class="form-group">
                        <label for="editHqCity">HQ City</label>
                        <input type="text" id="editHqCity">
                    </div>
                    <div class="form-group">
                        <label for="editHqCountry">HQ Country</label>
                        <input type="text" id="editHqCountry">
                    </div>
                    <div class="form-group full-width">
                        <label for="editLinkedin">LinkedIn URL</label>
                        <input type="url" id="editLinkedin" placeholder="https://linkedin.com/company/...">
                    </div>
                    <div class="form-group">
                        <label for="editCategory">Category</label>
                        <select id="editCategory" onchange="loadSubcategories()">
                            <option value="">-- Select --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editSubcategory">Subcategory</label>
                        <select id="editSubcategory">
                            <option value="">-- Select --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editBusinessModel">Business Model</label>
                        <select id="editBusinessModel">
                            <option value="">-- Select --</option>
                            <option value="B2B">B2B</option>
                            <option value="B2C">B2C</option>
                            <option value="B2B2C">B2B2C</option>
                            <option value="D2C">D2C</option>
                            <option value="Marketplace">Marketplace</option>
                            <option value="Platform">Platform</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editCompanyStage">Company Stage</label>
                        <select id="editCompanyStage">
                            <option value="">-- Select --</option>
                            <option value="Pre-launch">Pre-launch</option>
                            <option value="Early">Early</option>
                            <option value="Growth">Growth</option>
                            <option value="Mature">Mature</option>
                            <option value="Public">Public</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label for="editPrimaryFocus">Primary Focus</label>
                        <input type="text" id="editPrimaryFocus" placeholder="e.g. mental health, diagnostics, telehealth">
                    </div>
                    <div class="form-group full-width">
                        <label for="editTags">Tags (comma-separated)</label>
                        <input type="text" id="editTags" placeholder="e.g. competitor, B2B, wearable">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" onclick="closeEditModal()">Cancel</button>
                    <button type="submit" class="primary-btn">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Tag Management Modal -->
    <div id="tagModal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="tagModalTitle">
        <div class="modal modal-narrow">
            <div class="modal-header">
                <h2 id="tagModalTitle">Manage Tags</h2>
                <button class="close-btn" onclick="closeTagManager()" aria-label="Close tag manager">&times;</button>
            </div>
            <div id="tagManagerContent">
                <div class="tag-manager-actions">
                    <button class="btn" onclick="showTagRenameForm()">Rename Tag</button>
                    <button class="btn" onclick="showTagMergeForm()">Merge Tags</button>
                </div>
                <div id="tagRenameForm" class="tag-action-form hidden">
                    <input type="text" id="tagRenameOld" placeholder="Current tag name">
                    <input type="text" id="tagRenameNew" placeholder="New tag name">
                    <button class="primary-btn" onclick="executeTagRename()">Rename</button>
                    <button class="btn" onclick="hideTagForms()">Cancel</button>
                </div>
                <div id="tagMergeForm" class="tag-action-form hidden">
                    <input type="text" id="tagMergeSource" placeholder="Tag to merge (will be removed)">
                    <input type="text" id="tagMergeTarget" placeholder="Merge into this tag">
                    <button class="primary-btn" onclick="executeTagMerge()">Merge</button>
                    <button class="btn" onclick="hideTagForms()">Cancel</button>
                </div>
                <div id="tagList" class="tag-list"></div>
            </div>
        </div>
    </div>

    <!-- Template Manager Modal -->
    <div id="templateManagerModal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="templateManagerTitle">
        <div class="modal">
            <div class="modal-header">
                <h2 id="templateManagerTitle">Research Templates</h2>
                <button class="close-btn" onclick="closeTemplateManager()" aria-label="Close">&times;</button>
            </div>
            <div id="templateManagerList"></div>
            <div id="templateFormSection" class="hidden template-form-section">
                <h4 id="templateFormTitle">New Template</h4>
                <input type="hidden" id="templateFormId">
                <input type="text" id="templateFormName" placeholder="Template name" class="template-form-field">
                <textarea id="templateFormPrompt" rows="3" placeholder="Prompt template... Use {scope}, {company_name}, {category_name} as variables" class="template-form-field"></textarea>
                <div class="template-form-buttons">
                    <button class="primary-btn" onclick="saveTemplate()">Save</button>
                    <button class="btn" onclick="document.getElementById('templateFormSection').classList.add('hidden')">Cancel</button>
                </div>
            </div>
            <div class="template-add-row">
                <button class="btn" onclick="showAddTemplateForm()">+ Add Template</button>
            </div>
        </div>
    </div>

    <!-- First-Run Onboarding Overlay -->
    <div id="onboardingOverlay" class="onboarding-overlay hidden">
        <div class="onboarding-card">
            <h1>Welcome to Research Taxonomy Library</h1>
            <p>Build market taxonomies — discover, research, classify, and organize companies.</p>
            <div id="onboardingPrereqs" class="onboarding-prereqs"></div>
            <div class="onboarding-actions">
                <button class="primary-btn" onclick="onboardingCreateProject()">Create Your First Project</button>
                <button class="btn" onclick="dismissOnboarding()">Skip</button>
            </div>
        </div>
    </div>

    <!-- App Settings Modal -->
    <div id="appSettingsModal" class="modal-overlay hidden" role="dialog" aria-modal="true">
        <div class="modal modal-wide">
            <div class="modal-header">
                <h2>App Settings</h2>
                <button class="close-btn" onclick="closeAppSettings()" aria-label="Close app settings">&times;</button>
            </div>
            <div class="settings-grid">
                <div class="settings-section">
                    <h3>LLM Configuration</h3>
                    <div class="settings-field">
                        <label for="settingLlmBackend">Backend</label>
                        <select id="settingLlmBackend" class="filter-select">
                            <option value="cli">Claude CLI (subscription)</option>
                            <option value="sdk">Anthropic SDK (API key)</option>
                        </select>
                    </div>
                    <div class="settings-field">
                        <label>API Key</label>
                        <div class="settings-api-key">
                            <span id="settingApiKeyDisplay" class="api-key-display">Not set</span>
                            <input type="password" id="settingApiKeyInput" placeholder="Enter new API key..." class="api-key-input">
                        </div>
                    </div>
                    <div class="settings-field">
                        <label for="settingDefaultModel">Default Model (Processing)</label>
                        <select id="settingDefaultModel" class="filter-select">
                            <option value="claude-haiku-4-5-20251001">Haiku (fast)</option>
                            <option value="claude-sonnet-4-5-20250929">Sonnet (balanced)</option>
                            <option value="claude-opus-4-6">Opus (powerful)</option>
                        </select>
                    </div>
                    <div class="settings-field">
                        <label for="settingResearchModel">Research Model</label>
                        <select id="settingResearchModel" class="filter-select">
                            <option value="claude-sonnet-4-5-20250929">Sonnet (balanced)</option>
                            <option value="claude-opus-4-6">Opus (powerful)</option>
                        </select>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>General</h3>
                    <label class="settings-toggle"><input type="checkbox" id="settingGitSync"> Auto-sync to Git on close</label>
                    <label class="settings-toggle"><input type="checkbox" id="settingAutoBackup"> Daily auto-backup</label>
                    <label class="settings-toggle"><input type="checkbox" id="settingUpdateCheck"> Check for updates on launch</label>
                </div>

                <div class="settings-section">
                    <h3>System Status</h3>
                    <div id="prereqStatus"></div>
                    <div class="settings-info">
                        <span>Version: <strong id="settingVersion"></strong></span>
                        <span>Data: <code id="settingDataDir" class="settings-path"></code></span>
                    </div>
                    <button class="btn btn-sm" onclick="checkForUpdates(false)" class="settings-btn-mt">Check for Updates</button>
                </div>

                <div class="settings-section">
                    <h3>Backup & Restore</h3>
                    <button class="primary-btn btn-sm" onclick="createBackup()" class="settings-btn-mb">Create Backup Now</button>
                    <div id="backupList"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeAppSettings()">Cancel</button>
                <button class="primary-btn" onclick="saveAppSettings()">Save Settings</button>
            </div>
        </div>
    </div>

    <!-- Log Viewer Modal -->
    <div id="logViewerModal" class="modal-overlay hidden" role="dialog" aria-modal="true">
        <div class="modal modal-wide">
            <div class="modal-header">
                <h2>Application Logs</h2>
                <button class="close-btn" onclick="closeLogViewer()" aria-label="Close log viewer">&times;</button>
            </div>
            <div id="logFileList" class="log-file-list"></div>
            <pre id="logContent" class="log-content"></pre>
        </div>
    </div>

    <!-- About dialog -->
    <div id="aboutModal" class="modal hidden" role="dialog" aria-labelledby="aboutTitle" aria-modal="true">
      <div class="modal-content about-modal-content">
        <div class="about-dialog">
          <div class="app-icon about-icon">RT</div>
          <div id="aboutTitle" class="app-name about-name">Research Taxonomy Library</div>
          <div class="app-version about-ver" id="aboutVersion">Version loading...</div>
          <div class="about-content">
            <div>AI-powered market research &amp; taxonomy builder</div>
            <div class="about-tech">Python <span id="aboutPython"></span> / Flask / SQLite</div>
            <div class="about-tech">Claude AI / Gemini AI</div>
          </div>
          <div class="app-copyright">&copy; 2024-2026</div>
          <div class="mt-4">
            <button class="btn btn-secondary about-ok" onclick="closeAboutDialog()">OK</button>
          </div>
        </div>
      </div>
    </div>

    <!-- App JS (bundled — core.js first, init.js last) -->
    <script src="{{ url_for('static', filename='dist/app.bundle.js') }}"></script>

    <script>
      // Prevent pinch-zoom (native apps don't zoom)
      document.addEventListener('wheel', function(e) {
        if (e.ctrlKey) { e.preventDefault(); }
      }, { passive: false });
    </script>

    <!-- Confirmation sheet -->
    <div id="confirmSheet" class="confirm-sheet-overlay" style="display:none;">
      <div class="confirm-sheet">
        <div id="confirmSheetIcon" class="confirm-sheet-icon danger">&#9888;</div>
        <div id="confirmSheetTitle" class="confirm-sheet-title">Are you sure?</div>
        <div id="confirmSheetMessage" class="confirm-sheet-message">This action cannot be undone.</div>
        <div class="confirm-sheet-actions">
          <button id="confirmSheetConfirm" class="confirm-btn-danger">Delete</button>
          <button id="confirmSheetCancel" class="confirm-btn-cancel">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Prompt/input sheet (for pywebview where prompt() is blocked) -->
    <div id="promptSheet" class="confirm-sheet-overlay" style="display:none;">
      <div class="confirm-sheet">
        <div id="promptSheetTitle" class="confirm-sheet-title">Enter a name</div>
        <input id="promptSheetInput" type="text" class="prompt-sheet-input" autocomplete="off" />
        <div class="confirm-sheet-actions confirm-sheet-actions-mt">
          <button id="promptSheetConfirm" class="confirm-btn-primary">Create</button>
          <button id="promptSheetCancel" class="confirm-btn-cancel">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Command palette (ninja-keys web component) -->
    <ninja-keys id="commandPalette" placeholder="Type a command..." hideBreadcrumbs></ninja-keys>
</body>
</html>
