<!DOCTYPE html>
{% macro model_select(id, default='haiku', include_gemini=true) -%}
<select id="{{ id }}" class="model-select-inline">
    <option value="claude-haiku-4-5-20251001" {{ 'selected' if default == 'haiku' }}>Haiku</option>
    <option value="claude-sonnet-4-5-20250929" {{ 'selected' if default == 'sonnet' }}>Sonnet</option>
    <option value="claude-opus-4-6" {{ 'selected' if default == 'opus' }}>Opus</option>
    {% if include_gemini -%}
    <option disabled>──────────</option>
    <option value="gemini-2.0-flash">Gemini Flash</option>
    <option value="gemini-2.5-pro">Gemini Pro</option>
    {%- endif %}
</select>
{%- endmacro %}
<html lang="en" data-theme="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <meta name="color-scheme" content="light dark">
    <title>Research Taxonomy Library</title>

    <!-- Fonts: Plus Jakarta Sans (UI) + JetBrains Mono (code) + Material Symbols -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400&family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet">

    <!-- App stylesheet -->
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">

    <!-- ═══════════════════════════════════════════════════════════ -->
    <!-- CDN Stylesheets                                            -->
    <!-- ═══════════════════════════════════════════════════════════ -->

    <!-- Maps: Leaflet + MarkerCluster -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.css" integrity="sha384-b8ANgTJvdlAnWM5YGMpKn7Kodm+1k7NYNG9zdjTCcZcKatzYHwZ0RLdWarbJJVzU" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" integrity="sha384-pmjIAcz2bAn0xukfxADbZIb3t8oRT9Sv0rvO+BR5Csr6Dhqq+nZs59P0pPKQJkEV" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" integrity="sha384-wgw+aLYNQ7dlhK47ZPK7FRACiq7ROZwgFNg0m04avm4CaXS+Z9Y7nMu8yNjBKYC+" crossorigin="anonymous">

    <!-- Data Grid: Tabulator -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tabulator-tables@6.3.1/dist/css/tabulator_simple.min.css" integrity="sha384-V4N7xA98XpwXEziukVT23ibnUCmr8LbIxUQpT4PSUD3yp1TgQyMvrAAelVOuO0C0" crossorigin="anonymous">

    <!-- Tooltips: Tippy.js -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tippy.js@6.3.7/dist/tippy.css" integrity="sha384-IBgYl+I5X6ZDZXI5zv1vsSE3VopDomz4BxSu/GlxaPHfFtcrJ3uj70z1w6srO9zU" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tippy.js@6.3.7/themes/light-border.css" integrity="sha384-oAnSdqFEFRIeYi0SBLHb5HS5ALP/C8FjjBKFAHpjn/9cXWK3iKVrWaxJRz3t9a91" crossorigin="anonymous">

    <!-- Notifications: Notyf -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/notyf@3.10.0/notyf.min.css" integrity="sha384-snpJ3knpH6avB6cP1vPkNdmRzCYaCpom/3TNOyvo189BiogXYXQfXkyYpZ2/xADs" crossorigin="anonymous">

    <!-- UX: Driver.js (product tour) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/driver.js@1.3.1/dist/driver.css" integrity="sha384-eyrYgcjChmzD338JTHFZssgJHOqqOZbajet8yZpCw8ESroLDi28BarMEKCImNGHC" crossorigin="anonymous">

    <!-- UX: Choices.js (enhanced selects) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js@11.0.2/public/assets/styles/choices.min.css" integrity="sha384-n0GACcBzAGKp29zpmkTj4eje26AGm3wqHG9TROENrVHXySIkFf8nwmY5IgVr5qen" crossorigin="anonymous">

    <!-- Tags: Tagify -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@yaireo/tagify@4.31.3/dist/tagify.css" integrity="sha384-Usq5M9GHZHywFmpFNI+e0XtFxuS+JCFQPHBu+EyyIC5vY+WQFbJCYPCaFKSzp+gv" crossorigin="anonymous">

    <!-- Code: Highlight.js theme -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.10.0/styles/github.min.css" integrity="sha384-eFTL69TLRZTkNfYZOLM+G04821K1qZao/4QLJbet1pP4tcF+fdXq/9CdqAbWRl/L" crossorigin="anonymous">

    <!-- Date picker: Flatpickr -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.css" integrity="sha384-RkASv+6KfBMW9eknReJIJ6b3UnjKOKC5bOUaNgIY778NFbQ8MtWq9Lr/khUgqtTt" crossorigin="anonymous">

    <!-- Progress: NProgress -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.css" integrity="sha384-pwTVmaXgbbFRCYPBh1yaHpccJ0KzibGT/RTD3LUT0gjddQ1UkDxcimqlUvZaziZP" crossorigin="anonymous">

    <!-- Diff viewer: diff2html -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/diff2html@3.4.56/bundles/css/diff2html.min.css" integrity="sha384-PdRCG/+r1waybtXfuDB9Kmv2h7AGoN6WaTZ5OF+ctPeR9BGne0FaKRQnUeGV4nDL" crossorigin="anonymous">

    <!-- Review Queue -->
    <link rel="stylesheet" href="/static/css/review.css">
    <link rel="stylesheet" href="/static/css/features.css">
    <link rel="stylesheet" href="/static/css/capture.css">
    <link rel="stylesheet" href="/static/css/lenses.css">
    <link rel="stylesheet" href="/static/css/reports.css">
    <link rel="stylesheet" href="/static/css/monitoring.css">
    <link rel="stylesheet" href="/static/css/insights.css">
    <link rel="stylesheet" href="/static/css/playbooks.css">
    <link rel="stylesheet" href="/static/css/crossproject.css">
    <link rel="stylesheet" href="/static/css/provenance.css">

    <!-- Print styles -->
    <link rel="stylesheet" href="/static/css/print.css" media="print">

    <!-- ═══════════════════════════════════════════════════════════ -->
    <!-- CDN Scripts                                                 -->
    <!-- ═══════════════════════════════════════════════════════════ -->

    <!-- Charts & Viz -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.1/dist/echarts.min.js" defer integrity="sha384-Mx5lkUEQPM1pOJCwFtUICyX45KNojXbkWdYhkKUKsbv391mavbfoAmONbzkgYPzR" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js" defer integrity="sha384-vsrfeLOOY6KuIYKDlmVH5UiBmgIdB1oEf7p01YgWHuqmOHfZr374+odEv96n9tNC" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts-wordcloud@2.1.0/dist/echarts-wordcloud.min.js" defer integrity="sha384-U1KEY0DDCF4Dq6Yx1J+EZ5Hnj8X5bMn52OAcJB8C4OiAWeU4iJhJ/Tv5KhTqu8zZ" crossorigin="anonymous"></script>

    <!-- Graphs: Cytoscape + dagre layout extension -->
    <script src="https://cdn.jsdelivr.net/npm/cytoscape@3.30.4/dist/cytoscape.min.js" defer integrity="sha384-H3uzGzTfGHUAumB8+s4GEdfFwzAceN9wCCndN8AXubWKFIPuBSWKKtWDx7RhSf/z" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/cytoscape-dagre@2.5.0/cytoscape-dagre.js" defer integrity="sha384-u69h9ebXeSjlg6q/rb1zKTRAGu/h8deCl0409xpS/QJctMKnc4M9Fzkm01VOQdeF" crossorigin="anonymous"></script>
    <!-- fcose removed: requires cose-base dependency not available via CDN; code falls back to built-in cose layout -->

    <!-- Canvas: Excalidraw (loaded lazily via dynamic import in canvas.js) -->
    <!-- Non-blocking: loads async, swaps to "all" when ready -->
    <link rel="stylesheet" href="https://esm.sh/@excalidraw/excalidraw@0.18.0/dist/dev/index.css" media="print" onload="this.media='all'" />
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@19.0.0",
            "react/jsx-runtime": "https://esm.sh/react@19.0.0/jsx-runtime",
            "react-dom": "https://esm.sh/react-dom@19.0.0",
            "react-dom/client": "https://esm.sh/react-dom@19.0.0/client"
        }
    }
    </script>

    <!-- Maps: Leaflet + plugins (markercluster, heat, turf) -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.js" defer integrity="sha384-u5N8qJeJOO2iqNjIKTdl6KeKsEikMAmCUBPc6sC6uGpgL34aPJ4VgNhuhumedpEk" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js" defer integrity="sha384-eXVCORTRlv4FUUgS/xmOyr66XBVraen8ATNLMESp92FKXLAMiKkerixTiBvXriZr" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet.heat@0.2.0/dist/leaflet-heat.js" defer integrity="sha384-mFKkGiGvT5vo1fEyGCD3hshDdKmW3wzXW/x+fWriYJArD0R3gawT6lMvLboM22c0" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@7.1.0/turf.min.js" defer integrity="sha384-V2sTNoSKrI8N2u8kNbpZ2kJh54vI+OABRWz1t5/4m+fJuVeIoIkmILoRhQ/XRqrS" crossorigin="anonymous"></script>

    <!-- Data Grid & Search: Tabulator + Fuse.js + MiniSearch -->
    <script src="https://cdn.jsdelivr.net/npm/tabulator-tables@6.3.1/dist/js/tabulator.min.js" defer integrity="sha384-SKSq3cuuVWdfrjtLz9wNlqE0bMc903yMS5zGnFtwvfddplgxa1hywtiLyw1CbSHO" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0/dist/fuse.min.js" defer integrity="sha384-PCSoOZTpbkikBEtd/+uV3WNdc676i9KUf01KOA8CnJotvlx8rRrETbDuwdjqTYvt" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/minisearch@7.1.1/dist/umd/index.min.js" defer integrity="sha384-NaG2onw11DFACpXdRQsBdEloX/dyoVXm8MLdKo0dHSA3SGZU8R7B5IJHI4D0ofwR" crossorigin="anonymous"></script>

    <!-- Export: pdfmake -->
    <script src="https://cdn.jsdelivr.net/npm/pdfmake@0.2.18/build/pdfmake.min.js" defer integrity="sha384-PLaX7k4F4YVdUVAJKxtWURYhFKyvexLM/uv+VrBJPNluuvTrh2meFg4HNi8TDlmN" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/pdfmake@0.2.18/build/vfs_fonts.js" defer integrity="sha384-XVR3gHYz6FEUgHjf/cwpc7D8vspX/UeLi4U9tEAXKA+4cI9XqCxai33WL9TctdbG" crossorigin="anonymous"></script>
    <!-- Export: Excel (xlsx + ExcelJS) -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" defer integrity="sha384-vtjasyidUo0kW94K5MXDXntzOJpQgBKXmE7e2Ga4LG0skTTLeBi97eFAXsqewJjw" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js" defer integrity="sha384-Pqp51FUN2/qzfxZxBCtF0stpc9ONI6MYZpVqmo8m20SoaQCzf+arZvACkLkirlPz" crossorigin="anonymous"></script>
    <!-- Export: JSZip -->
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js" defer integrity="sha384-+mbV2IY1Zk/X1p/nWllGySJSUN8uMs+gUAN10Or95UBH0fpj6GfKgPmgC5EXieXG" crossorigin="anonymous"></script>
    <!-- Export: docx (Word documents) — IIFE bundle (.js extension for correct MIME) -->
    <script src="https://cdn.jsdelivr.net/npm/docx@9.1.1/dist/index.iife.js" defer crossorigin="anonymous"></script>
    <!-- Export: marked (Markdown to HTML) -->
    <script src="https://cdn.jsdelivr.net/npm/marked@15.0.4/marked.min.js" defer integrity="sha384-2NndlFAl0twi2nmu3w9mixodZFiN2fbxlakcYJF86bn1JeS1VB87/XqA7cqymzS+" crossorigin="anonymous"></script>
    <!-- Export: FileSaver.js -->
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js" defer integrity="sha384-PlRSzpewlarQuj5alIadXwjNUX+2eNMKwr0f07ShWYLy8B6TjEbm7ZlcN/ScSbwy" crossorigin="anonymous"></script>
    <!-- Export: html2canvas -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer integrity="sha384-ZZ1pncU3bQe8y31yfZdMFdSpttDoPmOZg2wguVK9almUodir1PghgT0eY7Mrty8H" crossorigin="anonymous"></script>

    <!-- Diagrams: Mermaid -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@11.12.3/dist/mermaid.min.js" defer integrity="sha384-jFhLSLFn4m565eRAS0CDMWubMqOtfZWWbE8kqgGdU+VHbJ3B2G/4X8u+0BM8MtdU" crossorigin="anonymous"></script>

    <!-- Security: DOMPurify -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.2.4/dist/purify.min.js" defer integrity="sha384-eEu5CTj3qGvu9PdJuS+YlkNi7d2XxQROAFYOr59zgObtlcux1ae1Il3u7jvdCSWu" crossorigin="anonymous"></script>

    <!-- Search & Validation: validator.js -->
    <script src="https://cdn.jsdelivr.net/npm/validator@13.12.0/validator.min.js" defer integrity="sha384-G3jMvOhKz+m+LU2WLdby9iZiZ7q9SEy45ltC1BVQg7WdaEwFeaqguod21KLhhUVM" crossorigin="anonymous"></script>

    <!-- Date Formatting: Day.js -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.13/dayjs.min.js" defer integrity="sha384-DpVxUeeBWjUvUV1czyIHJAjh+jYUZFu2lLakbdua5vbwOrBGi1UgaKCHjTC+x3Ky" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.13/plugin/relativeTime.js" defer integrity="sha384-ssUzPQXjLHLO39a9AiuwxnnyDxIvOMUxEQpqfreUaW7jLEdDAXiF6UooZRO53F6Z" crossorigin="anonymous"></script>

    <!-- Tooltips: Popper + Tippy -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" defer integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/tippy.js@6.3.7/dist/tippy-bundle.umd.min.js" defer integrity="sha384-AiTRpehQ7zqeua0Ypfa6Q4ki/ddhczZxrKtiQbTQUlJIhBkTeyoZP9/W/5ulFt29" crossorigin="anonymous"></script>

    <!-- Notifications: Notyf -->
    <script src="https://cdn.jsdelivr.net/npm/notyf@3.10.0/notyf.min.js" defer integrity="sha384-uuNfwJfjOG2ukYi4eAB11/t3lP4Zjf75a3UhgkLzEpiX8JpJfacpG7Ye+0tiVMxT" crossorigin="anonymous"></script>

    <!-- UX: Driver.js (product tour) -->
    <script src="https://cdn.jsdelivr.net/npm/driver.js@1.3.1/dist/driver.js.iife.js" defer integrity="sha384-BhR06AMz62Xn0o53z8itVS1vw4JslNckRFgOTa6/Dob0Agdmbbh8Dr9sDO2h18TO" crossorigin="anonymous"></script>

    <!-- UX: Choices.js (enhanced selects) -->
    <script src="https://cdn.jsdelivr.net/npm/choices.js@11.0.2/public/assets/scripts/choices.min.js" defer integrity="sha384-RW4gs5EBMnvixdJOoWLeT/qJSVHjMQOOwwxMSGVlEzuuuPWm9WVTDYPspqVrYBds" crossorigin="anonymous"></script>

    <!-- UX: Lucide icons -->
    <script src="https://cdn.jsdelivr.net/npm/lucide@0.469.0/dist/umd/lucide.min.js" defer integrity="sha384-hJnF5AwidE18GSWTAGHv3ByzzvfNZ1Tcx5y1UUV3WkauuMCEzBJBMSwSt/PUPXnM" crossorigin="anonymous"></script>

    <!-- UX: ninja-keys (command palette web component — ESM-only) -->
    <!-- Dynamic import so it does NOT block DOMContentLoaded or window.onload -->
    <script>
        import('https://esm.sh/ninja-keys@1.2.2?bundle').catch(function() {
            console.warn('ninja-keys: CDN unavailable');
        });
    </script>

    <!-- UX: SortableJS (drag and drop) -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.6/Sortable.min.js" defer integrity="sha384-HZZ/fukV+9G8gwTNjN7zQDG0Sp7MsZy5DDN6VfY3Be7V9dvQpEpR2jF2HlyFUUjU" crossorigin="anonymous"></script>

    <!-- UX: Floating UI (positioning engine) -->
    <script src="https://cdn.jsdelivr.net/npm/@floating-ui/core@1.6.3/dist/floating-ui.core.umd.min.js" defer integrity="sha384-SJoIIKe0fXtNSiN8+suBrlO3s7ddOATC1q0v9dbaGZN8/tYjo5XmqEYxHpI+jIqY" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@floating-ui/dom@1.6.3/dist/floating-ui.dom.umd.min.js" defer integrity="sha384-rTc0ZbbIMupXXE93GPQiOve/8y8pMmPvlOUT0SloHezzPddhsU3tjC0SX2D9sslf" crossorigin="anonymous"></script>

    <!-- Tags: Tagify -->
    <script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify@4.31.3/dist/tagify.min.js" defer integrity="sha384-324Co8zgQ3kU3YG6V9d0O50pPQ/JcLdIPKDwy+mE1x8RfJx9ZcFtV6HzXSCbMctR" crossorigin="anonymous"></script>

    <!-- Animation: Motion -->
    <script src="https://cdn.jsdelivr.net/npm/motion@11.16.0/dist/motion.js" defer integrity="sha384-YG7y+J5y8spBFifQi8cS5n5YYDVgEhFJv5CYNiA3f2NXeHGfDtJxl3Yp/MBU9Cp8" crossorigin="anonymous"></script>

    <!-- Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js" defer integrity="sha384-Rv68Y7adOjMMJc1/xFMcdNvXre/HF51to4GZjBALmXr7ABnVl5V4UajJwBu7zbhN" crossorigin="anonymous"></script>

    <!-- Keyboard Shortcuts: hotkeys-js -->
    <script src="https://cdn.jsdelivr.net/npm/hotkeys-js@3.13.9/dist/hotkeys.min.js" defer integrity="sha384-53hNeodlih94YLqSA2jxctko3qeoj8OKosYoL8p9uS39KKKz7JneDiLCIK1E8bUY" crossorigin="anonymous"></script>

    <!-- Code Syntax Highlighting (browser build) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/highlight.min.js" defer integrity="sha384-GdEWAbCjn+ghjX0gLx7/N1hyTVmPAjdC2OvoAA0RyNcAOhqwtT8qnbCxWle2+uJX" crossorigin="anonymous"></script>

    <!-- Auto-expanding Textareas -->
    <script src="https://cdn.jsdelivr.net/npm/autosize@6.0.1/dist/autosize.min.js" defer integrity="sha384-Q9KD03bmEL9H3t9KOxcdN2YplobIplv9iv7srJG5fI9U22Pw0uvKgHwtI32TTG3U" crossorigin="anonymous"></script>

    <!-- Click-to-Zoom Images -->
    <script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" defer integrity="sha384-o0gqi06am9fKVfa/jWO8/UE7OxHG6t+fgq/XaASsuwT8OBsFcxN7YhjtqyTfIxtS" crossorigin="anonymous"></script>

    <!-- Date Range Picker: Flatpickr -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js" defer integrity="sha384-5JqMv4L/Xa0hfvtF06qboNdhvuYXUku9ZrhZh3bSk8VXF0A/RuSLHpLsSV9Zqhl6" crossorigin="anonymous"></script>

    <!-- Progress: NProgress -->
    <script src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.js" defer integrity="sha384-Khp+WGU135XsFuEWvnA1WVJNvQ7T6CI9uxs+8RZes7B2JOmM5kjifb3AJ6V3JxY8" crossorigin="anonymous"></script>

    <!-- Diff viewer: diff2html -->
    <script src="https://cdn.jsdelivr.net/npm/diff2html@3.4.56/bundles/js/diff2html.min.js" defer integrity="sha384-X6/ZXflvpFfCMcPkCC2/ydjb6KJqTsoQq2eGjzB5LfWgXs3VsjbfaEKKVWsfQIAy" crossorigin="anonymous"></script>

    <!-- Resizable Panes: Split.js -->
    <script src="https://cdn.jsdelivr.net/npm/split.js@1.6.5/dist/split.min.js" defer integrity="sha384-q2ksSc8z6Q4ZUnxlfZj9AXZLpSdWmD3q/YrId1twTeNHh56fNh98YbJSpppzGUvL" crossorigin="anonymous"></script>

    <!-- Currency formatting -->
    <script src="https://cdn.jsdelivr.net/npm/currency.js@2.0.4/dist/currency.min.js" defer integrity="sha384-rvtOlmtdaQlETnn9WzuLmsk2dRrRmmavPGSnHVDWwXkUkN9ZB+APb+LX/7AVJCIV" crossorigin="anonymous"></script>

    <!-- Search result highlighting: mark.js -->
    <script src="https://cdn.jsdelivr.net/npm/mark.js@8.11.1/dist/mark.min.js" defer integrity="sha384-t9DGTa+HJ3fETmsPZ37+56VRxK0NsOgFTQ1B4fxaxA+BM48rM5oXrg0/ncF/B3VX" crossorigin="anonymous"></script>

    <!-- QR Code generation -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js" defer integrity="sha384-lQXOAyZwHXE55JFyrOMB7nY2Wv+m5ZWNtJcHrd1rceRQXAYNLak8ukN5TjBTcIwz" crossorigin="anonymous"></script>

    <!-- Hand-drawn annotations: Rough Notation -->
    <script src="https://cdn.jsdelivr.net/npm/rough-notation@0.5.1/lib/rough-notation.iife.js" defer integrity="sha384-IW2mAEaBUcGJfuKi7uhlzpZGhnDDnjI9NLtADxl9xKV6VJPzuuIqhIKyLwiAuRmu" crossorigin="anonymous"></script>

    <!-- Pan & zoom for any element -->
    <script src="https://cdn.jsdelivr.net/npm/@panzoom/panzoom@4.5.1/dist/panzoom.min.js" defer integrity="sha384-ZOYffjPUyf23W5DufkQVkrN7uZvIMRRCPo64S2N2S0mFM9+bFZpn2/MQTy2O35gF" crossorigin="anonymous"></script>
</head>
<body>
    <a href="#mainApp" class="skip-link">Skip to main content</a>

    <!-- Connection loss banner -->
    <div id="connectionBanner" class="connection-banner hidden" role="alert">
        <span class="connection-banner-icon"><span class="material-symbols-outlined">warning</span></span>
        <span>Connection lost — retrying...</span>
        <button onclick="location.reload()" class="connection-banner-btn">Reload</button>
    </div>

    <!-- Offline banner -->
    <div id="offlineBanner" class="connection-banner hidden" role="alert">
        <span class="connection-banner-icon"><span class="material-symbols-outlined">wifi_off</span></span>
        <span>You're offline — AI features are disabled. Data browsing still works.</span>
    </div>

    <!-- Update available banner -->
    <div id="updateBanner" class="update-banner hidden" role="status">
        <span class="material-symbols-outlined">system_update</span>
        <span>Update available: <strong id="updateVersion"></strong></span>
        <a id="updateLink" href="#" target="_blank" class="btn btn-sm update-link">Download</a>
        <button class="update-dismiss" onclick="dismissUpdateBanner()" aria-label="Dismiss update banner">&times;</button>
    </div>

    <!-- Keyboard shortcuts overlay -->
    <div id="shortcutsOverlay" class="shortcuts-overlay hidden" onclick="if(event.target===this)toggleShortcutsOverlay()">
        <div class="shortcuts-panel">
            <div class="shortcuts-header">
                <h2>Keyboard Shortcuts</h2>
                <button onclick="toggleShortcutsOverlay()" aria-label="Close shortcuts">&times;</button>
            </div>
            <div class="shortcuts-grid">
                <div class="shortcut-section">
                    <h3>Navigation</h3>
                    <div class="shortcut-row"><kbd>1</kbd>–<kbd>6</kbd> <span>Switch tabs</span></div>
                    <div class="shortcut-row"><kbd>/</kbd> <span>Focus search</span></div>
                    <div class="shortcut-row"><kbd>j</kbd> / <kbd>k</kbd> <span>Navigate rows</span></div>
                    <div class="shortcut-row"><kbd>Enter</kbd> <span>Open selected</span></div>
                    <div class="shortcut-row"><kbd>Esc</kbd> <span>Close panel/modal</span></div>
                </div>
                <div class="shortcut-section">
                    <h3>Actions</h3>
                    <div class="shortcut-row"><kbd>&#8984;K</kbd> <span>Quick search</span></div>
                    <div class="shortcut-row"><kbd>&#8984;E</kbd> <span>Export Excel</span></div>
                    <div class="shortcut-row"><kbd>&#8984;&#8679;P</kbd> <span>Export PDF</span></div>
                    <div class="shortcut-row"><kbd>?</kbd> <span>This overlay</span></div>
                </div>
                <div class="shortcut-section">
                    <h3>Views</h3>
                    <div class="shortcut-row"><kbd>g</kbd> <span>Geographic map (in Map tab)</span></div>
                    <div class="shortcut-row"><kbd>t</kbd> <span>Graph view (in Taxonomy tab)</span></div>
                </div>
            </div>
        </div>
    </div>

    <div class="container" role="main">
        <!-- ========== Project Selection Screen ========== -->
        <div id="projectSelection">
            <header>
                <div class="flex-between">
                    <div>
                        <h1>Research Taxonomy Library</h1>
                        <p class="header-subtitle">Select a research project or create a new one.</p>
                    </div>
                    <div class="flex-gap-sm">
                        <button class="icon-btn" onclick="openAppSettings()" title="Settings" aria-label="App settings"><span class="material-symbols-outlined">settings</span></button>
                        <button class="theme-toggle" onclick="toggleTheme()" title="Toggle dark mode (D)" aria-label="Toggle dark mode"><span class="material-symbols-outlined">dark_mode</span></button>
                    </div>
                </div>
            </header>
            <div id="projectGrid" class="project-grid" role="list" aria-label="Research projects"></div>
        </div>

        <!-- ========== New Project Form ========== -->
        <div id="newProjectForm" class="hidden">
            <header>
                <div class="header-with-back">
                    <button class="back-btn" onclick="showProjectSelection()" aria-label="Back to projects">&larr;</button>
                    <h1>New Research Project</h1>
                </div>
            </header>
            <form onsubmit="createProject(event)">
                <div class="new-project-form">
                    <div class="form-group full-width">
                        <label for="npName">Project Name *</label>
                        <input type="text" id="npName" required placeholder="e.g. Aesthetic Design Connections">
                    </div>
                    <div class="form-group full-width">
                        <label for="npPurpose">Purpose *</label>
                        <textarea id="npPurpose" rows="3" required placeholder="What is this research for? What question are you trying to answer?"></textarea>
                    </div>
                    <div class="form-group full-width">
                        <label for="npOutcome">Expected Outcome</label>
                        <textarea id="npOutcome" rows="2" placeholder="What deliverable will this produce? e.g. FigJam board, market map, report"></textarea>
                    </div>

                    <!-- Schema Template Picker -->
                    <div class="form-group full-width">
                        <label>Research Template</label>
                        <div id="templatePicker" class="template-picker">
                            <!-- Populated by JS -->
                        </div>
                        <input type="hidden" id="npTemplate" value="blank">
                    </div>

                    <!-- Schema Preview -->
                    <div id="schemaPreview" class="schema-preview hidden">
                        <h3 class="section-label">SCHEMA PREVIEW</h3>
                        <div id="schemaPreviewContent"></div>
                    </div>

                    <!-- AI Schema Suggestion -->
                    <div class="form-group full-width">
                        <label>AI Schema Suggestion</label>
                        <p class="form-hint">Describe your research and AI will propose entity types and attributes.</p>
                        <div class="ai-suggest-row">
                            <textarea id="npAiDescription" rows="2" placeholder="e.g. I want to compare pet insurance products across UK providers, focusing on coverage tiers, pricing, and exclusions"></textarea>
                            <button type="button" class="btn" id="aiSuggestBtn" onclick="suggestSchema()">Suggest Schema</button>
                        </div>
                        <div id="aiSuggestStatus" class="hidden"></div>
                    </div>

                    <div class="form-group full-width">
                        <label for="npCategories">Starting Categories *</label>
                        <textarea id="npCategories" rows="3" required placeholder="Enter category names, one per line. These seed the initial taxonomy structure."></textarea>
                    </div>
                    <div class="form-group full-width">
                        <label for="npLinks">Example Links</label>
                        <textarea id="npLinks" rows="4" placeholder="Paste example URLs that represent the type of companies/products you're researching (one per line)"></textarea>
                    </div>
                    <div class="form-group full-width">
                        <label for="npKeywords">Market Keywords</label>
                        <input type="text" id="npKeywords" placeholder="Comma-separated keywords for triage relevance. e.g. design, aesthetic, visual, art, creative">
                    </div>
                    <div class="form-group full-width">
                        <label for="npDescription">Description</label>
                        <textarea id="npDescription" rows="3" placeholder="Any additional context or notes about this research project"></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="primary-btn">Create Project</button>
                        <button type="button" class="btn" onclick="showProjectSelection()">Cancel</button>
                    </div>
                </div>
            </form>
        </div>

        <!-- ========== Main App (shown after project selection) ========== -->
        <div id="mainApp" class="hidden">
            <header>
                <div class="flex-between">
                    <div class="header-with-back">
                        <button class="back-btn" onclick="switchProject()" aria-label="Switch project">&larr;</button>
                        <div>
                            <h1 id="projectTitle">Project</h1>
                            <div class="stats-bar">
                                <span id="statCompanies">0 companies</span>
                                <span id="statCategories">0 categories</span>
                                <span id="statUpdated">Never updated</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex-center-gap">
                        <button class="notification-bell" onclick="toggleNotificationPanel()" title="Notifications" aria-label="Toggle notifications" aria-expanded="false" aria-controls="notificationPanel">
                            <span class="bell-icon" aria-hidden="true"><span class="material-symbols-outlined">notifications</span></span>
                            <span class="bell-badge hidden" id="bellBadge" aria-live="polite">0</span>
                        </button>
                        <button class="theme-toggle" onclick="toggleTheme()" title="Toggle dark mode (D)" aria-label="Toggle dark mode"><span class="material-symbols-outlined">dark_mode</span></button>
                    </div>
                </div>
            </header>

            <!-- Notification Panel -->
            <div id="notificationPanel" class="notification-panel hidden">
                <div class="notif-panel-header">
                    <strong>Recent Activity</strong>
                    <button class="close-btn" onclick="toggleNotificationPanel()" aria-label="Close notifications">&times;</button>
                </div>
                <div id="notifPanelContent" class="notif-panel-content">
                    <p class="hint-text">No recent activity.</p>
                </div>
            </div>

            <nav class="tabs" role="tablist" aria-label="Main navigation">
                <!-- Primary workbench tabs (guided workflow order) -->
                <button class="tab active" role="tab" aria-selected="true" aria-controls="tab-reports" data-tab="reports" onclick="showTab('reports')">Research</button>
                <button class="tab" role="tab" aria-selected="false" aria-controls="tab-process" data-tab="process" onclick="showTab('process')">Process</button>
                <button class="tab" role="tab" aria-selected="false" aria-controls="tab-review" data-tab="review" onclick="showTab('review')">Review</button>
                <button class="tab" role="tab" aria-selected="false" aria-controls="tab-analysis" data-tab="analysis" onclick="showTab('analysis')">Analysis</button>
                <button class="tab" role="tab" aria-selected="false" aria-controls="tab-intelligence" data-tab="intelligence" onclick="showTab('intelligence')">Intelligence</button>
                <button class="tab" role="tab" aria-selected="false" aria-controls="tab-export" data-tab="export" onclick="showTab('export')">Export</button>
                <!-- Hidden tabs -->
                <button class="tab hidden" role="tab" aria-selected="false" aria-controls="tab-discovery" data-tab="discovery" onclick="showTab('discovery')" id="discoveryTabBtn">Discovery</button>
                <!-- Spacer pushes Tools + Settings to right -->
                <div class="tab-spacer" aria-hidden="true"></div>
                <!-- Tools dropdown for legacy tabs -->
                <div class="tools-dropdown" role="none">
                    <button class="tab tools-trigger" id="toolsTrigger" aria-haspopup="true" aria-expanded="false" onclick="toggleToolsDropdown(event)">Tools <span class="tools-caret" aria-hidden="true">&#9662;</span></button>
                    <div class="tools-menu hidden" id="toolsMenu" role="menu" aria-label="Legacy tools">
                        <button class="tools-menu-item" role="menuitem" data-tab="companies" onclick="showTab('companies'); closeToolsDropdown()">Companies</button>
                        <button class="tools-menu-item" role="menuitem" data-tab="taxonomy" onclick="showTab('taxonomy'); closeToolsDropdown()">Taxonomy</button>
                        <button class="tools-menu-item" role="menuitem" data-tab="map" onclick="showTab('map'); closeToolsDropdown()">Map</button>
                        <button class="tools-menu-item" role="menuitem" data-tab="canvas" onclick="showTab('canvas'); closeToolsDropdown()">Canvas</button>
                    </div>
                </div>
                <!-- Settings gear icon -->
                <button class="tab tab-icon" role="tab" aria-selected="false" aria-controls="tab-settings" data-tab="settings" onclick="showTab('settings')" title="Settings" aria-label="Settings"><span class="material-symbols-outlined">settings</span></button>
            </nav>

            <!-- Breadcrumb Navigation -->
            <div id="breadcrumbBar" class="breadcrumb-bar hidden"></div>

            <!-- Companies Tab -->
            <section id="tab-companies" class="tab-content" role="tabpanel" aria-label="Companies">
                <!-- ===== Entity Browser (shown for multi-type schemas) ===== -->
                <div id="entityBrowser" class="hidden">
                    <div class="entity-type-bar" id="entityTypeBar">
                        <!-- Type buttons rendered by entities.js -->
                    </div>
                    <div class="entity-breadcrumbs hidden" id="entityBreadcrumbs"></div>
                    <div class="entity-controls">
                        <input type="text" id="entitySearchInput" placeholder="Search entities... (/)" oninput="debounceEntitySearch()" aria-label="Search entities">
                        <button class="btn" onclick="refineSchema()" title="AI schema refinement">Refine Schema</button>
                        <button class="primary-btn" onclick="openEntityCreateModal()">+ New</button>
                    </div>

                    <div id="entityEmptyState" class="entity-empty-state hidden">
                        <div class="empty-state-title">No entities yet</div>
                        <div class="empty-state-desc">Create your first entity to get started</div>
                        <button class="primary-btn" onclick="openEntityCreateModal()">+ Create</button>
                    </div>

                    <table id="entityTable" class="entity-table">
                        <thead id="entityTableHead"></thead>
                        <tbody id="entityTableBody"></tbody>
                    </table>

                    <!-- Entity Bulk Bar -->
                    <div id="entityBulkBar" class="bulk-action-bar hidden">
                        <span id="entityBulkCount">0 selected</span>
                        <button class="btn" onclick="entityBulkAction('star')">Star</button>
                        <button class="btn" onclick="entityBulkAction('unstar')">Unstar</button>
                        <button class="danger-btn" onclick="entityBulkAction('delete')">Delete</button>
                        <button class="btn" onclick="clearEntityBulkSelection()" aria-label="Clear selection">&times;</button>
                    </div>

                    <!-- Entity Detail Panel -->
                    <div id="entityDetailPanel" class="detail-panel hidden"></div>

                    <!-- Entity Create/Edit Modal -->
                    <div id="entityModal" class="modal-overlay hidden">
                        <div class="modal-content">
                            <h2 id="entityModalTitle"></h2>
                            <div id="entityModalBody"></div>
                        </div>
                    </div>

                    <!-- Schema Refinement Panel -->
                    <div id="schemaRefinePanel" class="refine-panel hidden"></div>
                </div>

                <!-- ===== Company View (original, shown for flat schemas) ===== -->
                <div id="companyViewWrapper">
                <div class="controls">
                    <input type="text" id="searchInput" placeholder="Search companies... (/)" oninput="debounceSearch()" aria-label="Search companies">
                    <select id="categoryFilter" onchange="addFilterFromSelect('category')" aria-label="Filter by category">
                        <option value="">+ Category</option>
                    </select>
                    <select id="tagFilter" onchange="addFilterFromSelect('tag')" aria-label="Filter by tag">
                        <option value="">+ Tag</option>
                    </select>
                    <select id="geoFilter" onchange="addFilterFromSelect('geography')" aria-label="Filter by geography">
                        <option value="">+ Geography</option>
                    </select>
                    <select id="stageFilter" onchange="addFilterFromSelect('funding_stage')" aria-label="Filter by funding stage">
                        <option value="">+ Stage</option>
                    </select>
                    <select id="relationshipFilter" class="filter-select" onchange="loadCompanies()" aria-label="Filter by relationship">
                        <option value="">Relationship</option>
                        <option value="any">Any flagged</option>
                        <option value="watching">Watching</option>
                        <option value="to_reach_out">To Reach Out</option>
                        <option value="in_conversation">In Conversation</option>
                        <option value="met">Met</option>
                        <option value="partner">Partner</option>
                        <option value="not_relevant">Not Relevant</option>
                    </select>
                    <input type="text" id="foundedYearFilter" placeholder="Founded year range..." class="founded-year-filter" readonly aria-label="Filter by founded year">
                    <label class="filter-checkbox"><input type="checkbox" id="starredFilter" onchange="loadCompanies()"> Starred</label>
                    <label class="filter-checkbox"><input type="checkbox" id="enrichmentFilter" onchange="loadCompanies()"> Needs enrichment</label>
                    <button class="filter-action-btn" onclick="openTagManager()" title="Manage tags">Tags</button>
                </div>

                <!-- Active filters as chips -->
                <div id="activeFilters" class="filter-chips-bar hidden"></div>

                <!-- Saved views bar -->
                <div class="saved-views-bar">
                    <select id="savedViewSelect" onchange="loadSavedView()" aria-label="Saved views">
                        <option value="">Saved views...</option>
                    </select>
                    <button class="filter-action-btn" onclick="saveCurrentView()" title="Save current filters">Save view</button>
                </div>

                <div class="company-view-toggle">
                    <button class="view-toggle-btn active" id="viewTableBtn" onclick="switchCompanyView('table')">
                        <span class="material-symbols-outlined icon-16">table_rows</span> Table
                    </button>
                    <button class="view-toggle-btn" id="viewGridBtn" onclick="switchCompanyView('grid')">
                        <span class="material-symbols-outlined icon-16">view_list</span> Grid
                    </button>
                    <button class="view-toggle-btn" id="viewGalleryBtn" onclick="switchCompanyView('gallery')">
                        <span class="material-symbols-outlined icon-16">grid_view</span> Gallery
                    </button>
                    <button class="view-toggle-btn" id="viewTimelineBtn" onclick="switchCompanyView('timeline')">
                        <span class="material-symbols-outlined icon-16">timeline</span> Timeline
                    </button>
                    <button class="view-toggle-btn ml-auto" id="viewExportCsvBtn" onclick="exportTabulatorCsv()" title="Export CSV">
                        <span class="material-symbols-outlined icon-16">download</span> CSV
                    </button>
                </div>

                <div id="companyViewContainer" class="hidden"></div>

                <!-- Tabulator grid view container -->
                <div id="companiesGridContainer" class="hidden"></div>

                <table id="companyTable">
                    <thead>
                        <tr>
                            <th class="bulk-header col-bulk"><input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this)" title="Select all" aria-label="Select all companies"></th>
                            <th class="sort-header col-starred" data-sort="starred"></th>
                            <th class="sort-header" data-sort="name">Name</th>
                            <th class="sort-header" data-sort="category">Category</th>
                            <th>What</th>
                            <th>Target</th>
                            <th class="sort-header" data-sort="geography">Geo</th>
                            <th>Sources</th>
                            <th>Tags</th>
                            <th class="sort-header" data-sort="confidence">Conf.</th>
                        </tr>
                    </thead>
                    <tbody id="companyBody"></tbody>
                </table>

                <!-- Bulk Action Bar -->
                <div id="bulkActionBar" class="bulk-action-bar hidden">
                    <span id="bulkCount">0 selected</span>
                    <button class="btn" onclick="bulkAction('assign_category')"><span class="material-symbols-outlined">category</span> Assign Category</button>
                    <button class="btn" onclick="bulkAction('add_tags')"><span class="material-symbols-outlined">label</span> Add Tags</button>
                    <button class="btn" onclick="bulkAction('set_relationship')"><span class="material-symbols-outlined">handshake</span> Set Relationship</button>
                    <button class="btn" onclick="startBatchEnrichment()"><span class="material-symbols-outlined">auto_fix_high</span> Enrich</button>
                    <button class="danger-btn" onclick="bulkAction('delete')"><span class="material-symbols-outlined">delete</span> Delete</button>
                    <button class="btn" onclick="clearBulkSelection()" aria-label="Clear selection"><span class="material-symbols-outlined">close</span></button>
                </div>

                <!-- Detail Panel -->
                <div id="detailPanel" class="detail-panel hidden">
                    <div class="detail-header">
                        <h2 id="detailName"></h2>
                        <button class="close-btn" onclick="closeDetail()" aria-label="Close detail panel">&times;</button>
                    </div>
                    <div id="detailContent"></div>
                </div>

                <!-- Skeleton loading template for company list -->
                <template id="skeletonCompanyRow">
                  <div class="skeleton-row">
                    <div class="skeleton skeleton-avatar"></div>
                    <div class="skeleton-content">
                      <div class="skeleton skeleton-text medium"></div>
                      <div class="skeleton skeleton-text short"></div>
                    </div>
                  </div>
                </template>

                <template id="skeletonDetail">
                  <div class="skeleton-detail-pad">
                    <div class="skeleton skeleton-text long skeleton-text-title"></div>
                    <div class="skeleton skeleton-text medium"></div>
                    <div class="skeleton skeleton-text long"></div>
                    <div class="skeleton skeleton-text short"></div>
                    <div class="mt-6">
                      <div class="skeleton skeleton-text long"></div>
                      <div class="skeleton skeleton-text medium"></div>
                    </div>
                  </div>
                </template>
                </div><!-- /companyViewWrapper -->
            </section>

            <!-- Taxonomy Tab -->
            <section id="tab-taxonomy" class="tab-content" role="tabpanel" aria-label="Taxonomy">
                <!-- Analytics Dashboard -->
                <div class="analytics-dashboard">
                    <h2 class="collapsible-header" onclick="toggleSection('analyticsSection')" aria-expanded="false" aria-controls="analyticsSection">
                        Analytics Dashboard <span id="analyticsSection-toggle" class="collapse-arrow"><span class="material-symbols-outlined">expand_more</span></span>
                    </h2>
                    <div id="analyticsSection" class="collapsible-body">
                        <!-- Configurable Matrix (full width) -->
                        <div class="chart-card chart-card-wide mb-4">
                            <div class="chart-card-header">
                                <h4 class="chart-title">Company Matrix</h4>
                                <div class="filter-row gap-3">
                                    <div class="filter-row">
                                        <label class="filter-label">Rows:</label>
                                        <select id="matrixRowDimension" onchange="renderCategoryMatrix()" class="matrix-dimension-select">
                                            <option value="category">Category</option>
                                            <option value="funding_stage">Funding Stage</option>
                                            <option value="hq_country">Geography</option>
                                            <option value="business_model">Business Model</option>
                                            <option value="employee_range">Company Size</option>
                                            <option value="tags">Tags</option>
                                        </select>
                                    </div>
                                    <div class="filter-row">
                                        <label class="filter-label">Columns:</label>
                                        <select id="matrixDimension" onchange="renderCategoryMatrix()" class="matrix-dimension-select">
                                            <option value="funding_stage">Funding Stage</option>
                                            <option value="hq_country">Geography</option>
                                            <option value="business_model">Business Model</option>
                                            <option value="employee_range">Company Size</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div id="matrixContainer" class="matrix-container"></div>
                        </div>
                        <div class="chart-grid">
                            <div class="chart-card">
                                <h4>Funding Stage Distribution</h4>
                                <canvas id="chartFundingStage" height="250"></canvas>
                            </div>
                            <div class="chart-card">
                                <h4>Geographic Distribution</h4>
                                <div id="chartGeoDist" class="chart-container"></div>
                            </div>
                            <div class="chart-card">
                                <h4>Confidence Scores</h4>
                                <canvas id="chartConfidence" height="250"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Taxonomy View Toggle -->
                <div class="taxonomy-view-toggle">
                    <button class="view-toggle-btn active" onclick="switchTaxonomyView('tree')" id="treeViewBtn">Tree View</button>
                    <button class="view-toggle-btn" onclick="switchTaxonomyView('graph')" id="graphViewBtn">Graph View</button>
                    <button class="view-toggle-btn" onclick="switchTaxonomyView('knowledge')" id="kgViewBtn">Knowledge Graph</button>
                </div>
                <div id="taxonomyTree"></div>
                <div id="taxonomyGraph" class="hidden graph-container"></div>
                <div id="knowledgeGraph" class="hidden">
                    <div class="kg-filter-panel">
                        <label><input type="checkbox" checked onchange="toggleKgNodeType('category')"> Categories</label>
                        <label><input type="checkbox" checked onchange="toggleKgNodeType('company')"> Companies</label>
                        <label><input type="checkbox" checked onchange="toggleKgNodeType('tag')"> Tags</label>
                        <label><input type="checkbox" checked onchange="toggleKgNodeType('geography')"> Geographies</label>
                    </div>
                    <div id="kgCanvas" class="kg-container"></div>
                </div>

                <div class="review-section">
                    <h2>Taxonomy Review</h2>
                    <p class="hint-text">Run a comprehensive AI review of all categories and company placements. Add your own observations to guide the review.</p>
                    <textarea id="reviewObservations" rows="3" aria-label="Review observations" class="review-textarea" placeholder="Add your observations to guide the review, e.g. 'Extend taxonomy with EAP section', 'Too many companies in Diagnostics', 'Consider splitting Wellness into Physical and Mental'..."></textarea>
                    <div class="flex-gap-sm">
                        {{ model_select('reviewModelSelect') }}
                        <button class="btn" id="reviewBtn" onclick="startTaxonomyReview()">Review Taxonomy with AI</button>
                    </div>
                    <div id="reviewStatus" class="hidden"></div>
                    <div id="reviewResults" class="hidden"></div>
                </div>

                <h2 class="collapsible-header" onclick="toggleSection('qualitySection')" aria-expanded="false" aria-controls="qualitySection">
                    Quality Dashboard <span id="qualitySection-toggle" class="collapse-arrow"><span class="material-symbols-outlined">expand_more</span></span>
                </h2>
                <div id="qualitySection" class="collapsible-body">
                    <div id="qualityDashboard" class="quality-dashboard">
                        <button class="btn" onclick="loadTaxonomyQuality()">Refresh Quality Metrics</button>
                        <div id="qualityContent" class="hidden"></div>
                    </div>
                </div>

                <h2 class="collapsible-header" onclick="toggleSection('historySection')" aria-expanded="false" aria-controls="historySection">
                    Change History <span id="historySection-toggle" class="collapse-arrow"><span class="material-symbols-outlined">expand_more</span></span>
                </h2>
                <div id="historySection" class="collapsible-body">
                    <div id="taxonomyHistory"></div>
                </div>
            </section>

            <!-- Map Tab -->
            <section id="tab-map" class="tab-content" role="tabpanel" aria-label="Map">
                <div class="map-controls">
                    <div class="map-view-toggle">
                        <button class="view-toggle-btn active" onclick="switchMapView('market')" id="marketMapBtn">Market Map</button>
                        <button class="view-toggle-btn" onclick="switchMapView('auto')" id="autoMapBtn">Auto-Layout</button>
                        <button class="view-toggle-btn" onclick="switchMapView('geo')" id="geoMapBtn">Geographic Map</button>
                    </div>
                    <button class="primary-btn" onclick="loadMarketMap()">Refresh Map</button>
                    <button class="btn" onclick="exportMapPng()">Export as PNG</button>
                    <button class="btn" id="heatmapToggleBtn" onclick="toggleGeoHeatmap()" title="Toggle density heatmap on geographic map"><span class="material-symbols-outlined icon-inline">thermostat</span> Heatmap</button>
                    <button class="btn" onclick="startPresentation('map')"><span class="material-symbols-outlined icon-inline">slideshow</span> Present</button>
                    <span class="hint-text hint-inline">Drag companies between categories to reclassify.</span>
                </div>
                <div id="marketMap" class="market-map"></div>
                <div id="autoLayoutMap" class="hidden auto-layout-container"></div>
                <div id="geoMap" class="hidden geo-map-container"></div>

                <!-- Comparison Panel -->
                <div id="compareSection" class="hidden">
                    <div class="compare-header">
                        <h2>Compare Companies</h2>
                        <button class="close-btn" onclick="clearComparison()" aria-label="Close comparison">&times;</button>
                    </div>
                    <div id="compareContent"></div>
                </div>

                <div class="compare-bar hidden" id="compareBar">
                    <span id="compareCount">0 selected</span>
                    <button class="primary-btn" onclick="runComparison()">Compare</button>
                    <button class="btn" onclick="clearCompareSelection()">Clear</button>
                </div>
            </section>

            <!-- Research Tab -->
            <section id="tab-reports" class="tab-content active" role="tabpanel" aria-label="Research">
                <!-- Research mode toggle -->
                <div class="research-mode-toggle">
                    <button class="view-toggle-btn active" id="quickReportModeBtn" onclick="switchResearchMode('report')">Quick Report</button>
                    <button class="view-toggle-btn" id="deepDiveModeBtn" onclick="switchResearchMode('deepdive')">Deep Dive</button>
                    <button class="view-toggle-btn" id="setupModeBtn" onclick="switchResearchMode('setup')">Setup</button>
                </div>

                <!-- Quick Report mode (existing) -->
                <div id="researchModeReport">
                    <div class="market-report-section">
                        <h2>Generate Category Report</h2>
                        <p class="hint-text">Generate AI-powered market analysis for a category. Reports are saved automatically.</p>
                        <div class="report-controls">
                            <select id="reportCategorySelect" aria-label="Report category">
                                <option value="">Select a category...</option>
                            </select>
                            {{ model_select('reportModelSelect', default='sonnet') }}
                            <button class="primary-btn" id="reportBtn" onclick="generateMarketReport()">Generate Report</button>
                        </div>
                        <div id="reportStatus" class="hidden">
                            <div class="progress-bar"><div id="reportProgress" class="progress-fill progress-fill-indeterminate"></div></div>
                            <p>Generating report... AI is researching the web and analyzing your data. This typically takes 2-4 minutes.</p>
                        </div>
                    </div>

                    <div id="reportContent" class="hidden report-viewer"></div>

                    <h2 class="section-heading">Saved Reports</h2>
                    <p class="hint-text">Previously generated reports are stored here.</p>
                    <div id="savedReportsList"></div>
                </div>

                <!-- Deep Dive mode (new) -->
                <div id="researchModeDeepDive" class="hidden">
                    <div class="research-input-section">
                        <h2>Deep Dive Research</h2>
                        <p class="hint-text">Ask any research question. AI will use your project data and web search to produce a comprehensive report.</p>

                        <div class="research-scope-row">
                            <label>Scope:</label>
                            <select id="researchScopeType" onchange="onResearchScopeChange()">
                                <option value="project">Entire Project</option>
                                <option value="category">Category</option>
                                <option value="company">Company</option>
                                <option value="custom">Custom (no context)</option>
                            </select>
                            <select id="researchScopeId" class="hidden">
                                <option value="">Select...</option>
                            </select>
                            <input type="text" id="researchCompanySearch" class="hidden" placeholder="Search company..." oninput="searchResearchCompany()">
                            <div id="researchCompanyResults" class="research-company-dropdown hidden"></div>
                        </div>

                        <div class="research-templates">
                            <span class="hint-text">Templates:</span>
                            <span id="researchTemplateButtons"><!-- loaded dynamically --></span>
                        </div>

                        <div class="research-prompt-row">
                            <textarea id="researchPrompt" rows="4" aria-label="Research question" placeholder="What do you want to research? Be specific for better results..."></textarea>
                        </div>

                        <div class="research-action-row">
                            <input type="text" id="researchTitle" aria-label="Research title" placeholder="Research title (auto-generated if blank)">
                            {{ model_select('researchModelSelect', default='sonnet') }}
                            <button class="primary-btn" id="researchBtn" onclick="startDeepDive()">
                                <span class="material-symbols-outlined">science</span> Start Research
                            </button>
                        </div>

                        <div id="researchStatus" class="hidden">
                            <div class="progress-bar"><div id="researchProgress" class="progress-fill progress-fill-indeterminate"></div></div>
                            <p id="researchStatusText">Researching... AI is searching the web and analyzing data. This may take 2-10 minutes.</p>
                            <button class="btn btn-sm mt-2" onclick="cancelResearchPoll()">Cancel</button>
                        </div>
                    </div>

                    <div id="researchResult" class="hidden report-viewer"></div>

                    <h2 class="section-heading">Saved Research</h2>
                    <p class="hint-text">Previously completed deep dives are stored here.</p>
                    <div id="savedResearchList"></div>
                </div>

                <!-- Project Setup mode -->
                <div id="researchModeSetup" class="hidden">
                    <div id="setupContent">
                        <p class="hint-text">Loading project setup...</p>
                    </div>
                </div>
            </section>

            <!-- Canvas Tab -->
            <section id="tab-canvas" class="tab-content" role="tabpanel" aria-label="Canvas">
                <div class="canvas-toolbar">
                    <div class="canvas-toolbar-left">
                        <select id="canvasSelect" onchange="loadCanvasFromSelect()" aria-label="Select canvas">
                            <option value="">Select canvas...</option>
                        </select>
                        <button class="primary-btn" onclick="createNewCanvas()"><span class="material-symbols-outlined">add</span> New Canvas</button>
                        <button class="btn" id="renameCanvasBtn" onclick="renameCurrentCanvas()" disabled>Rename</button>
                        <button class="btn btn-danger-text" id="deleteCanvasBtn" onclick="deleteCurrentCanvas()" disabled>Delete</button>
                    </div>
                    <div class="canvas-toolbar-right">
                        <button class="btn" id="canvasGenDiagramBtn" onclick="openDiagramPanel()" disabled title="AI-generated diagram">
                            <span class="material-symbols-outlined">auto_awesome</span> AI Diagram
                        </button>
                        <button class="btn" id="canvasExportPngBtn" onclick="exportCanvasPng()" disabled title="Export as PNG">
                            <span class="material-symbols-outlined">image</span> PNG
                        </button>
                        <button class="btn" id="canvasExportSvgBtn" onclick="exportCanvasSvg()" disabled title="Export as SVG">
                            <span class="material-symbols-outlined">picture_as_pdf</span> SVG
                        </button>
                        <button class="btn" id="canvasExportPdfBtn" onclick="exportCanvasPdf()" disabled title="Export as PDF (vector)">
                            <span class="material-symbols-outlined">description</span> PDF
                        </button>
                    </div>
                </div>

                <div class="canvas-workspace">
                    <div class="canvas-sidebar" id="canvasSidebar">
                        <div class="canvas-sidebar-header">
                            <h4>Companies</h4>
                            <input type="text" id="canvasCompanySearch" placeholder="Search..." oninput="filterCanvasCompanies()" aria-label="Search companies for canvas">
                        </div>
                        <div id="canvasCompanyList" class="canvas-company-list"></div>
                    </div>
                    <!-- AI Diagram generation panel (replaces sidebar when open) -->
                    <div class="canvas-sidebar canvas-diagram-panel hidden" id="diagramPanel">
                        <div class="canvas-sidebar-header">
                            <div class="diagram-panel-header">
                                <h4><span class="material-symbols-outlined icon-inline-tight">auto_awesome</span> AI Diagram</h4>
                                <button class="btn btn-sm diagram-close-btn" onclick="closeDiagramPanel()" title="Close">&times;</button>
                            </div>
                        </div>
                        <div class="diagram-panel-body diagram-panel-scroll">
                            <!-- Quick-start templates -->
                            <label class="diagram-label">Quick start:</label>
                            <div class="diagram-templates diagram-templates-list">
                                <button class="btn btn-xs diagram-template-btn" onclick="useDiagramTemplate('market_landscape')" title="Grid of all categories with their companies">
                                    <span class="material-symbols-outlined icon-inline-sm">grid_view</span> Market Landscape
                                </button>
                                <button class="btn btn-xs diagram-template-btn" onclick="useDiagramTemplate('tech_stack')" title="Enterprise architecture stack view">
                                    <span class="material-symbols-outlined icon-inline-sm">stacks</span> Enterprise Tech Stack
                                </button>
                                <button class="btn btn-xs diagram-template-btn" onclick="useDiagramTemplate('value_chain')" title="How categories relate in a value chain">
                                    <span class="material-symbols-outlined icon-inline-sm">conversion_path</span> Value Chain
                                </button>
                                <button class="btn btn-xs diagram-template-btn" onclick="useDiagramTemplate('competitive')" title="Companies sized by funding, grouped by category">
                                    <span class="material-symbols-outlined icon-inline-sm">bubble_chart</span> Competitive Landscape
                                </button>
                                <button class="btn btn-xs diagram-template-btn" onclick="useDiagramTemplate('customer_journey')" title="Map categories to customer journey stages">
                                    <span class="material-symbols-outlined icon-inline-sm">route</span> Customer Journey Map
                                </button>
                            </div>

                            <label class="diagram-label">Describe your diagram:</label>
                            <textarea id="diagramPrompt" rows="3" aria-label="Diagram description" placeholder="Describe the diagram you want, or pick a template above..."></textarea>

                            <label class="diagram-label diagram-label-flex">
                                Categories to include:
                                <span>
                                    <button class="btn btn-xs" onclick="toggleAllDiagramCategories(true)">All</button>
                                    <button class="btn btn-xs" onclick="toggleAllDiagramCategories(false)">None</button>
                                </span>
                            </label>
                            <div id="diagramCategoryList" class="diagram-checkbox-list diagram-checkbox-scroll"></div>

                            <details class="diagram-details">
                                <summary class="diagram-label diagram-summary">Data fields per company</summary>
                                <div id="diagramFieldList" class="diagram-checkbox-list diagram-fields-body">
                                    <label><input type="checkbox" value="name" checked disabled> Name</label>
                                    <label><input type="checkbox" value="what"> What they do</label>
                                    <label><input type="checkbox" value="target"> Target market</label>
                                    <label><input type="checkbox" value="funding_stage"> Funding stage</label>
                                    <label><input type="checkbox" value="total_funding_usd"> Total funding</label>
                                    <label><input type="checkbox" value="employee_range"> Employees</label>
                                    <label><input type="checkbox" value="hq_country"> HQ Country</label>
                                    <label><input type="checkbox" value="business_model"> Business model</label>
                                    <label><input type="checkbox" value="founded_year"> Founded</label>
                                </div>
                            </details>

                            <details class="diagram-details">
                                <summary class="diagram-label diagram-summary">Layout &amp; options</summary>
                                <div class="diagram-fields-body">
                                    <select id="diagramLayoutStyle" class="draw-tool-select full-width-select mb-2">
                                        <option value="grid" selected>Grid</option>
                                        <option value="stacked_vertical">Stacked Vertical</option>
                                        <option value="stacked_horizontal">Stacked Horizontal</option>
                                        <option value="radial">Radial / Hub</option>
                                        <option value="flow">Flow / Pipeline</option>
                                    </select>
                                    <label class="diagram-label diagram-label-inline">
                                        <input type="checkbox" id="diagramClearCanvas" checked> Clear canvas first
                                    </label>
                                </div>
                            </details>

                            <div class="diagram-action-row">
                                {{ model_select('diagramModelSelect', default='sonnet') }}
                                <button class="primary-btn" id="diagramGenBtn" onclick="startDiagramGeneration()">
                                    <span class="material-symbols-outlined icon-inline-tight">auto_awesome</span> Generate
                                </button>
                            </div>

                            <div id="diagramStatus" class="hidden diagram-status">
                                <div class="progress-bar"><div class="progress-fill progress-fill-indeterminate-sm" id="diagramProgressFill"></div></div>
                                <p class="hint-text" id="diagramStatusText">Generating diagram layout...</p>
                                <button class="btn btn-xs mt-1" onclick="cancelDiagramGeneration()">Cancel</button>
                            </div>

                            <div id="diagramError" class="hidden diagram-error"></div>

                            <div id="diagramPostActions" class="hidden diagram-post-actions">
                                <button class="btn btn-sm" onclick="startDiagramGeneration()"><span class="material-symbols-outlined icon-inline-sm">refresh</span> Regenerate</button>
                                <button class="btn btn-sm" onclick="closeDiagramPanel()">Done</button>
                            </div>
                        </div>
                    </div>
                    <div class="canvas-main">
                        <div class="canvas-empty-state" id="canvasEmptyState">
                            <span class="material-symbols-outlined canvas-empty-icon">dashboard</span>
                            <p>Select or create a canvas to start arranging companies visually.</p>
                            <p class="hint-text">Drag companies from the sidebar. Use Excalidraw's built-in tools to draw shapes, lines, and text.</p>
                        </div>
                        <div id="canvasWrapper" class="hidden">
                            <div id="excalidrawRoot"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Process Tab -->
            <section id="tab-process" class="tab-content" role="tabpanel" aria-label="Process">
                <!-- AI Discovery -->
                <div class="ai-discovery-section">
                    <h2>AI Company Discovery</h2>
                    <p class="hint-text">Describe a market segment and AI will search for relevant companies.</p>
                    <div class="discovery-input">
                        <input type="text" id="discoveryQuery" aria-label="Discovery search query" placeholder="e.g. gut microbiome testing companies, digital therapeutics for mental health...">
                        {{ model_select('discoveryModelSelect') }}
                        <button class="primary-btn" id="discoveryBtn" onclick="startDiscovery()">Discover</button>
                    </div>
                    <div id="discoveryResults" class="hidden">
                        <div id="discoveryStatus" class="hidden">
                            <div class="progress-bar"><div id="discoveryProgress" class="progress-fill progress-fill-indeterminate"></div></div>
                            <p>Searching for companies...</p>
                        </div>
                        <div id="discoveryList"></div>
                    </div>
                </div>

                <div class="process-input">
                    <h2>Submit URLs for Processing</h2>
                    <textarea id="urlInput" rows="8" aria-label="URLs to process" placeholder="Paste URLs here (one per line, or mixed with other text)..."></textarea>
                    <div class="process-options">
                        <label>Model: {{ model_select('modelSelect', include_gemini=false) }}</label>
                        <label title="Number of URLs to research simultaneously. Higher = faster but uses more API calls in parallel.">Parallel:
                            <select id="workerCount">
                                <option value="3">3 (conservative)</option>
                                <option value="5" selected>5 (balanced)</option>
                                <option value="8">8 (fast)</option>
                                <option value="10">10 (max speed)</option>
                            </select>
                        </label>
                        <button class="primary-btn" onclick="submitUrls()">Start Processing</button>
                    </div>
                </div>

                <!-- Triage Results -->
                <div id="triageSection" class="hidden">
                    <h2>Pre-Validation Triage <span id="triageStatus" class="triage-status-badge"></span></h2>
                    <p class="triage-info">Links are being checked for accessibility and relevance. Review flagged items below before processing.</p>

                    <div class="progress-bar">
                        <div id="triageProgress" class="progress-fill"></div>
                    </div>
                    <p id="triageProgressText"></p>

                    <div id="triageResults"></div>

                    <div id="triageActions" class="hidden">
                        <div class="triage-action-bar">
                            <span id="triageSummaryText"></span>
                            <button class="primary-btn" onclick="confirmAndProcess()">Confirm &amp; Process</button>
                            <button class="btn" onclick="resetTriage()">Cancel</button>
                        </div>
                    </div>
                </div>

                <!-- Processing Status -->
                <div id="processingStatus" class="hidden">
                    <div class="flex-between-center">
                        <h2>Processing Batch: <span id="batchId"></span></h2>
                        <button class="btn btn-sm" onclick="cancelBatchPolling()" title="Stop watching (batch continues on server)">Cancel Watch</button>
                    </div>
                    <div class="progress-bar">
                        <div id="processProgress" class="progress-fill"></div>
                    </div>
                    <p id="processStatus"></p>
                </div>

                <h2>Recent Batches</h2>
                <p class="hint-text">Click a batch to see full details.</p>
                <div id="batchList"></div>
                <div id="batchDetailView" class="hidden"></div>

                <!-- ═══ Evidence Capture Sub-Section ═══ -->
                <div class="cap-section" id="captureDropTarget">
                    <!-- Drop Zone Overlay -->
                    <div id="captureDropZone" class="cap-drop-zone hidden">
                        <div class="cap-drop-zone-inner">
                            <div class="cap-drop-zone-icon">&#8681;</div>
                            <div class="cap-drop-zone-text">Drop files here to upload as evidence</div>
                        </div>
                    </div>

                    <div class="cap-section-header">
                        <h3>Evidence Capture</h3>
                    </div>
                    <p class="hint-text">Capture website screenshots, download documents, or upload files as evidence for entities. You can also drag &amp; drop files here, or paste screenshots with Ctrl/Cmd+V.</p>

                    <!-- Stats -->
                    <div id="captureStats"></div>

                    <!-- Action Bar -->
                    <div class="cap-action-bar">
                        <button class="primary-btn btn-sm" onclick="captureEntityUrl()">Capture URL</button>
                        <button class="btn btn-sm" onclick="bulkCaptureStart()">Bulk Capture</button>
                        <button class="btn btn-sm" onclick="uploadEvidence()">Upload File</button>
                    </div>

                    <!-- Bulk Progress -->
                    <div id="captureBulkProgress"></div>

                    <!-- Recent Jobs -->
                    <div id="captureJobsList"></div>
                </div>
            </section>

            <!-- Review Tab -->
            <section id="tab-review" class="tab-content" role="tabpanel" aria-label="Review">
                <div class="review-header">
                    <h2>Extraction Review Queue</h2>
                    <p class="hint-text">Review AI-extracted data before it's applied to entities. Accept, edit, or reject each attribute.</p>
                </div>

                <!-- Stats + Confidence Filter -->
                <div id="reviewStats"></div>

                <!-- Bulk Actions -->
                <div class="review-bulk-bar">
                    <button class="primary-btn" onclick="reviewBulkAll('accept')">Accept All High Confidence</button>
                    <button class="btn" onclick="reviewBulkAll('reject')">Reject All</button>
                </div>

                <!-- Queue List (entity cards) -->
                <div id="reviewQueueList"></div>

                <!-- Empty State -->
                <div id="reviewEmptyState" class="review-empty-state hidden">
                    <div class="review-empty-title">No pending extractions</div>
                    <div class="review-empty-desc">Run extraction on entity evidence from the Process tab to populate this queue.</div>
                </div>

                <!-- ═══ Feature Standardisation Sub-Section ═══ -->
                <div class="feat-section">
                    <div class="feat-section-header">
                        <h3>Feature Vocabulary</h3>
                        <div>
                            <button class="btn btn-sm" onclick="mergeFeatures()">Merge</button>
                            <button class="primary-btn btn-sm" onclick="createFeature()">+ New Feature</button>
                        </div>
                    </div>
                    <p class="hint-text">Standardise extracted values into canonical feature names for cross-entity comparison.</p>

                    <!-- Attribute Selector (shown if multiple tags attrs) -->
                    <div id="featureAttrSelector" class="hidden"></div>

                    <!-- Stats -->
                    <div id="featureStats"></div>

                    <!-- Category Filter -->
                    <div id="featureCategoryFilter"></div>

                    <!-- Search + Toolbar -->
                    <div class="feat-toolbar">
                        <input type="text" class="feat-search" placeholder="Search features..."
                               aria-label="Search canonical features"
                               oninput="featureSearchInput(this.value)">
                    </div>

                    <!-- Feature List -->
                    <div id="featureList"></div>

                    <!-- Empty State -->
                    <div id="featureEmptyState" class="feat-empty-state hidden">
                        <div class="feat-empty-title">No canonical features</div>
                        <div class="feat-empty-desc">Create canonical features to standardise extracted vocabulary, or use AI Suggest on unmapped values.</div>
                    </div>

                    <!-- Unmapped Values -->
                    <div id="featureUnmappedList"></div>

                    <!-- AI Suggestions -->
                    <div id="featureSuggestions"></div>
                </div>
            </section>

            <!-- Discovery Tab -->
            <section id="tab-discovery" class="tab-content" role="tabpanel" aria-label="Discovery">
                <div class="discovery-header">
                    <h2>Product Discovery</h2>
                    <p class="discovery-subtitle">Feature landscape analysis, gap identification, and competitive intelligence</p>
                </div>

                <!-- Context Files -->
                <div class="discovery-section">
                    <div class="discovery-section-header" onclick="toggleSection('discoveryContexts')" aria-expanded="false" aria-controls="discoveryContexts">
                        <h3>Context Files</h3>
                        <span id="discoveryContexts-toggle" class="section-arrow">&#9660;</span>
                    </div>
                    <div id="discoveryContexts">
                        <div class="context-upload-area" id="contextDropZone">
                            <p>Drag & drop a markdown/text file here, or</p>
                            <input type="file" id="contextFileInput" accept=".md,.txt,.markdown" class="file-input-hidden">
                            <button class="btn" onclick="document.getElementById('contextFileInput').click()">Choose File</button>
                        </div>
                        <div id="contextsList" class="contexts-list"></div>
                    </div>
                </div>

                <!-- Dimensions -->
                <div class="discovery-section">
                    <div class="discovery-section-header" onclick="toggleSection('discoveryDimensions')" aria-expanded="false" aria-controls="discoveryDimensions">
                        <h3>Research Dimensions</h3>
                        <span id="discoveryDimensions-toggle" class="section-arrow">&#9660;</span>
                    </div>
                    <div id="discoveryDimensions">
                        <div class="dimensions-toolbar">
                            <button class="btn btn-primary" onclick="exploreDimensions()">Explore New Dimensions</button>
                            <button class="btn" onclick="showAddDimensionModal()">Add Manual</button>
                        </div>
                        <div id="dimensionsList" class="dimensions-list"></div>
                        <div id="dimensionExploreResults" class="hidden"></div>
                    </div>
                </div>

                <!-- Feature Landscape -->
                <div class="discovery-section">
                    <div class="discovery-section-header" onclick="toggleSection('discoveryLandscape')" aria-expanded="false" aria-controls="discoveryLandscape">
                        <h3>Feature Landscape</h3>
                        <span id="discoveryLandscape-toggle" class="section-arrow">&#9660;</span>
                    </div>
                    <div id="discoveryLandscape">
                        <div class="landscape-toolbar">
                            <select id="landscapeCategoryFilter" class="model-select-inline">
                                <option value="">All Categories</option>
                            </select>
                            <span class="toolbar-spacer"></span>
                            <span>Model:</span>
                            <select id="landscapeModel" class="model-select-inline">
                                <option value="claude-haiku-4-5-20251001">Haiku</option>
                                <option value="claude-sonnet-4-5-20250929" selected>Sonnet</option>
                                <option value="claude-opus-4-6">Opus</option>
                            </select>
                            <button class="btn btn-primary" onclick="generateFeatureLandscape()">Generate</button>
                        </div>
                        <div id="landscapeResults"></div>
                    </div>
                </div>

                <!-- Gap Analysis -->
                <div class="discovery-section">
                    <div class="discovery-section-header" onclick="toggleSection('discoveryGap')" aria-expanded="false" aria-controls="discoveryGap">
                        <h3>Gap Analysis</h3>
                        <span id="discoveryGap-toggle" class="section-arrow">&#9660;</span>
                    </div>
                    <div id="discoveryGap">
                        <div class="gap-toolbar">
                            <select id="gapContextSelect" class="model-select-inline">
                                <option value="">No context (best-in-class only)</option>
                            </select>
                            <span class="toolbar-spacer"></span>
                            <span>Model:</span>
                            <select id="gapModel" class="model-select-inline">
                                <option value="claude-haiku-4-5-20251001">Haiku</option>
                                <option value="claude-sonnet-4-5-20250929" selected>Sonnet</option>
                                <option value="claude-opus-4-6">Opus</option>
                            </select>
                            <button class="btn btn-primary" onclick="generateGapAnalysis()">Run Analysis</button>
                        </div>
                        <div id="gapResults"></div>
                    </div>
                </div>

                <!-- Past Analyses -->
                <div class="discovery-section">
                    <div class="discovery-section-header" onclick="toggleSection('discoveryHistory')" aria-expanded="false" aria-controls="discoveryHistory">
                        <h3>Analysis History</h3>
                        <span id="discoveryHistory-toggle" class="section-arrow">&#9660;</span>
                    </div>
                    <div id="discoveryHistory">
                        <div id="analysisHistoryList"></div>
                    </div>
                </div>
            </section>

            <!-- Analysis Tab -->
            <section id="tab-analysis" class="tab-content" role="tabpanel" aria-label="Analysis">
                <div class="analysis-header">
                    <h2>Analysis Lenses</h2>
                    <p class="hint-text">Switch between analytical views of your research data. Lenses activate as data becomes available.</p>
                </div>
                <div id="lensSelector" class="lens-selector"></div>
                <div id="lensContent" class="lens-content"></div>
            </section>

            <!-- Intelligence Tab -->
            <section id="tab-intelligence" class="tab-content" role="tabpanel" aria-label="Intelligence">
                <!-- Sub-nav + insights/hypotheses containers injected by insights.js -->
                <!-- Monitoring dashboard (always present, toggled by sub-nav) -->
                <div class="monitoring-dashboard" id="monitoringDashboard">
                    <div class="monitoring-header">
                        <h2>Market Radar</h2>
                        <div class="monitoring-header-actions">
                            <button class="mon-btn" onclick="_checkAllMonitors()">Check All</button>
                        </div>
                    </div>
                    <div class="monitoring-stats" id="monitoringStatsBar"></div>
                    <div id="monitoringFeedSection"></div>
                    <div id="monitoringMonitorsSection"></div>
                </div>
            </section>

            <!-- Export Tab -->
            <section id="tab-export" class="tab-content" role="tabpanel" aria-label="Export">
                <!-- Reports Section -->
                <h2 class="section-heading">Research Reports</h2>
                <p class="hint-text">Generate structured reports from your research data. AI-enhanced reports use Claude to write narratives from your data.</p>
                <div id="reportTemplates" class="report-template-row"></div>
                <div id="reportGenForm" class="report-gen-form hidden"></div>
                <div id="reportViewer" class="report-viewer hidden"></div>
                <div id="reportList"></div>

                <h2 class="section-heading">Quick Export</h2>
                <div class="export-options">
                    <div class="export-card">
                        <h3>JSON</h3>
                        <p>Full structured data for programmatic use</p>
                        <a id="exportJson" href="/api/export/json" class="btn">Download JSON</a>
                    </div>
                    <div class="export-card">
                        <h3>Markdown</h3>
                        <p>LLM-optimized taxonomy for Claude / FigJam</p>
                        <a id="exportMd" href="/api/export/md" class="btn">Download Markdown</a>
                    </div>
                    <div class="export-card">
                        <h3>CSV</h3>
                        <p>Spreadsheet-compatible format</p>
                        <a id="exportCsv" href="/api/export/csv" class="btn">Download CSV</a>
                    </div>
                    <div class="export-card">
                        <h3>Excel (.xlsx)</h3>
                        <p>Formatted workbook with sheets per category</p>
                        <button class="btn" onclick="exportXlsx()">Download Excel</button>
                    </div>
                    <div class="export-card">
                        <h3>PDF Report</h3>
                        <p>Professional PDF with charts and data tables</p>
                        <button class="btn" onclick="exportFullPdf()">Download PDF</button>
                    </div>
                    <div class="export-card">
                        <h3>PDF (Full Report)</h3>
                        <p>Detailed taxonomy report with categories and company table</p>
                        <button class="btn" onclick="exportProjectPdfFromTab()">Download Report PDF</button>
                    </div>
                    <div class="export-card">
                        <h3>Excel (Styled)</h3>
                        <p>Styled workbook with formatted headers and data</p>
                        <button class="btn" onclick="exportProjectExcelFromTab()">Download Styled Excel</button>
                    </div>
                    <div class="export-card">
                        <h3>Word (.docx)</h3>
                        <p>Editable Word document with categories and companies</p>
                        <button class="btn" onclick="exportProjectWordFromTab()">Download Word</button>
                    </div>
                    <div class="export-card">
                        <h3>ZIP Bundle</h3>
                        <p>All formats bundled: JSON, CSV, and more in one download</p>
                        <button class="btn" onclick="exportProjectZipFromTab()">Download ZIP</button>
                    </div>
                </div>

                <h2 class="section-heading">Share Project</h2>
                <div class="share-section">
                    <p class="hint-text">Generate a read-only share link for external stakeholders.</p>
                    <div class="share-controls">
                        <input type="text" id="shareLinkLabel" aria-label="Share link label" placeholder="Link label (e.g. 'For investors')">
                        <button class="primary-btn" onclick="createShareLink()">Generate Link</button>
                    </div>
                    <div id="shareTokensList"></div>
                </div>

                <h2 class="section-heading">Notification Settings</h2>
                <div class="notification-settings">
                    <p class="hint-text">Configure alerts for project events.</p>
                    <div class="notif-field">
                        <label for="slackWebhook">Slack Webhook URL</label>
                        <div class="flex-gap-xs">
                            <input type="url" id="slackWebhook" placeholder="https://hooks.slack.com/services/...">
                            <button class="btn" onclick="testSlack()">Test</button>
                        </div>
                    </div>
                    <div class="notif-checkboxes">
                        <label><input type="checkbox" id="notifBatchComplete" checked> Notify on batch complete</label>
                        <label><input type="checkbox" id="notifTaxonomyChange" checked> Notify on taxonomy changes</label>
                        <label><input type="checkbox" id="notifNewCompany"> Notify on new companies</label>
                    </div>
                    <button class="primary-btn" onclick="saveNotifPrefs()">Save Preferences</button>
                    <div id="notifSaveResult" class="hidden"></div>
                </div>

                <h2 class="section-heading">Import CSV</h2>
                <div class="import-section">
                    <p class="hint-text">Upload a CSV file with columns: name, url, what, target, products, funding, geography, tam, tags, etc.</p>
                    <form id="csvImportForm" onsubmit="importCsv(event)">
                        <input type="file" id="csvFile" accept=".csv" required aria-label="CSV file to import">
                        <button type="submit" class="primary-btn">Import</button>
                    </form>
                    <div id="importResult" class="hidden"></div>
                </div>

                <h2 class="section-heading">Trash</h2>
                <p class="hint-text">Deleted companies can be restored or permanently removed.</p>
                <button class="btn" onclick="loadTrash()">View Trash</button>
                <div id="trashList" class="hidden"></div>

                <h2 class="section-heading">Duplicates</h2>
                <p class="hint-text">Find potential duplicate companies by URL.</p>
                <button class="btn" onclick="findDuplicates()">Scan for Duplicates</button>
                <div id="duplicatesList" class="hidden"></div>

                <h2 class="section-heading">Activity Log</h2>
                <p class="hint-text">Recent project activity and changes.</p>
                <button class="btn" onclick="loadActivity()">Load Activity</button>
                <div id="activityFeed" class="hidden"></div>
            </section>

            <!-- Settings Tab -->
            <section id="tab-settings" class="tab-content" role="tabpanel" aria-label="Settings">
                <h2 class="settings-heading">Settings</h2>
                <p class="hint-text settings-subtitle">Configure AI backends, preferences, and application settings.</p>

                <!-- AI Backend Configuration -->
                <div class="settings-section">
                    <h3 class="section-heading">AI Backends</h3>
                    <p class="hint-text">At least one backend is required for AI features (research, discovery, chat). Status refreshes automatically.</p>
                    <span class="ai-setup-summary ai-setup-summary-block" id="aiSetupSummary"></span>

                    <div class="ai-setup-grid">
                        <!-- Claude API (SDK) -->
                        <div class="ai-setup-card" id="sdkCard">
                            <div class="ai-setup-card-header">
                                <span class="ai-setup-status" id="sdkStatus"></span>
                                <strong>Claude API (SDK)</strong>
                            </div>
                            <p class="hint-text">Direct API access. Fastest and most reliable option.</p>
                            <div class="ai-setup-key-row">
                                <input type="password" id="aiSetupApiKey" placeholder="sk-ant-..." autocomplete="off" spellcheck="false">
                                <button class="btn btn-sm" onclick="saveAiApiKey()">Save Key</button>
                            </div>
                            <div class="ai-setup-key-status" id="apiKeyStatus"></div>
                            <button class="btn btn-sm" onclick="testAiBackend('claude_sdk')" id="testSdkBtn">Test Connection</button>
                            <div class="ai-setup-fix-section" id="sdkFixSection">
                                <div class="fix-header">Setup Instructions</div>
                                <ol class="fix-steps">
                                    <li>Go to <a href="https://console.anthropic.com/settings/keys" target="_blank" rel="noopener">console.anthropic.com/settings/keys</a></li>
                                    <li>Click "Create Key" and copy the key</li>
                                    <li>Paste the key above (starts with <code>sk-ant-</code>)</li>
                                </ol>
                                <p class="fix-note">Requires a paid Anthropic account. Usage is billed per token.</p>
                            </div>
                        </div>

                        <!-- Claude CLI -->
                        <div class="ai-setup-card" id="cliCard">
                            <div class="ai-setup-card-header">
                                <span class="ai-setup-status" id="cliStatus"></span>
                                <strong>Claude CLI</strong>
                            </div>
                            <p class="hint-text">Uses your Claude Pro/Team subscription. Supports web search.</p>
                            <div class="ai-setup-key-status" id="cliPathStatus"></div>
                            <button class="btn btn-sm" onclick="testAiBackend('claude_cli')" id="testCliBtn">Test Connection</button>
                            <div class="ai-setup-fix-section" id="cliFixSection">
                                <div class="fix-header" id="cliFixHeader">Installation</div>
                                <div id="cliFixContent">
                                    <p class="fix-subtitle">Install via npm (requires Node.js):</p>
                                    <div class="fix-command" onclick="copyCommand(this)">
                                        <code>npm install -g @anthropic-ai/claude-code</code>
                                        <span class="material-symbols-outlined fix-copy-icon">content_copy</span>
                                    </div>
                                    <p class="fix-subtitle">Then authenticate:</p>
                                    <div class="fix-command" onclick="copyCommand(this)">
                                        <code>claude login</code>
                                        <span class="material-symbols-outlined fix-copy-icon">content_copy</span>
                                    </div>
                                    <p class="fix-note">Requires a Claude Pro ($20/mo) or Team subscription.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Gemini CLI -->
                        <div class="ai-setup-card" id="geminiCard">
                            <div class="ai-setup-card-header">
                                <span class="ai-setup-status" id="geminiStatus"></span>
                                <strong>Gemini CLI</strong>
                            </div>
                            <p class="hint-text">Google AI alternative. Free tier available.</p>
                            <div class="ai-setup-key-status" id="geminiPathStatus"></div>
                            <button class="btn btn-sm" onclick="testAiBackend('gemini')" id="testGeminiBtn">Test Connection</button>
                            <div class="ai-setup-fix-section" id="geminiFixSection">
                                <div class="fix-header" id="geminiFixHeader">Installation</div>
                                <div id="geminiFixContent">
                                    <p class="fix-subtitle">1. Install Node.js (if not installed):</p>
                                    <div class="fix-command" onclick="copyCommand(this)">
                                        <code>brew install node</code>
                                        <span class="material-symbols-outlined fix-copy-icon">content_copy</span>
                                    </div>
                                    <p class="fix-subtitle">2. Authenticate Gemini CLI:</p>
                                    <div class="fix-command" onclick="copyCommand(this)">
                                        <code>npx @google/gemini-cli</code>
                                        <span class="material-symbols-outlined fix-copy-icon">content_copy</span>
                                    </div>
                                    <p class="fix-note">Run the command above in Terminal and follow the Google sign-in prompts.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Default Model -->
                <div class="settings-section">
                    <h3 class="section-heading">Default Model</h3>
                    <p class="hint-text">Choose which AI model to use by default for research and processing.</p>
                    <div class="settings-row">
                        <label for="defaultModelSetting">Model:</label>
                        {{ model_select('defaultModelSetting') }}
                        <button class="btn btn-sm" onclick="saveDefaultModel()">Save</button>
                        <span id="defaultModelStatus" class="hint-text hint-inline"></span>
                    </div>
                </div>

                <!-- App Info -->
                <div class="settings-section">
                    <h3 class="section-heading">Application</h3>
                    <div class="settings-info-grid">
                        <div class="settings-info-item">
                            <span class="settings-info-label">Version</span>
                            <span class="settings-info-value" id="appVersionDisplay">{{ app_version }}</span>
                        </div>
                        <div class="settings-info-item">
                            <span class="settings-info-label">Database</span>
                            <span class="settings-info-value" id="dbPathDisplay">SQLite (WAL mode)</span>
                        </div>
                        <div class="settings-info-item">
                            <span class="settings-info-label">LLM Backend</span>
                            <span class="settings-info-value" id="llmBackendDisplay"></span>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- AI Chat Widget -->
    <div id="chatWidget" class="chat-widget hidden" role="complementary" aria-label="AI Chat">
        <div class="chat-header" onclick="toggleChat()">
            <span>Ask about your data</span>
            <button class="chat-close" onclick="event.stopPropagation();closeChat()" aria-label="Close chat">&times;</button>
        </div>
        <div class="chat-body" id="chatBody">
            <div class="chat-welcome">Ask questions about your taxonomy data. e.g. "Which companies focus on employer wellness?"</div>
        </div>
        <div class="chat-input-row">
            <input type="text" id="chatInput" placeholder="Ask a question..." onkeydown="if(event.key==='Enter')sendChatMessage()" aria-label="Chat message">
            <button class="primary-btn" onclick="sendChatMessage()">Send</button>
        </div>
    </div>
    <button id="chatToggle" class="chat-fab hidden" onclick="toggleChat()" title="AI Chat" aria-label="AI Chat"><span class="material-symbols-outlined">chat</span></button>
    <button id="tourBtn" class="tour-fab hidden" onclick="startProductTour()" title="Product Tour" aria-label="Product Tour">?</button>

    <!-- Edit Modal -->
    <div id="editModal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="editModalTitle">
        <div class="modal">
            <div class="modal-header">
                <h2 id="editModalTitle">Edit Company</h2>
                <button class="close-btn" onclick="closeEditModal()" aria-label="Close edit modal">&times;</button>
            </div>
            <form id="editForm" onsubmit="saveEdit(event)">
                <input type="hidden" id="editId">
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="editName">Name</label>
                        <input type="text" id="editName" required>
                    </div>
                    <div class="form-group full-width">
                        <label for="editUrl">URL</label>
                        <input type="url" id="editUrl" required>
                    </div>
                    <div class="form-group full-width">
                        <label for="editWhat">What they do</label>
                        <textarea id="editWhat" rows="2"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="editTarget">Target</label>
                        <input type="text" id="editTarget">
                    </div>
                    <div class="form-group">
                        <label for="editGeography">Geography</label>
                        <input type="text" id="editGeography">
                    </div>
                    <div class="form-group full-width">
                        <label for="editProducts">Products</label>
                        <textarea id="editProducts" rows="2"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="editFunding">Funding</label>
                        <input type="text" id="editFunding">
                    </div>
                    <div class="form-group">
                        <label for="editTam">TAM</label>
                        <input type="text" id="editTam">
                    </div>
                    <div class="form-group">
                        <label for="editEmployeeRange">Employee Range</label>
                        <select id="editEmployeeRange">
                            <option value="">-- Select --</option>
                            <option value="1-10">1-10</option>
                            <option value="11-50">11-50</option>
                            <option value="51-200">51-200</option>
                            <option value="201-500">201-500</option>
                            <option value="501-1000">501-1000</option>
                            <option value="1000+">1000+</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editFoundedYear">Founded Year</label>
                        <input type="number" id="editFoundedYear" min="1900" max="2030">
                    </div>
                    <div class="form-group">
                        <label for="editFundingStage">Funding Stage</label>
                        <select id="editFundingStage">
                            <option value="">-- Select --</option>
                            <option value="Pre-Seed">Pre-Seed</option>
                            <option value="Seed">Seed</option>
                            <option value="Series A">Series A</option>
                            <option value="Series B">Series B</option>
                            <option value="Series C+">Series C+</option>
                            <option value="Public">Public</option>
                            <option value="Bootstrapped">Bootstrapped</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editTotalFunding">Total Funding (USD)</label>
                        <input type="number" id="editTotalFunding" min="0" step="1">
                    </div>
                    <div class="form-group">
                        <label for="editHqCity">HQ City</label>
                        <input type="text" id="editHqCity">
                    </div>
                    <div class="form-group">
                        <label for="editHqCountry">HQ Country</label>
                        <input type="text" id="editHqCountry">
                    </div>
                    <div class="form-group full-width">
                        <label for="editLinkedin">LinkedIn URL</label>
                        <input type="url" id="editLinkedin" placeholder="https://linkedin.com/company/...">
                    </div>
                    <div class="form-group">
                        <label for="editCategory">Category</label>
                        <select id="editCategory" onchange="loadSubcategories()">
                            <option value="">-- Select --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editSubcategory">Subcategory</label>
                        <select id="editSubcategory">
                            <option value="">-- Select --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editBusinessModel">Business Model</label>
                        <select id="editBusinessModel">
                            <option value="">-- Select --</option>
                            <option value="B2B">B2B</option>
                            <option value="B2C">B2C</option>
                            <option value="B2B2C">B2B2C</option>
                            <option value="D2C">D2C</option>
                            <option value="Marketplace">Marketplace</option>
                            <option value="Platform">Platform</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editCompanyStage">Company Stage</label>
                        <select id="editCompanyStage">
                            <option value="">-- Select --</option>
                            <option value="Pre-launch">Pre-launch</option>
                            <option value="Early">Early</option>
                            <option value="Growth">Growth</option>
                            <option value="Mature">Mature</option>
                            <option value="Public">Public</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label for="editPrimaryFocus">Primary Focus</label>
                        <input type="text" id="editPrimaryFocus" placeholder="e.g. mental health, diagnostics, telehealth">
                    </div>
                    <div class="form-group full-width">
                        <label for="editTags">Tags (comma-separated)</label>
                        <input type="text" id="editTags" placeholder="e.g. competitor, B2B, wearable">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" onclick="closeEditModal()">Cancel</button>
                    <button type="submit" class="primary-btn">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Tag Management Modal -->
    <div id="tagModal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="tagModalTitle">
        <div class="modal modal-narrow">
            <div class="modal-header">
                <h2 id="tagModalTitle">Manage Tags</h2>
                <button class="close-btn" onclick="closeTagManager()" aria-label="Close tag manager">&times;</button>
            </div>
            <div id="tagManagerContent">
                <div class="tag-manager-actions">
                    <button class="btn" onclick="showTagRenameForm()">Rename Tag</button>
                    <button class="btn" onclick="showTagMergeForm()">Merge Tags</button>
                </div>
                <div id="tagRenameForm" class="tag-action-form hidden">
                    <input type="text" id="tagRenameOld" placeholder="Current tag name">
                    <input type="text" id="tagRenameNew" placeholder="New tag name">
                    <button class="primary-btn" onclick="executeTagRename()">Rename</button>
                    <button class="btn" onclick="hideTagForms()">Cancel</button>
                </div>
                <div id="tagMergeForm" class="tag-action-form hidden">
                    <input type="text" id="tagMergeSource" placeholder="Tag to merge (will be removed)">
                    <input type="text" id="tagMergeTarget" placeholder="Merge into this tag">
                    <button class="primary-btn" onclick="executeTagMerge()">Merge</button>
                    <button class="btn" onclick="hideTagForms()">Cancel</button>
                </div>
                <div id="tagList" class="tag-list"></div>
            </div>
        </div>
    </div>

    <!-- Template Manager Modal -->
    <div id="templateManagerModal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="templateManagerTitle">
        <div class="modal">
            <div class="modal-header">
                <h2 id="templateManagerTitle">Research Templates</h2>
                <button class="close-btn" onclick="closeTemplateManager()" aria-label="Close">&times;</button>
            </div>
            <div id="templateManagerList"></div>
            <div id="templateFormSection" class="hidden template-form-section">
                <h4 id="templateFormTitle">New Template</h4>
                <input type="hidden" id="templateFormId">
                <input type="text" id="templateFormName" placeholder="Template name" class="template-form-field">
                <textarea id="templateFormPrompt" rows="3" placeholder="Prompt template... Use {scope}, {company_name}, {category_name} as variables" class="template-form-field"></textarea>
                <div class="template-form-buttons">
                    <button class="primary-btn" onclick="saveTemplate()">Save</button>
                    <button class="btn" onclick="document.getElementById('templateFormSection').classList.add('hidden')">Cancel</button>
                </div>
            </div>
            <div class="template-add-row">
                <button class="btn" onclick="showAddTemplateForm()">+ Add Template</button>
            </div>
        </div>
    </div>

    <!-- First-Run Onboarding Overlay -->
    <div id="onboardingOverlay" class="onboarding-overlay hidden">
        <div class="onboarding-card">
            <h1>Welcome to Research Taxonomy Library</h1>
            <p>Build market taxonomies — discover, research, classify, and organize companies.</p>
            <div id="onboardingPrereqs" class="onboarding-prereqs"></div>
            <div class="onboarding-actions">
                <button class="primary-btn" onclick="onboardingCreateProject()">Create Your First Project</button>
                <button class="btn" onclick="dismissOnboarding()">Skip</button>
            </div>
        </div>
    </div>

    <!-- App Settings Modal -->
    <div id="appSettingsModal" class="modal-overlay hidden" role="dialog" aria-modal="true">
        <div class="modal modal-wide">
            <div class="modal-header">
                <h2>App Settings</h2>
                <button class="close-btn" onclick="closeAppSettings()" aria-label="Close app settings">&times;</button>
            </div>
            <div class="settings-grid">
                <div class="settings-section">
                    <h3>LLM Configuration</h3>
                    <div class="settings-field">
                        <label for="settingLlmBackend">Backend</label>
                        <select id="settingLlmBackend" class="filter-select">
                            <option value="cli">Claude CLI (subscription)</option>
                            <option value="sdk">Anthropic SDK (API key)</option>
                        </select>
                    </div>
                    <div class="settings-field">
                        <label>API Key</label>
                        <div class="settings-api-key">
                            <span id="settingApiKeyDisplay" class="api-key-display">Not set</span>
                            <input type="password" id="settingApiKeyInput" placeholder="Enter new API key..." class="api-key-input">
                        </div>
                    </div>
                    <div class="settings-field">
                        <label for="settingDefaultModel">Default Model (Processing)</label>
                        <select id="settingDefaultModel" class="filter-select">
                            <option value="claude-haiku-4-5-20251001">Haiku (fast)</option>
                            <option value="claude-sonnet-4-5-20250929">Sonnet (balanced)</option>
                            <option value="claude-opus-4-6">Opus (powerful)</option>
                        </select>
                    </div>
                    <div class="settings-field">
                        <label for="settingResearchModel">Research Model</label>
                        <select id="settingResearchModel" class="filter-select">
                            <option value="claude-sonnet-4-5-20250929">Sonnet (balanced)</option>
                            <option value="claude-opus-4-6">Opus (powerful)</option>
                        </select>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>General</h3>
                    <label class="settings-toggle"><input type="checkbox" id="settingGitSync"> Auto-sync to Git on close</label>
                    <label class="settings-toggle"><input type="checkbox" id="settingAutoBackup"> Daily auto-backup</label>
                    <label class="settings-toggle"><input type="checkbox" id="settingUpdateCheck"> Check for updates on launch</label>
                </div>

                <div class="settings-section">
                    <h3>System Status</h3>
                    <div id="prereqStatus"></div>
                    <div class="settings-info">
                        <span>Version: <strong id="settingVersion"></strong></span>
                        <span>Data: <code id="settingDataDir" class="settings-path"></code></span>
                    </div>
                    <button class="btn btn-sm" onclick="checkForUpdates(false)" class="settings-btn-mt">Check for Updates</button>
                </div>

                <div class="settings-section">
                    <h3>Backup & Restore</h3>
                    <button class="primary-btn btn-sm" onclick="createBackup()" class="settings-btn-mb">Create Backup Now</button>
                    <div id="backupList"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeAppSettings()">Cancel</button>
                <button class="primary-btn" onclick="saveAppSettings()">Save Settings</button>
            </div>
        </div>
    </div>

    <!-- Log Viewer Modal -->
    <div id="logViewerModal" class="modal-overlay hidden" role="dialog" aria-modal="true">
        <div class="modal modal-wide">
            <div class="modal-header">
                <h2>Application Logs</h2>
                <button class="close-btn" onclick="closeLogViewer()" aria-label="Close log viewer">&times;</button>
            </div>
            <div id="logFileList" class="log-file-list"></div>
            <pre id="logContent" class="log-content"></pre>
        </div>
    </div>

    <!-- About dialog -->
    <div id="aboutModal" class="modal hidden" role="dialog" aria-labelledby="aboutTitle" aria-modal="true">
      <div class="modal-content about-modal-content">
        <div class="about-dialog">
          <div class="app-icon about-icon">RT</div>
          <div id="aboutTitle" class="app-name about-name">Research Taxonomy Library</div>
          <div class="app-version about-ver" id="aboutVersion">Version loading...</div>
          <div class="about-content">
            <div>AI-powered market research &amp; taxonomy builder</div>
            <div class="about-tech">Python <span id="aboutPython"></span> / Flask / SQLite</div>
            <div class="about-tech">Claude AI / Gemini AI</div>
          </div>
          <div class="app-copyright">&copy; 2024-2026</div>
          <div class="mt-4">
            <button class="btn btn-secondary about-ok" onclick="closeAboutDialog()">OK</button>
          </div>
        </div>
      </div>
    </div>

    <!-- App JS modules (load order matters: core first, integrations/init last) -->
    <script src="{{ url_for('static', filename='js/core.js') }}"></script>
    <script src="{{ url_for('static', filename='js/projects.js') }}"></script>
    <script src="{{ url_for('static', filename='js/companies.js') }}"></script>
    <script src="{{ url_for('static', filename='js/entities.js') }}"></script>
    <script src="{{ url_for('static', filename='js/taxonomy.js') }}"></script>
    <script src="{{ url_for('static', filename='js/maps.js') }}"></script>
    <script src="{{ url_for('static', filename='js/processing.js') }}"></script>
    <script src="{{ url_for('static', filename='js/filters.js') }}"></script>
    <script src="{{ url_for('static', filename='js/tags.js') }}"></script>
    <script src="{{ url_for('static', filename='js/research.js') }}"></script>
    <script src="{{ url_for('static', filename='js/presentation.js') }}"></script>
    <script src="{{ url_for('static', filename='js/canvas.js') }}"></script>
    <script src="{{ url_for('static', filename='js/diagram.js') }}"></script>
    <script src="{{ url_for('static', filename='js/ai.js') }}"></script>
    <script src="{{ url_for('static', filename='js/export.js') }}"></script>
    <script src="{{ url_for('static', filename='js/settings.js') }}"></script>
    <script src="{{ url_for('static', filename='js/keyboard.js') }}"></script>
    <script src="{{ url_for('static', filename='js/sse.js') }}"></script>
    <script src="{{ url_for('static', filename='js/charts.js') }}"></script>
    <script src="{{ url_for('static', filename='js/app-settings.js') }}"></script>
    <script src="{{ url_for('static', filename='js/integrations.js') }}"></script>
    <script src="{{ url_for('static', filename='js/dimensions.js') }}"></script>
    <script src="{{ url_for('static', filename='js/discovery.js') }}"></script>
    <script src="{{ url_for('static', filename='js/review.js') }}"></script>
    <script src="{{ url_for('static', filename='js/features.js') }}"></script>
    <script src="{{ url_for('static', filename='js/capture.js') }}"></script>
    <script src="{{ url_for('static', filename='js/lenses.js') }}"></script>
    <script src="{{ url_for('static', filename='js/reports.js') }}"></script>
    <script src="{{ url_for('static', filename='js/monitoring.js') }}"></script>
    <script src="{{ url_for('static', filename='js/insights.js') }}"></script>
    <script src="{{ url_for('static', filename='js/playbooks.js') }}"></script>
    <script src="{{ url_for('static', filename='js/crossproject.js') }}"></script>
    <script src="{{ url_for('static', filename='js/provenance.js') }}"></script>
    <script src="{{ url_for('static', filename='js/init.js') }}"></script>

    <script>
      // Prevent pinch-zoom (native apps don't zoom)
      document.addEventListener('wheel', function(e) {
        if (e.ctrlKey) { e.preventDefault(); }
      }, { passive: false });
    </script>

    <!-- Confirmation sheet -->
    <div id="confirmSheet" class="confirm-sheet-overlay" style="display:none;">
      <div class="confirm-sheet">
        <div id="confirmSheetIcon" class="confirm-sheet-icon danger">&#9888;</div>
        <div id="confirmSheetTitle" class="confirm-sheet-title">Are you sure?</div>
        <div id="confirmSheetMessage" class="confirm-sheet-message">This action cannot be undone.</div>
        <div class="confirm-sheet-actions">
          <button id="confirmSheetConfirm" class="confirm-btn-danger">Delete</button>
          <button id="confirmSheetCancel" class="confirm-btn-cancel">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Prompt/input sheet (for pywebview where prompt() is blocked) -->
    <div id="promptSheet" class="confirm-sheet-overlay" style="display:none;">
      <div class="confirm-sheet">
        <div id="promptSheetTitle" class="confirm-sheet-title">Enter a name</div>
        <input id="promptSheetInput" type="text" class="prompt-sheet-input" autocomplete="off" />
        <div class="confirm-sheet-actions confirm-sheet-actions-mt">
          <button id="promptSheetConfirm" class="confirm-btn-primary">Create</button>
          <button id="promptSheetCancel" class="confirm-btn-cancel">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Command palette (ninja-keys web component) -->
    <ninja-keys id="commandPalette" placeholder="Type a command..." hideBreadcrumbs></ninja-keys>
</body>
</html>
